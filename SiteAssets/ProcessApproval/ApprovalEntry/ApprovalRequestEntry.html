<!DOCTYPE html>
<html lang="en" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">

<head>
	<title>New Request Entry</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css"href="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/NewEntryAssets/font-awesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/SignatureLinks/flashcanvas.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/js/jquery.richtext.js"></script>
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/css/richtext.min.css">
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.js" integrity="sha512-lOtDAY9KMT1WH9Fx6JSuZLHxjC8wmIBxsNFL6gJPaG7sLIVoSO9yCraWOwqLLX+txsOw0h2cHvcUJlJPvMlotw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/ApprovalEntry/jSignature.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/ApprovalEntry/DigitalSignature.js"></script>
	


	<!-- <meta charset="utf-8"> -->
	<!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
	<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"> -->
	<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script> -->
	<!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script> -->

	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/NewEntryAssets/css/padding.css">
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/NewEntryAssets/css/styles.css">
<!--	<link href='https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/ui-lightness/jquery-ui.css' rel='stylesheet'> -->
	<link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.3/moment.min.js" ></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/js/dom-to-image.js"></script>
	
	<script type="text/javascript" src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>


	<style>

@font-face{
  font-family:'Caveat-VariableFont_wght';
  src:url(https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/NewEntryAssets/fonts/Caveat-VariableFont_wght.ttf);
}
.color-red
{
	color:red;
}
#s4-bodyContainer{
 min-height: calc( 100vh - 38px ) !important;	
}
	#rever_multistep table {
    border-collapse: initial;
    border: 1px solid #ccc;
    border-top: 2px solid transparent;
}

#rever_multistep .table>tbody>tr>td{
 padding:5px;
}


#rever_multistep .table>tbody>tr>td:nth-child(1),
#rever_multistep .table>tbody>tr>td:nth-child(2){
  text-align: center;
}


.actionsboxs{
display: -webkit-box;
display: -moz-box;
display: -webkit-flex;
display: -ms-flexbox;
display: flex;

-webkit-align-items: flex-start;
-ms-flex-align: flex-start;
align-items:flex-start;

justify-content: space-between;
-webkit-box-pack: justify;
-webkit-justify-content: space-between;
-ms-flex-pack: justify;
justify-content: space-between;

}


#rever_multistep .table>tbody>tr:nth-child(2n+1)>td {
    background: #f5f5f5;
}

#rever_multistep .table>thead>tr>th {
    border-bottom: 1px solid #ccc !important;
    position: sticky;
    top: 0;
    background: #fff;
    border-top: 1px solid #ccc;
}

input[name="revertoption"]{
  width:17px;
  height:17px;
  cursor: pointer;
}

#rever_multistep .table>tbody>tr>td input[type="checkbox"]{
  width:17px;
  height:17px;
}

#rever_multistep .table>tbody>tr>td a[data-toggle="collapse"]{
  color:#333;
  font-size:22px;
  padding:3px 10px;
}

#rever_multistep .modal-dialog{
 margin-top:2px !important;
 margin-bottom:2px !important;	
}

.action_areaset{
 display: -webkit-box;
 display: -moz-box;
 display: -webkit-flex;
 display: -ms-flexbox;
 display: flex;	
-webkit-box-align: center;
-webkit-align-items: center;
-ms-flex-align: center;
align-items: center;

}
.actionsboxs label {
    margin-right: 5px;
}

.Stakeholder_flx {
    display: -webkit-box;
    display: -webkit-flex;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-align: center;
    -webkit-align-items: center;
    -ms-flex-align: center;
    align-items: center;
    padding: 5px;
    border-radius: 4px;
    position: relative;
    margin-bottom: 5px;
    min-height: 68px;
    margin-bottom: 10px;
    transition: 0.3s;
    /* box-shadow: 1px 1px 5px #d1d1d1; */
    border: 1px solid #eee;
}

.Stakeholder_flx img {
    width: 35px;
    height: 35px;
    border: 2px solid #c1c1c1;
    box-shadow: 0px 1px 4px #afadad;
    border-radius: 50%;
    min-width:35px;
    margin-right: 5px;
}

.Stakeholder_detail h3 {
    font-size: 13px;
    margin: 0;
    padding: 0;
    width: 155px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    display: block;
    font-weight: 600;
    color: rgba(0,0,0,0.8);
}

.Stakeholder_detail a {
    color: #1d6ec0;
    text-decoration: none;
    width: 164px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: block;
    font-size: 12px;
    margin-top: 3px;
}

.actionsboxs{
  font-size:13px;
  margin:10px 0;
}

.no-gutter{
  margin-left: -5px;
  margin-right: 5px;
}

.no-gutter div[class^="col-"]{
 padding-left: 5px;
 padding-right: 5px;
}

.scrollingbox_define {
    overflow: auto;
    padding: 0 5px;
    max-height: 446px;
}

.scrollingbox_define::-webkit-scrollbar-thumb {
border: 2px solid transparent;
border-radius: 10px;
background-color: #666;
background-clip: content-box;
-webkit-background-clip: content-box;

}


.scrollingbox_define::-webkit-scrollbar-thumb:hover {
background-color: #666;;
background-clip: border-box;
-webkit-background-clip: border-box;

}

.scrollingbox_define::-webkit-scrollbar {
width: 8px;
height: 8px;
background-color: transparent;
}

.stpname{
  font-size:15px;
}

.panel-title-box> span {
    transition: all 0.5s;
}

.panel-title-box[aria-expanded="true"]> span {
    transform: rotate(180deg);
}

.skipbox_set{

min-width: 120px;
color: #1b7de5;
border:1px solid #b4b4b4b0;
padding: 5px 10px;
border-radius: 5px;
background: #fff;
transition:0.3s;  
}

.skipbox_set:hover{
 background:#f0efef8f;
}

@media(max-width:767px){

.actionsboxs{
-webkit-flex-wrap: wrap;
-ms-flex-wrap: wrap;
flex-wrap: wrap;
}

.skipbox_set{
margin-top:10px;
}

.btngroupsetting.text-center{
 text-align:left !important;	
}

.btngroupsetting.text-center a[type="button"]{
  margin-bottom:4px;	
}

}


/***7-13**/
.hidden_sec{
  position: relative;
}
.hidden_sec label input[type="radio"]{
  display: none;
}

.hidden_sec label input[type="radio"]:checked + img{

}

.hidden_sec label img{
  width:26px;
  cursor: pointer;
}
	
		thead{
			background-color: #00448bba;
            color: #ffff;
		}
		.panel-head-text {
			font-size: 16px !important;
		}
		.setmargin{
			margin-bottom: 30px !important;
			float: right;
		    margin-right: 0px;
		    font-size: 12px !important;
		    padding: 4px 2px;
		    border-radius: 15px !important;
		    margin-top: 4px;
		    background: #4576aa;
		}
		.setmargin:hover,
		.setmargin:active{
			background:#ffffff !important;
			color:#4576aa !important;
			border-color:#4576aa !important;
			box-shadow:none !important;
		}
		.setmargin:focus{
			box-shadow: none;
    		color: #fff;
		}
		.modal-header .close-round {
			min-width: 1em !important;
		}

		.topsec h3,		.topsec button {
			display: inline-block;
		}

		.topsec h3 {
			margin: 0;
			padding: 0;
			font-size: 14px;
			font-weight: 600;
			color: #333;
		}

		.stepingbox {
			border: 1px solid #ccc;
			border-radius: 3px;
			max-height: 400px;
			overflow: auto;
		}

		.stepingbox::-webkit-scrollbar-thumb {
			background: #333333eb;
			border: 2px solid transparent;
			background-clip: content-box;
			-webkit-background-clip: content-box;
			border-radius: 5px;
		}

		.stepingbox::-webkit-scrollbar-thumb:hover {
			background-clip: border-box;
			-webkit-background-clip: border-box;
		}

		.stepingbox::-webkit-scrollbar {
			width: 9px;
			height: 9px;

		}

		.stepbox>li {
			padding: 10px;
			border: 1px solid #cccccc9e;
			border-radius: 3px;
			margin-bottom: 15px;
		}

		.stepbox>li:last-child {

			margin-bottom: 0;

		}

		.topsec button {
			float: right;
			background: transparent;
			border: none;
			outline: none;
			opacity: 0;
			transition: 0.5s;
			width: 23px;
			height: 23px;
			background: #fff;
			border-radius: 50%;
			box-shadow: 1px 1px 5px #aeaeae;
			display: block;
			text-align: center;
			padding: 0;
			line-height: 1.5;
			min-width: auto !important;
			transition: 0.5s;
		}


		.stepbox>li:hover .topsec button {

			opacity: 1;

		}

		.imagecontent {
			padding: 0 10px;
		}

		.topsec {
			margin-bottom: 10px;
		}

		.topsec button.dropdown-toggle::after {

			display: none;

		}

		.stepbox {
			margin: 0;
			padding: 0;
			list-style: none;
			padding: 15px;
		}


		.flexitem {
			display: -webkit-box;
			display: -moz-box;
			display: -webkit-flex;
			display: -ms-flexbox;
			display: flex;
			-webkit-box-align: center;
			-webkit-align-items: center;
			-ms-flex-align: center;
			align-items: center;
		}

		.imagecontent h4 {
			font-size: 13px;
			margin: 0 0 3px 0;
			padding: 0;
			color: #333;
		}

		.imagecontent a {
			font-size: 12px;
			color: #1d6ec0;
			text-decoration: none;
			word-wrap: break-word;
			word-break: break-word;
			word-break: break-all;
		}

		.imgsetion img {
			width: 35px;
			border-radius: 50%;
			height: 35px;
		}

		@media(min-width:991px) {

			#stepsapprover .modal-dialog {
				max-width: 680px;
			}

		}
		hr{
			border: 1px solid #1d6ec0;
			margin-top:0px;margin-bottom:0px;
		}
		.colorsetdyn{
			font-weight: 900;
			color: #1d6ec0;
			/*text-transform: uppercase;*/
            font-size: 17px;
		}
		select.input-sm{
		height:34px; 		
		}
		select,textarea{
		border:1px solid #c3c3c3 !important;
		}
		.table-action-button-grpup .btn{
			height: 30px;
			width: 30px;
			line-height: 26px;
			text-align: center;
			border-radius: 50% !important;
			border: 0;
			padding: 0;
			transition: all 0.3s;
			background-color: #e7e7e7;
			color: #1d6ec0;
			min-width:auto;
		}
		.table-action-button-grpup .btn:active{
			box-shadow: none;
		}
		.table-action-button-grpup .btn+.btn{
			margin-left:4px;
		}
		.table-action-button-grpup .btn:hover{
			background-color: #cccccc;
		}
		.table thead tr th:last-child{
			text-align:center;
		}
		
		/* new css added on 06/1/2022 */

.drag-drop-box .drop-container {
    height: 122px;
    padding: 0px 0px;
}
.drag-drop-box .drop-container #clickHere {
    margin-top: 25px;
}
.drag-drop-box .drop-container input#file {
    height: 100%;
}
.approval_image_preview {
    /*float: left;*/
    width: auto;
    height: 96px;
    display: none;
}
.approval_image_preview img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    object-position: left;
    padding: 2px;
}
#SignatureBox label.radio-inline input[type=radio] {
    margin-top: 2px;
}

/* new css added on 12/1/2022 */

.drag-drop-box .drop-container {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2px;
}
.drop-container .custom-image-label {
    font-size: 12px;
    margin-top: 0px !important;
}
.draw-signature-box-draw-clear-btn, .draw-signature-box-type-clear-btn, .draw-signature-box-image-clear-btn {
    position: absolute;
    top: 0px;
    right: -2px;
    transform: translate(0px, -25px);
    border-radius: 16px !important;
    transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out, -webkit-box-shadow 0.15s ease-in-out;
    font-size: 11px !important;
    padding: 1px 3px;
    width: 47px !important;
}
.signature-box #SingTextType {
    border-top: none !important;
    border-left: none !important;
    border-right: none !important;
    border-bottom: 1px solid #a6a6a6 !important;
}

#TemplatedBinding1.new-request-action-panel{
  max-height: 380px !important;	
  padding-left:0px;
}

button.close{
  background:#fff;	
}

#Rejectrequest.btn-danger{
 padding-left:20px;
 padding-right:20px;
}

#Rejectrequest.btn-danger:hover,
#Rejectrequest.btn-danger:focus{

 background:transparent;
 color:#d43f3a;
	
}

/******revert popup css******/
  
.hideboxs{
  display: none;
}

.revertheading{
 margin: 0;
padding: 0;
margin-bottom: 12px;
font-size: 18px;
}

.hideboxs.activing{
  display: block;
}

.muti_dropbox{
  margin:0;
  margin-bottom:12px;
  padding:0;
  list-style-type: none;
}

.muti_dropbox li {
  margin-bottom: 12px;
  margin-left: 15px;
  display: block;
}

.muti_dropbox li>label{
  display:inline-block;
}

.muti_dropbox label,
.muti_dropbox input[type="radio"]{
  margin:0;
  padding:0;
  cursor: pointer;
}
.muti_dropbox label {
    font-size: 16px;
    color: #333;
    font-weight: 400;
    margin-left: 3px;
    cursor: pointer;
}

.muti_dropbox input[type="radio"] {
    width: 15px;
    height: 15px;
    position: relative;
    top:0px;
}
.muti_dropbox input[type="radio"]:checked ~ label {
    color: #1d6ec0;
    display:inline-block;
}
.hideboxs{
    margin-left: 20px;
    padding: 15px;
    border: 1px solid #e9e9e9;
    margin-top: 10px;
    margin-bottom: 20px;
    border-left: 2px solid #1d6ec0;
    box-shadow: 1px 1px 5px #d9d9d9;
    border-radius: 0 5px 5px 0;
    width: 96%;
    overflow: auto;
    max-height: 266px;
}

.hideboxs::-webkit-scrollbar-thumb {
border: 2px solid transparent;
border-radius: 10px;
background-color: #666;
background-clip: content-box;
-webkit-background-clip: content-box;

}


.hideboxs::-webkit-scrollbar-thumb:hover {
background-color: #666;;
background-clip: border-box;
-webkit-background-clip: border-box;

}

.hideboxs::-webkit-scrollbar {
width: 8px;
height: 8px;
background-color: transparent;
}

.employeelisting {
    display: -webkit-box;
    display: -webkit-flex;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-align: center;
    -webkit-align-items: center;
    -ms-flex-align: center;
    align-items: center;
    padding: 5px;
    border-radius: 4px;
    position: relative;
    background-color: #fff;
    margin-bottom: 5px;
    min-height: 68px;
    box-shadow: 0px 0px 4px #ddd;
    margin-bottom: 10px;
    border: 1px solid #dfdfdf;
    transition:0.3s;
}
.employeelisting:hover{
    border: 1px solid #b6dbff;
    background: #1d6ec00d;
}

.employeelisting .crosebox{
  position: absolute;
    width: 18px;
    display: block;
    height: 18px;
    top: 10px;
    right: 6px;
    background: #fff;
    border-radius: 50%;
    color: #000;
    text-align: center;
    line-height: 18px;
    cursor: pointer;
    opacity: 0;
    transition: 0.3s;
    box-shadow: 1px 0px 5px #00000073;
}

.employeelisting:hover .crosebox {
    opacity: 1;
} 

.employeelisting .empoyeeimg img {
    width: 40px;
    height: 40px;
    border: 2px solid #c1c1c1;
    box-shadow: 0px 1px 4px #afadad;
    border-radius: 50%;
}

.employeelisting .employeeinfo{
  padding:0 10px;
}

.employeelisting .employeeinfo a{
  color:#1d6ec0;
  text-decoration: none;
  width:176px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
   display: block;
}


.employeeinfo h3 {
    font-size: 13px;
    margin: 0;
    padding: 0;
    width: 176px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    display: block;
    font-weight: 600;
    color: rgba(0,0,0,0.8);
}

.no-gutter{
  margin-left: -5px;
  margin-right: 5px;
}

.no-gutter div[class^="col-"]{
 padding-left: 5px;
 padding-right: 5px;
}

@media(max-width: 550px){

.hideboxs {
    margin-left: 0px;
    padding: 5px;
    width:100%;
}
.employeelisting .employeeinfo a {
    width: 170px;
}

.muti_dropbox li {
  margin-left: 0px;
}

#revertstepsec .modal-body{
  padding:10px !important;	
}

}

/******revert popup css******/

.richText-editor{
	height: 98px !important;
}

#Docfilename{
 height:auto !important;	
}

/***june-29-22****/
.ui-tooltip{
 background:#333 !important;
 color:#fff !important;
 box-shadow:none !important;
 border:none !important;	

}

.preup_load{
  width:0;
  padding:0px;
  border:1px solid #ccc;
  position:relative;
  opacity:0;
  display:none;
  transition:0.5s ease;
}

.preup_load ul{
	max-height:120px;
	min-height:120px;
	overflow:auto;
}

.preup_load ul::-webkit-scrollbar-thumb {
border: 1px solid transparent;
border-radius: 5px;
background-color: #666;
background-clip: content-box;
-webkit-background-clip: content-box;

}

.preup_load ul::-webkit-scrollbar-thumb:hover {
background-color: #666;;
background-clip: border-box;
-webkit-background-clip: border-box;

}

.preup_load ul::-webkit-scrollbar {
width: 5px;
height: 5px;
background-color: transparent;
}

.preup_load.ative_now {
    min-width: 130px;
    opacity: 1;
    margin-left: 8px;
    max-width: 130px;
    display:block;
}


.preup_load ul{
 margin:0;
 padding:0;
 list-style-type: none;  
}

.preup_load ul li{
 border-bottom:1px solid #ccc;
 width:100%;
 height:57px;
display: -webkit-box;
display: -moz-box;
display: -webkit-flex;
display: -ms-flexbox;
display: flex;
-webkit-align-items: center;
-ms-flex-align: center;
align-items: center;
padding:5px;
background-color:#fff;

}

.preup_load ul li:last-child{
 border-bottom:none;	
}

.preup_load ul li img{
  width:100%;
  height:57px;
  object-fit: cover;
}

.preup_load .preload_img {
    position: absolute;
    bottom:0px;
    width: 18px;
    min-width: 18px;
    height: 18px;
    right: -18px;
    padding: 0;
    border-radius: 0 50% 50% 0;
    background: #eee;
    color: #545151;
    font-size: 11px;
}

.flexingboxs{
 display: -webkit-box;
display: -moz-box;
display: -webkit-flex;
display: -ms-flexbox;
display: flex;
margin-top:15px;	
}

#drop-zone .preload_img {
    position: absolute;
    bottom: 5px;
    right: 5px;
    z-index: 20;
    padding: 0;
    min-width: auto !important;
    border: none;
    opacity:0.8;
}

#drop-zone .preload_img:hover,
#drop-zone .preload_img:focus{
  background:transparent !important;	
}

#drop-zone .preload_img img{
 width:30px !important;	
}

.tooltip{
 background:#333;
 padding:2px;
 color:rgba(255,255,255,0.8);	
}

.boxhere{
  display: none;
}
.boxhere.active_show{
 display:block;
}

#ReturnStakeholderList{
 padding:2px 5px;
 min-height:34px;
 height:auto;
 	
}

#ReturnStakeholderList .sp-peoplepicker-topLevel,
#ReturnStakeholderList .sp-peoplepicker-editorInput{
 max-width:100% !important;
 width:100% !important;
 border:none !Important;	
}

@media(max-width:500px){
	
.flexingboxs{
-webkit-flex-wrap: wrap;
-ms-flex-wrap: wrap;
flex-wrap: wrap;	
}	

.preup_load.ative_now {
    min-width: 98%;
    opacity: 1;
    margin-left: 8px;
    max-width: 98%;
    margin-top:10px;
}

.preup_load ul li{
 height:100px;
 justify-content: center;
 -webkit-justify-content: center;
	
}
	
.preup_load ul li img {
    width: 80%;
    object-fit: cover;
    height: 100%;
}
	
}


<!-- table with 50-->
.fifty_centent .wrapping_dynamic {
    width: 100%;
    max-height: 200px;
   
}

.fifty_centent .wrapping_dynamic > table{

  width:100%;

}

fifty_centent .wrapping_dynamic.only_heading table tr th {
    white-space: nowrap;
    min-height: 32px;
    white-space: nowrap;
    overflow: hidden;
    overflow-text: ellipse;
    text-overflow: ellipsis;
    max-width: 100px;
}




/*************popup setting start***********************/


.wrapfildsinside{
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
   align-items:center;
  -webkit-box-align: center;
  -webkit-align-items: center;
  -ms-flex-align: center; 
} 

.wrapfildsinside.mangflexlabel{
  align-items:flex-start;
  -webkit-box-align:flex-start;
  -webkit-align-items:flex-start;
  -ms-flex-align:flex-start;	
} 

.wrapfildsinside{
  margin-bottom:19px;
}


.wrapfildsinside>label {
    width: 125px;
    min-width: 125px;
    font-size: 13px;
    font-weight: 400;
    margin: 0;
}

.fieldbx{
 width:calc(100% - 125px);
 min-width:calc(100% - 125px); 
}

.fieldbx.flexing_both{
  display: -webkit-box;
display: -webkit-flex;
display: -ms-flexbox;
display: flex;
}

.fieldbx.flexing_both input[type="checkbox"]{
 margin-right:6px;	
}

.fullwidth_dropdown{
  width:100%;
  text-align:right;
}

.fullwidth_dropdown button {
    width: calc(100% - 21px);
    background-color: #fff;
    border: 1px solid #ccc;
    text-align: left;
    color: #676767 !important;
    padding-right: 5px;
    margin-right: 0;
    border-radius: 5px !important;
}

.fullwidth_dropdown button:hover,
.fullwidth_dropdown button:focus{
   border: 1px solid #ccc;
   outline:none !important;
   box-shadow:none !important; 
}

.fullwidth_dropdown button .fa-angle-down{
    font-size: 16px;
    font-weight: 600;
}

.fullwidth_dropdown .dropdown-menu{
  width:100%;
  padding:5px 0;
}

.fullwidth_dropdown .dropdown-menu li {
    font-size: 13px;
    color: #333;
    padding: 5px 10px;
    border-bottom: 1px solid #e1e1e1;
    transition:0.2s;
}

.fullwidth_dropdown .dropdown-menu li:hover{
  background: #eee;
}

.fullwidth_dropdown .dropdown-menu li input[type="checkbox"] {
    width: 17px;
    height: 17px;
    margin-right: 10px;
    margin-top: 0;
    position: relative;
    top: 4px;
}

.hideboxarea{
  display:none;
}

.hideboxarea.active{
 display: -webkit-box;
 display: -webkit-flex;
 display: -ms-flexbox;
 display: flex;
 -webkit-box-align: center;
 -webkit-align-items: center;
 -ms-flex-align: center;
}

/*************popup setting end***********************/


/*****add list setting*******/
.overflowbxsection{
  max-height:350px;
  overflow: auto;
}

.overflowbxsection::-webkit-scrollbar-thumb {
border: 2px solid transparent;
border-radius: 10px;
background-color: #666;
background-clip: content-box;
-webkit-background-clip: content-box;

}

.overflowbxsection::-webkit-scrollbar-thumb:hover {
background-color: #666;;
background-clip: border-box;
-webkit-background-clip: border-box;

}

.overflowbxsection::-webkit-scrollbar {
width: 8px;
height: 8px;
background-color: transparent;
}


.Documentlistbox{
  margin:0; padding:0;
  list-style-type: none;
}

.Documentlistbox li {
    display: -webkit-box;
    display: -webkit-flex;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-align: center;
    -webkit-align-items: center;
    -ms-flex-align: center;
    align-items: center;
    padding:5px 10px;
    border-bottom: 1px solid #eee;
}

.Documentlistbox li:nth-child(2n){
  background-color:#f7f7f7;
}

.Documentlistbox li:last-child{
margin:0;
}

.Documentlistbox li h3{
  margin:0;
  padding:0;
  width:calc(100% - 100px);
  font-size:15px;
}

.two_eventbx{
  text-align:right;
}

.two_eventbx {
    text-align: right;
    width: 100px;
}

.addbutton_area {
    width: 100%;
    padding: 3px 10px;
    text-align: right;
}

.two_eventbx button.btn-sm, .addbutton_area button {
    width: 32px;
    min-width: 32px;
    height: 32px;
    border-radius: 50%;
    padding: 0;
    font-size: 16px;
}

.outerboxdegin {
    border: 1px solid #ccc;
    padding: 1px solid #ccc;
    margin: 15px;
    width: 320px;
}

.dynamicdatatexboxes .multiselect-dropdown{
  display: inline-block;
  padding: 5px 5px 0px 5px;
  border-radius:0px;
  border: solid 1px #ccc;
  background-color: white;
  position: relative;
  background-repeat: no-repeat;
  background-position: right .75rem center;
  background-size: 16px 12px;
  min-height: 34px !important;
  width: 100% !important;
}


#DocfilenameAction{
 height:auto !important;
 max-height:105px !important;	
 margin-left:0 !important;
}


@media(min-width:992px){
	
.new_attachmenbtn{
 font-weight:600;
 float:left;	
}	
	
}



@media(max-width:495px){

.wrapfildsinside{
 -webkit-flex-wrap: wrap;
-ms-flex-wrap: wrap;
 flex-wrap: wrap;	
} 
#Approval_doc{
 padding-left:5px !important;	
}
.wrapfildsinside .fieldbx,
.wrapfildsinside>label {
    width:100%;
    min-width:100%;
}
.wrapfildsinside>label{
 margin-bottom:5px;	
}

.fullwidth_dropdown{
  width:100%;
  text-align:left;
}

.fullwidth_dropdown button {
  width: calc(100%);
}

}

/***top buttons****/
.new-request-top-panel {
    box-shadow: 0px 4px 5px rgb(0 0 0 / 15%);
}
.modal_links{
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-orient: horizontal;
  -webkit-box-direction: normal;
  -webkit-flex-flow: row wrap;
  -ms-flex-flow: row wrap;
  flex-flow: row wrap;
 -webkit-box-pack: flex-end;
 -webkit-justify-content: flex-end;
 -ms-flex-pack: flex-end;
 justify-content: flex-end;	  
 margin:0;
  padding:0;
  list-style-type:none;
  width:100%;
} 

.modal_links li{
  transition:0.3s;
  border:1px solid transparent;
}

.modal_links li:hover{
 background:#efefef;
 border:1px solid #98d6d8;
}

.modal_links li.active{
 background:#efefef;
 border:1px solid #98d6d8;
}

.modal_links li a{
    display: -webkit-box;
    display: -webkit-flex;
    display: -ms-flexbox;
    display: flex;
  -webkit-box-align: center;
  -webkit-align-items: center;
  -ms-flex-align: center;
   align-items: center;
   text-decoration: none;
   color:#333;
   padding:2px 5px;
   margin:3 1px;
}
.modal_links li a img{
  width: 22px;
  margin-right: 4px;
}


.covertophere {
width: 90px;
margin-right:10px;
position: relative;
cursor: pointer;
}
.approve-process-upload-data {
/* border: 1px solid #d2d2d2; 
padding: 2PX;*/
width: 60px;
min-width: 60px;
height: 60px;
margin-left: 10px;
border-radius: 6px;
}
.approve-process-upload-data img {
width: 100%;
object-fit: contain;
}
.covertophere:before {
content: 'Browse';
width: 90px;
height: 34px;
position: absolute;
top: 0;
left: 0;
background: #e4e4e4;
display: block;
border: 1px solid #c2c2c2;
border-radius: 2px;
text-align: center;
line-height: 34px;
font-size: 13px;
color: #333;
cursor: pointer;
box-shadow: inset 1px 1px 1px #fff;
transition: 0.5s;
}
.covertophere input[type="file"] {
visibility: hidden;
opacity: 0;
width: 90px;
height: 34px;
}

.covertophere.uploading:before{
 content:'Upload';	
}

@media(min-width:992px){

.modal_links{
 margin: 2.5rem 0 0;	
}
	
}


.columnnametxt .input-sm{
 height:auto !important;
 min-height:30px;	
}


.loading_now {
font-size: 20px;
position: relative;
color: #c9c9c9;
letter-spacing: 1px;
display: inline-block;
margin: 0;
padding: 0;
text-transform: uppercase;
font-weight: 600;
}Â .loading_now::before {
content: attr(data-text);
position: absolute;
color: #1b70c7;
width: 0;
animation: anmats 3s ease infinite;
-webkit-animation: anmats 3s ease infinite;
overflow: hidden;
}

.round_shap{
    border: 1px solid #ccc;
    display: inline-block;
    padding: 5px  72px 5px 7px;
    border-radius: 30px;
    color: #333;
    position:relative;
    margin:3px;
}  

.round_shap:hover{
  background: #eee;
}

.round_shap .event_btn{
  position:absolute;
  top:4px;
  right:5px;
}
.round_shap .event_btn a {
    color: #404040 !important;
    margin: 0 3px;
    font-size: 12px;
    position:relative;
}

.round_shap .event_btn a:before {
    content: attr(per);
    position: absolute;
    background: #333;
    color: #fbfbfb;
    font-size: 10px;
    letter-spacing: 0.5px;
    padding: 5px;
    top: -25px;
    border-radius: 10px;
    left: 50%;
    opacity: 0;
    visibility: hidden;
    transition: 0.5s;
    transform: translate(-50%);
    -webkit-transform: translate(-50%);
    -webkit-transform: translate(-50%);
    -moz-transform: translate(-50%);
}

.round_shap .event_btn a:hover:before{
   opacity:1;
   visibility:visible;
   
}

.total_attch_fils .filename {
    max-width: 140px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: block;
    font-size: 13px;
}


Â 
@keyframes anmats{

0%{
 width:0;
}Â Â  
100%{
 width:100%;
}
Â 
}Â 




</style>



<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:_dlc_DocId msdt:dt="string">ADMIN-1645029823-3572</mso:_dlc_DocId>
<mso:_dlc_DocIdItemGuid msdt:dt="string">f6831c3d-adac-4ce9-a51d-63ad003c9645</mso:_dlc_DocIdItemGuid>
<mso:_dlc_DocIdUrl msdt:dt="string">https://adaptindia.sharepoint.com/sites/Titan_2_2_1_DEV/_layouts/15/DocIdRedir.aspx?ID=ADMIN-1645029823-3572, ADMIN-1645029823-3572</mso:_dlc_DocIdUrl>
<mso:MediaServiceImageTags msdt:dt="string"></mso:MediaServiceImageTags>
<mso:lcf76f155ced4ddcb4097134ff3c332f msdt:dt="string"></mso:lcf76f155ced4ddcb4097134ff3c332f>
<mso:TaxCatchAll msdt:dt="string"></mso:TaxCatchAll>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>

<body>
	<div id="Onloader" style="display:none"><h3 class="loading_now" data-text="Loading...">Â  Loading... </h3></div>
	<div class="container margin_mg_bothside">
		<div class="custom-panel" style="display:none">
			<!-----<div class="panel-head">
				<h1 class="panel-head-text"></h1>
			</div>------>
			<div class="panel-body pl0 pb0 pr0" style="padding-top:0;">
				<div class="row ml0 mr0 new-request-top-panel">
					<div class="col-md-12" style="text-align:center">
						<div class="ellipsis-4 font-16" id='titleid'></div>
					</div>
					
					<div class="col-md-4 col-xs-12">
						<div class="new-request-top-left new-request-top-left-main">
							<div class="new-request-top-left-img" id="approvalprocessimgid">
							</div>
							<div class="new-request-top-left-text">
								<div class="new-request-top-left-title ellipsis-1 mb10" id="requestfrid"></div>
								<div class="new-request-top-left-title-pera ellipsis-1" id="templatenameid"></div>
							</div>
						</div>
					</div>
					
					<div class="col-md-8 col-xs-12" id="new-request-top-right-change-Display">
						<ul class="modal_links">
						  	<li class="new-request-top-right-change-Display">
						   		<div class="">
						   			<a href="#newRequestModal" data-toggle="modal">
						   				<img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/tamplates.png">
						   				Template
						   			</a>
						   		</div>   
						  	</li>
						  	<li class="new-request-top-right-change-Display">
						   		<div class="">
							 		<a href="#stepsapprover" data-toggle="modal" onclick="ViewStep()">
							   			<img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/workflow.png">
							   			Workflow
							   		</a>
								</div>   
						  	</li>
						  	<li>
						   		<div class="new-request-top-right-change-Display-History">
							 		<a href="#new_history" data-toggle="modal" onclick="GetHistoryDtl()">
							   			<img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/workflow.png">
							   			History
							   		</a>
								</div>   
						  	</li>
						  	<li>
						 		<div class="text-right" style="display:none;" id="ForwardTextDiv">
						 	   		<a href="#forwarding_process" data-toggle="modal" style="" onclick="GetForwardHistory()">
							   			<img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/user_cile.png" id="ForwardedByImage">							       
							   			Forwarded By
						       		</a>
					    		</div> 
						  	</li>
						  	<li>
						    	<div>
						    		<a href="#" data-toggle="modal" data-target="#additional_document">
						      			<img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/attachment.png">
						      			Attachments
						    		</a> 
						    	</div>   
						  	</li>
						  	<!-------<li class="new-request-top-right-change-Display">
						    	<div>
						    		<a href="#" onclick="SaveLink()"ss>
						      			<img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/star.png" alt="">
						      			Add to Favorite
						    		</a>
						    	</div>    
						  	</li>------->
						  	<li style="display:none;">
						    	<div>
						    		<a href="#process_action" data-toggle="modal" onclick="ViewProcessDetails()">
						       			<img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/information.png" alt="">
						      			About this process
						    		</a> 
						    	</div>   
						  	</li>
						</ul>					     
					</div>
			    </div>
				<div class="row ml0 mr0 pt15" id="appenddyamicboxes">

				</div>
				<div class="pl15 pr15 pb15">
					
					<!-- Trigger the modal with a button -->
					<div class="row">
						<div class="col-md-6">
							<div class="approve-process-upload-image-box-btn">
								<!---------<div class="form-group custom-form-group">
										<input type="file" class="form-control approve-process-upload-image-inp" id="attachmentsupload" style="display:none;" name="" multiple >
										<label for="attachmentsupload" style="color:#1d6ec0; margin-top:10px; display:block; width:200px; cursor:pointer">Supporting Documents</label>
									</div>----------->
									
								<!--<input type="file" id="attachmentsupload" multiple />  -->
								<div class="approve-process-upload-data scrollbar-panel" id="Docfilename" style="width:100%; min-width:auto; max-height:300px; margin-bottom:10px;">
								
								<!--<label class="covertophere uploading">
			                      <input name="" id="" type="file" class="browse form-control" multiple>
			                    </label> 
									<div class="approve-process-upload-data-chip">
	                            		<i class="fa fa-paperclip"></i>
	                            		<span>test-img.png</span>
	                            		<i class="fa fa-times-circle-o"></i>
	                            	</div>                           -->
								</div>								
							</div>
						</div><!---col-md-6-->
					</div><!--row ed-->	
						<div class="pl15 pr15 pb15 text-center btnmanage btngroupsetting">
						    <a href="#" class="new_attachmenbtn" data-toggle="modal" data-target="#additional_document" style="color:#1d6ec0; text-decoration:none; display:inline-block; padding:5px 5px;">Attached Document(s) : <span class="countingbx">0</span></a>
							<!--	<button type="button" class="btn custom-btn" id="savenewrequest">Submit</button>  -->
							<a type="button" class="btn custom-btn" id="AttachDocs"data-toggle="modal" data-target="#Approval_doc"><img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/attachfiles.png"> Attachments</a>
							<a type="button" class="btn custom-btn" id="savenewDraft" style="display:none;"><img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/pencils.png" style="width:19px !important"> Save as Draft</a>
							<a type="button" class="btn custom-btn" id="Approverequest" data-toggle="modal" data-target="#approvalActionModal"><img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/checknow.png"> Approve</a>														
							<a type="button" class="btn custom-btn" id="savenewrequest"><img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/checknow.png"> Submit</a>
							<a type="button" class="btn btn-danger" id="Rejectrequest" data-toggle="modal" data-target="#approvalRejectionModal"><img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/cancel.png"> Reject</a>
							<a type="button" class="btn custom-btn" id="Forwardrequest"data-toggle="modal" data-target="#forward_stpings" onclick="LoadColumnSignPos()"><img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/forward.png"> Forward</a>
							<a type="button" class="btn custom-btn" id="Revertrequest" data-toggle="modal" data-target="#rever_multistep" onclick="GetStepsRevert();"><img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/revert.png"> Revert</a>
							<a type="button" class="btn custom-btn" id="Forward-Review-Btn" data-toggle="modal" data-target="#review_structure" style="display:none;"><img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/review.png"> Review</a>
						</div>
					
				</div>
			</div>
		</div>
		
   <!----history sec---->
		
		<div class="history_listbx row" style="display:none">
		  
		  <div class="timebox col-md-6">
		    <h4 class="time_heading">History</h4>
		
		    <ul class="mainlst">
		      <li>
		            <span class="iconbox">
		              <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/NewEntryAssets/images/time-icon-1.png" alt="">
		            </span> 
		
		            <div class="approvelheadeing">  
		              <h3 class="mainheading">Approvel Initiation</h3>
		              <span class="date-sec">12 Jan 2021 4:10 PM</span>
		            </div>
		            <p class="waitsec initialize">initialized</p>
		
		              <div class="row">
		               
		                <div class="col-sm-6 flexitem">
		                  <div class="imgsetion">
		                    <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/NewEntryAssets/images/img-21.jpg" alt="">
		                  </div>
		                  <div class="imagecontent">
		                    <h4>Lakhan kumar</h4>
		                    <a href="#">LakhankumarAdaptIndia.com</a>
		                  </div>
		                </div>
		
		                <div class="col-sm-6">
		                  <h3 style="font-size: 12px; margin-bottom:5px; padding:-left:3px; color:#333">
		                   Attachment files:
		                  </h3>
		                   <div class="signbox">
		                    <div class="upload-chip">
		                      <span class="pr-8 chip-text-box" style="color:#333; cursor:pointer;" title="">Example chart1.pdf</span>
		                      <span class="chip-icon-box">
		                        <a href="" download="" style="color:#333;"><i class="fa fa-download cursor-pointer" aria-hidden="true"></i>
		                        </a>
		                      </span>
		                    </div>
		                  </div>
		                </div>
		              </div><!--row ed-->  
		
		            </li>
		
		        <li>
		            <span class="iconbox">
		              <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/NewEntryAssets/images/time-icon-4.png" alt="">
		            </span>
		
		            <div class="approvelheadeing">  
		              <h3 class="mainheading">Accounts clearance</h3>
		              <span class="date-sec">12 Jan 2021 4:10 PM</span>
		            </div>  
		              <p class="waitsec completed" style="color:#4e9a06">Approved by e-Signed</p>
		              <div class="row">
		                <div class="col-sm-6 flexitem">
		                  <div class="imgsetion">
		                    <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/NewEntryAssets/images/img-21.jpg" alt="">
		                  </div>
		                  <div class="imagecontent">
		                    <h4>Miss Julie Agarwal</h4>
		                    <a href="#">PriyanshupandyAdaptIndia.com</a>
		                  </div>
		                </div>
		                <div class="col-sm-6">
		                  <h3 style="font-size: 12px; margin-bottom:5px; padding-left:3px; color:#333">
		                   Attachment files:
		                  </h3>
		                  <div class="signbox">
		                    <div class="upload-chip">
		                      <span class="pr-8 chip-text-box" style="color:#333; cursor:pointer;" title="">Example chart1.pdf</span><span class="chip-icon-box">
		                        <a href="" download="" style="color:#333;"><i class="fa fa-download cursor-pointer" aria-hidden="true"></i>
		                        </a>
		                      </span>
		                      </div>
		                  </div>
		                </div>
		              </div><!--row ed-->  
		
		            </li>    
		      
		    </ul>
		  </div>
		</div>
		
		<!---history--->
<!--Templatr Modal -->
<div class="modal fade new-request-modal" id="newRequestModal" role="dialog" data-backdrop="static" data-keyboard="false">
	<div class="modal-dialog modal-lg">
		<div class="modal-content ">
			<div class="modal-header">
				<a type="button" class="close close-round" id="newRequestModalClose"><span class="close-icon">&times;</span></a> 
				<h4 class="modal-title">New Request</h4>
			</div>
			<div class="modal-body pb0">
				<div class="row">
					<div class="col-sm-3">
						<div class="searchareabox" style="margin:10px 0">
							<input type="text" class="form-control" placeholder="Search.." id="Search" onkeyup="mySearchFunction()">
				  		</div>
				  	</div>
				  	<div class="col-sm-4">
				  	    <div class="process_group_fex">
					  	   <label>Process For</label>  
					  		<div class="searchareabox" style="margin:10px 0">
				  				<select id="GroupTemplates" class="form-control" onchange="GroupingTemplates(this.value)"> </select>
							</div>
						</div>
					</div>
				</div>
				<ul class="row new-request-action-panel scrollbar-panel" id="TemplatedBinding1"> </ul>
			</div>
			<div class="modal-footer text-center">
				<a type="button" id="gettemplatenameid" class="btn custom-btn">New Request</a>
			    <h2 class="text-right hide" id="loadertext"><a type="text" id="">Loading..... </a></h2>
			</div>
			
		</div>
	</div>
</div>


		<!-- stepsapprover popup start -->
		<div id="stepsapprover" class="modal fade" role="dialog">
			<div class="modal-dialog modal-lg">
				<!-- Modal content-->
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close close-round" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Steps and Approvers</h4>
					</div>
					<div class="modal-body">
						<div class="stepingbox">
							<ul class="stepbox" id="stepboxView">
								<!--	<li>
						<div class="topsec">
							<h3>Step1</h3>
							<button type="button">
						  	 <i class="fa fa-times" aria-hidden="true"></i>
						    </button>  
						</div>
						<div style="clear:both"></div>
						<div class="flexitem">
		                  <div class="imgsetion">
		                    <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Process Approval/assets/images/user-circle.png" alt="">
		                  </div>
		                  <div class="imagecontent">
		                    <h4>Priyanshu Pandey</h4>
		                    <a href="#">PriyanshupandyAdaptIndia.com</a>
		                  </div>
		                </div>	

					</li>

					<li>
						<div class="topsec">
							<h3>Step2</h3>
					<!--	<button type="button">
						  	 <i class="fa fa-times" aria-hidden="true"></i>
						    </button>  
						</div>

						<div style="clear:both"></div>

						<div class="flexitem">
		                  <div class="imgsetion">
		                    <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Process Approval/assets/images/user-circle.png" alt="">
		                  </div>
		                  <div class="imagecontent">
		                    <h4>Priyanshu Pandey</h4>
		                    <a href="#">PriyanshupandyAdaptIndia.com</a>
		                  </div>
		                </div>	

					</li>

					<li>
						<div class="topsec">
							<h3>Step3</h3>
					<!--		<button type="button">
						  	 <i class="fa fa-times" aria-hidden="true"></i>
						    </button>  
						</div>

						<div style="clear:both"></div>

						<div class="flexitem">
		                  <div class="imgsetion">
		                    <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Process Approval/assets/images/user-circle.png" alt="">
		                  </div>
		                  <div class="imagecontent">
		                    <h4>Priyanshu Pandey</h4>
		                    <a href="#">PriyanshupandyAdaptIndia.com</a>
		                  </div>
		                </div>	

					</li>  -->
							</ul>
						</div>

						<!---rowlbox--->
					</div>

				</div>

			</div>
		</div>

		<!-- stepsapprover start -->
		<!-- Approval Action Modal -->
    <div class="modal fade approval-action-modal" id="approvalActionModal" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close close-round" data-dismiss="modal"><span
                            class="close-icon">&times;</span></button>
                    <h4 class="modal-title">Approval</h4>
                </div>
                <div class="modal-body pb0">
                    
                    <div id="SignatureBox">
                    <div class="form-group custom-form-group custom-form-group-radio-inline mb10">
                        <label class="radio-inline"><input type="radio" name="SignTypeRadio" id="SignTextRadio"  value="SignText" checked="checked">Type</label>
                        <label class="radio-inline"><input type="radio" name="SignTypeRadio" id="SignImageRadio" value="SignImage">Image</label>
                        <label class="radio-inline"><input type="radio" name="SignTypeRadio" id="SignDrawRadio" value="SignDraw">Draw</label>
                    </div>
                    <div class="signature-box mb15" style="position:relative">
                        <a type="button" class="btn custom-btn-two-cancel wpx-80 draw-signature-box-type-clear-btn"  name="TextSignaturebtn" id="CLR-TextSignature" onclick="">Clear</a>
                        <div class="signature-box-container">
                            <input class="form-control text-center signature-front" type="text" placeholder="Type your sign here" id="SingTextType">
                        </div>
                    </div>
                    <div class="drag-drop-box mb15 d-none" style="position:relative">
                      
                      <div class="flexingboxs">
                        <a type="button" class="btn custom-btn-two-cancel wpx-80 draw-signature-box-image-clear-btn"  name="ImageUploadSignaturebtn" id="CLR-ImageSignature" onclick="">Clear</a>
                        <div class="drop-container" id="drop-zone">
                            <div class="custom-image-label" id="clickHere">Drop your Signature image here or click to upload <i class="fa fa-upload pl-4"></i>
                                <input type="file" name="file" id="file" onchange="document.getElementById('SignImgPreview').src = window.URL.createObjectURL(this.files[0])">
                            </div>
                            <!-- <p class="drop-here-text">Drop your sign image</p> -->
                            <!-- <div class="filename-container" id="filename"></div> -->
                            <div class="approval_image_preview">
                                <img src="" alt="Sign-image" id="SignImgPreview">
                            </div>
                            <button type="button" id="Pre-Upload-List-Btn" class="preload_img" data-toggle="tooltip" title="Pre-upload images"><img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/gallery_mg.png"></button>
                        </div>
                        
                        <div class="preup_load">
						  <button type="button" class="preload_img"><i class="fa fa-times"></i></button>
						  <ul id="Pre-Upload-Signatures">
						    <li>
						      <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/new_sign.png" alt="">
						    </li>
						    <li>
						      <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/new_sign.png" alt="">
						    </li>
						  </ul>
						</div>
						<!---preup_Loadimg-->
					 </div><!---flexboxs--->	
                        
                    </div>
                    <div class="draw-signature-box mb15 d-none" style="position:relative">
                        <!--<div class="draw-signature-box-container" id="Signature">-->
                        <!--<div id="content">-->
                                <div id="signatureparent">
                                    <a type="button" class="btn custom-btn-two-cancel wpx-80 draw-signature-box-draw-clear-btn"  name="Drawsignaturebtn" id="CLR-DrawSignature" onclick="" style="top:-5px">Clear</a>
                                    <div class="draw-signature-box-container" id="signature"></div>
                                </div>
                                
                                
                        <!--</div>

                            
                        </div>-->
                    </div>
                    </div>

                    <div class="form-group custom-form-group">
                        <label for="">Remarks:</label>
                        <textarea class="form-control resize-none RemarksApprovalContent" name="" id="RemarksApprovalContent" rows="4"></textarea>
                    </div>
					<div class="approvalActionpplArea" id="ListPPLapprovalActionModal"></div>
                    <div class="checkbox mt0 mb10 SignatureBoxApproved alignmentmang text-center">
                        <label><input type="checkbox" value="" id="ApprovedChkbox">Approved</label>
                    </div>
                    <!--<div class="form-group custom-form-group">
                    	<div class="wrapingattachments">
						    <input type="file" name="file" id="supporting_doc_files" class="form-control" multiple>
						    <label for="supporting_doc_files" class="control-label" data-localize="Supporting Document">Supporting Document</label>
						</div>
						<div class="approve-process-upload-data" id="DocfilenameAction">
							
						</div>
                    </div>-->

                </div>
                <div class="modal-footer text-center">
                    <a type="button" class="btn custom-btn mr-8 wpx-80"  name="" hreflang="" id="ApprovalSubmitBTN" onclick="ApprovedRequest(this)">Submit</a>
                    <button type="button" class="btn custom-btn-two-cancel wpx-80" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Rejection Modal -->
    <div class="modal fade approval-rejection-modal" id="approvalRejectionModal" role="dialog">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close close-round" data-dismiss="modal"><span
                            class="close-icon">&times;</span></button>
                    <h4 class="modal-title">Reject</h4>
                </div>
                <div class="modal-body pb0">
                    
                    <div class="form-group custom-form-group">
                        <label for="">Remarks: <span class="color-red">*</span></label>
                        <textarea class="form-control resize-none RejectApproveRemark" name="" id="RejectApproveRemark" rows="5"></textarea>
                    </div>
                    <div class="checkbox mt0 mb10 alignmentmang text-center">
                        <label><input type="checkbox" value="" id="RejectApproveChkBox">Rejected</label>
                    </div>
                </div>
                <div class="modal-footer text-center">
                    <a type="button" class="btn custom-btn mr-8 wpx-80"  id="RejectRequestSubmit">Submit</a>
                    <a type="button" class="btn custom-btn-two-cancel wpx-80" data-dismiss="modal">Close</a>
                </div>
            </div>
        </div>
    </div>
    
    
<!-- Approval Reviewed Modal -->
    <div class="modal fade approval-rejection-modal" id="approvalReviewedModal" role="dialog">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close close-round" data-dismiss="modal"><span
                            class="close-icon">&times;</span></button>
                    <h4 class="modal-title">Review</h4>
                </div>
                <div class="modal-body pb0">
                    
                    <div class="form-group custom-form-group">
                        <label for="">Remarks: <span class="color-red"></span></label>
                        <textarea class="form-control resize-none ReviewedApproveRemark" name="" id="ReviewedApproveRemark" rows="5"></textarea>
                    </div>
                    <div class="approvalReviewedpplArea" id="ListPPLapprovalReviewedModal"></div>
                    <div class="checkbox mt0 mb10 alignmentmang text-center chkboxdiv">
                        <label><input type="checkbox" value="" id="ReviewedApproveChkBox">Reviewed</label>
                    </div>
                </div>
                <div class="modal-footer text-center">
                    <a type="button" class="btn custom-btn mr-8 wpx-80"  id="ReviewedRequestSubmit">Submit</a>
                    <a type="button" class="btn custom-btn-two-cancel wpx-80" data-dismiss="modal">Close</a>
                </div>
            </div>
        </div>
    </div>
    
    

<!-- Approval Reviewed Modal -->
    <div class="modal fade approval-rejection-modal" id="approvalEditModal" role="dialog">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close close-round" data-dismiss="modal"><span
                            class="close-icon">&times;</span></button>
                    <h4 class="modal-title" id="ModelIDText">Approved</h4>
                </div>
                <div class="modal-body pb0">
                    
                    <div class="form-group custom-form-group">
                        <label for="">Remarks: <span class="color-red"></span></label>
                        <textarea class="form-control resize-none EditDataApproveRemark" name="" id="EditDataApproveRemark" rows="5"></textarea>
                    </div>
                    <div class="approvalEditpplArea" id="ListPPLapprovalEditModal"></div>
                    <div class="checkbox mt0 mb10 alignmentmang text-center">
                        <label><input type="checkbox" value="" id="EditDataApproveChkBox"><span id="ChkText">Approved</span></label>
                    </div>
                </div>
                <div class="modal-footer text-center">
                    <a type="button" class="btn custom-btn mr-8 wpx-80"  id="EditDataRequestSubmit">Submit</a>
                    <a type="button" class="btn custom-btn-two-cancel wpx-80" data-dismiss="modal">Close</a>
                </div>
            </div>
        </div>
    </div>


    


<!-- rever_multistep -->
<div id="rever_multistep" class="modal fade" role="dialog">
	<div class="modal-dialog modal-lg">
    	<div class="modal-content">
      		<div class="modal-header">
        		<button type="button" class="close close-round" data-dismiss="modal">
          			<span class="close-icon">&times;</span>
        		</button>
        		<h4 class="modal-title">Revert</h4>
      		</div>
      		<div class="modal-body" >
        		<div class="scrollingbox_define">
          			<table class="table">
            			<thead>
              				<tr>
                				<th style="width:5%">Revert</th>
                				<th style="width:10%; text-align:center">Skip</th>
                				<th>Step</th>
                				<th style="width:4%"></th>
              				</tr>
              			</thead>
            			<tbody id="tbodyRevert">
            			</tbody>
          			</table>
          		</div>
          		
          		<div class="form-group custom-form-group" style="margin-bottom: 0px; margin-top: 12px;">
				  <label for="">Remarks:</label>
				  <textarea name="" id="RevertRemarksText" cols="10" rows="3" class="form-control RevertRemarksText"  style="min-height: 85px; resize: none;"></textarea>
				</div>
          	</div>
      		<div class="modal-footer" style="text-align: center; padding:7px; margin-top:0">
        		<a class="btn custom-btn" onclick="AddRevertSteps(this)" id="AddRevertStepsBtn">Submit</a>
        		<a class="btn custom-btn" onclick="" data-dismiss="modal">Close</a>
      		</div>
		</div>
  	</div>
</div>

<!-----revert ed---->

<!-- approvalForwardModal Modal -->

<div id="forward_stpings" class="modal fade" role="dialog">
  <div class="modal-dialog modal-md">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close close-round" data-dismiss="modal">
         <span class="close-icon">&times;</span>
        </button>
        <h4 class="modal-title">Forward</h4>
      </div>
      <div class="modal-body">
        <ul class="nav nav-pills" style="margin-bottom: 12px;">
          <li class="active" id="addstakeholders-LI">
            <a data-toggle="pill" href="#addstakeholders">Add Stakeholders</a>
          </li>
          <li id="successor_processing-LI" style="display:none;">
            <a data-toggle="pill" href="#successor_processing">
            Add a Successor Step
            </a>
          </li>
          <li id="Review_Returns-LI">
            <a data-toggle="pill" href="#Review_Returns">
            Forward for Review
            </a>
          </li>
          
        </ul>
        <div class="tab-content">
        
        
          <div id="addstakeholders" class="tab-pane fade in active">
            <label>Stakeholder:</label>
            <div class="teambox" style="margin-bottom: 0px;">
              <div class="row fullcoverbox no-gutter" id="UsersListForward">
                <div class="col-sm-6 col-xs-12 parentremove">
                    <div class="employeesection">
                      <div class="empoyeeimg">
                        <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/user-circle.png" alt="">
                      </div>
                      <div class="employeeinfo">
                        <h3>Dipankar Goswami</h3>
                        <a href="#">d.goswami@adapt-india.com</a>
                      </div>
                    </div>
                 </div><!--col-6 ed--->
                 <div class="col-sm-6 col-xs-12 parentremove">
                    <div class="employeesection">
                      <div class="empoyeeimg">
                        <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/user-circle.png" alt="">
                      </div>
                      <div class="employeeinfo">
                        <h3>Dipankar Goswami</h3>
                        <a href="#">d.goswami@adapt-india.com</a>
                      </div>
                    </div>
                 </div><!--col-6 ed--->
                 <div class="col-sm-6 col-xs-12 parentremove">
                    <div class="employeesection">
                      <div class="empoyeeimg">
                        <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/user-circle.png" alt="">
                      </div>
                      <div class="employeeinfo">
                        <h3>Dipankar Goswami</h3>
                        <a href="#">d.goswami@adapt-india.com</a>
                      </div>
                    </div>
                 </div><!--col-6 ed--->
                 <div class="col-sm-6 col-xs-12 parentremove">
                    <div class="employeesection">
                      <div class="empoyeeimg">
                        <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/user-circle.png" alt="">
                      </div>
                      <div class="employeeinfo">
                        <h3>Dipankar Goswami</h3>
                        <a href="#">d.goswami@adapt-india.com</a>
                      </div>
                    </div>
                 </div><!--col-6 ed--->

               </div><!--row ed-->
               
               <div class="addeventcircle">
                 <button type="button" class="btn custom-btn tottglinbtn" id="multiaddnowsecing">
                  <i class="fa fa-plus"></i>
                 </button>
                  <div class="form-control increase_effect" id="ForwardUserPicker1"></div>
               
               </div>
               
              </div><!---teams--->
          
			<div class="form-group custom-form-group" style="margin-bottom: 0px; margin-top: 12px;">
			  <label for="">Remarks:</label>
			  <textarea id="ForwardStackholderRemarks" name="" cols="10" rows="3" class="form-control" style="min-height: 85px; resize: none;"></textarea>
			</div>  
		  	  
           
        </div><!---tab_fist ed-->
        
          <div id="successor_processing" class="tab-pane fade" style="display:none;">
          
          <div class="form-group custom-form-group">
            <label>Step Name:<span class="color:#ff0000">*</span></label>	
            <input type="text" class="form-control" id="StepNameText">
          </div>
          
          <div class="form-group custom-form-group">
            <label>Stakeholder:<span class="color:#ff0000">*</span></label>	
            <div class="form-control" id="NewStakeholderList"></div>
          </div>
          
            <div class="form-group custom-form-group">
              <label for="Action">Action:</label>
              <div class="flxingtyp">
                 <select class="form-control" onchange="SetDisplayPrTable4Approvers(this.value)" id="ActionControlDDL">
                    <option value="Edit Data">Edit & Approve</option>
                    <option value="Edit Sign">Edit & Sign</option>
                    <option value="Review Only">Review Only</option>
                    <option value="Review Sign" selected="selected">Review & Sign</option>
                  </select>
                  <button type="button" class="btn custom-btn"  id="editablefildStepsDIV"
                  data-target="#editablefild" data-toggle="modal" style="margin-left: 5px; min-width:auto; display:none;" onclick="LoadPartialTableSteps();">
                    Set Columns
                  </button>
              </div>
            </div>
            <div class="form-group custom-form-group row">
            <div class="col-md-6">
               <label for="Position of Signature">Position of Signature:</label>
               <div class="radio_grouping"> 
                 <label class="radio-inline">
                  <input type="radio" name="optionalsec" value="At Bottom most" checked="checked" onclick="SetDisplayPosBox(this)">
                  At Bottom most
                 </label>
                 <label class="radio-inline" style="margin-top:5px; margin-bottom:5px;">
                  <input type="radio" name="optionalsec" value="At Bottom of" onclick="SetDisplayPosBox(this)">
                  At Bottom of
                 </label>
              </div>
              <select name="" class="form-control" id="SignPosDDL" style="display:none;">
                <option value="OP Number">OP Number</option>
              </select>
            </div>
          </div>

          <div class="form-group custom-form-group" style="margin-bottom: 0px;">
            <label for="">Remarks:</label>
            <textarea name="" id="StepsRemarks" cols="10" rows="3" class="form-control StepsRemarks" style="min-height: 85px; resize: none;"></textarea>
          </div>

          </div><!---tab_2--->
          
			<div id="Review_Returns" class="tab-pane fade">
				<div class="form-group custom-form-group">
					<label for="Action">Forward to:</label>
              		<div class="form-control" id="ReturnStakeholderList" style="margin-bottom:12px;">
              		</div>
              
              		<div class="teambox" style="margin-bottom: 0px;">
              			<div class="row fullcoverbox no-gutter" id="ListReturnForwardUser" style="padding-top:15px; padding-bottom:15px;">
              	
              			</div>
					</div><!---teams--->
            	</div>
            			            
           		<div class="form-group custom-form-group" style="margin-bottom: 0px;">
            		<label for="">Message:</label>
            		<textarea name="" id="ForwardRetMessage" cols="10" rows="3" class="form-control ForwardRetMessage" style="min-height: 85px; resize: none;"></textarea>
          		</div>
          		<div class="form-group custom-form-group" style="display:none;">
	          		<label class="checkbox-inline">
	            		<input type="checkbox" id="RestrictviewChkbox" style="width:15px; height:15px; margin-top:0;">
	            		Restrict view to others
	          		</label>
          		</div>
          	</div><!---tab--3ed-->
		 
      </div> 
        
      </div>
      <div class="modal-footer" style="text-align: center; padding:7px; margin-top:0">
        <a class="btn custom-btn" onclick="ADDStakeHolder(this)">Submit</a>
        <a class="btn custom-btn-two-cancel wpx-80" onclick="SetModalDefaultState(this)" data-dismiss="modal">Close</a>
      </div>
    </div>

  </div>
</div>

<!-- approvalForwardModal Modal ed-->  

<!-- editablefild -->
<div id="editablefild" class="modal fade" role="dialog" style="background: rgba(0,0,0,0.7);">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-body" style="padding:0 !important">

        <div class="table_heightmanage coverboxlist">
            <table class="table table-bordered table-striped" style="padding:0; margin:0;">
              <thead>
                <tr>
                  <th style="width: 80%;">Fields</th>
                  <th style="width: 15%;">Editable</th>
                </tr>
              </thead>
              <tbody id="TableFieldsListSteps">
                  <tr>
                    <td>Column label 1</td>
                    <td><input type="checkbox" style="height: 17px; width: 17px;"></td>
                  </tr>
                  <tr>
                    <td>Column label 2</td>
                    <td><input type="checkbox" style="height: 17px; width: 17px;"></td>
                  </tr>
                  <tr>
                    <td>Column label 3</td>
                    <td><input type="checkbox" style="height: 17px; width: 17px;"></td>
                  </tr>
                  <tr>
                    <td>Column label 4</td>
                    <td><input type="checkbox" style="height: 17px; width: 17px;"></td>
                  </tr>
              </tbody>
            </table>
        </div>

      </div>
      <div class="modal-footer" style="text-align: center; margin:0; padding:5px;">
        <button type="button" class="btn custom-btn" style="width: 100px" onclick="SetTableFieldsListSteps()">Set</button>
        <button type="button" class="btn custom-btn-two-cancel" style="width: 100px" data-dismiss="modal" onclick="SetDefaultState()">Close</button>
      </div>
    </div>

  </div>
</div>

<!----editablefild---->

<!-- review_structure -->
<div id="review_structure" class="modal fade" role="dialog">
  <div class="modal-dialog">
   <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close close-round" data-dismiss="modal">
          <span class="close-icon">&times;</span>
        </button>
        <h4 class="modal-title">Review</h4>
      </div>
      <div class="modal-body">
        <div class="reviewoptions">
            <div class="radio-box">
              <label for="alloksec">
                <input type="radio" id="alloksec" name="ok_section" value="All is Ok" checked="checked">
                <span>All is Ok</span>
              </label>
            </div>
            <div class="radio-box">
              <label for="Notok">
                <input type="radio" id="Notok" name="ok_section" value="Not Ok">
                <span>Not Ok</span>
              </label>
            </div>
            <div class="radio-box">  
              <label for="needclarity">
                <input type="radio" id="needclarity" name="ok_section" value="Need more Clarity">
                <span>Need more Clarity</span>
              </label>
            </div>
            <div class="radio-box">  
              <label for="cannotdecide">
                <input type="radio" id="cannotdecide" name="ok_section" value="Can not decide">
                <span>Can not decide</span>
              </label>
            </div>
        </div>  
        <!----revieoptions--->
       <div class="form-group" style="margin-top:8px;">
          <label for="">
            Remarks
          </label>
          <textarea name="" id="RemarkFeedback" cols="30" rows="3" class="form-control" style="resize: none;"></textarea>
        </div>
        <div class="" style="text-align: center;">
          <label for="reviewedbox" style="margin-bottom:0;">
            <input type="checkbox" id="reviewedbox">
            Reviewed
          </label>
        </div>   

      </div><!---modalbody--->
      <div class="modal-footer" style="text-align: center; padding:5px;">
        <button type="button" class="btn custom-btn wpx-87" id="SetFeedBackdata">Submit</button>
      </div>
    </div>
 </div>
</div>
<!-- review_structure -->


<!---forwarding_process--->
<div class="modal fade" id="forwarding_process" role="dialog">
	<div class="modal-dialog">
	<!-- Modal content-->
    	<div class="modal-content">
        	<div class="modal-header">
          		<button type="button" class="close close-round" data-dismiss="modal">&times;</button>
          		<h4 class="modal-title">Forward</h4>
        	</div>
        	<div class="modal-body">
          		<div class="forward_wraping scrollingeffect timlineheight"> 
            		<ul class="forwardlist">
              			<li class="forward_by_section">
              			   <div class="wrapingnow">
                			<h3 class="forwrad_heading">Forwarded By</h3>
                			<div class="forward_by row">
                  				<div class="col-md-12">
                    				<div class="flexitem">
                        				<div class="imgsetion">
                          					<img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/user-circle.png" alt="" id="ForwardbyPhoto">
                        				</div>
                        				<div class="imagecontent">
                          					<h4 id="ForwardbyTitle">Priyanshu pandey</h4>
                          					<a href="#" id="ForwardbyEmail">priyanshupandey@.com</a>
                        				</div>
                    				</div><!--flexitems--->
                    				
                    				<div class="date_showing" style="margin:5px 0 5px 25px; font-weight:600;">
                      					<span id="ActionDate">Aug 3 2022</span> <span id="ActionTime">10:45 AM</span>
                    				</div>
                    				
                    				<div class="wraping_only padd_reduce">   
                      					<div class="remarkboxsec">
                        					<span><label for="">Remark</label><label for="">:</label></span>
                        					<div id="ForwardbyRemark">Lorem ipsum dolor sit amet consectetur adipisicing elit. Nostrum vel quos non, et explicabo eaque aspernatur sed libero corrupti natus expedita nesciunt mollitia nobis dolor quasi saepe nisi qui facere?.</div>
                      					</div>
                    				</div>
                    				<!--<div class="ReviewAttachBox">
		                   				<div class="upload-chip">
                           					<span class="chip-text-box">information_detail.png</span>
                           					<span class="chip-icon-box">
                             					<a href="#"><i class="fa fa-download"></i></a>
                           					</span>
                         				</div>
                         				<div class="upload-chip">
                           					<span class="chip-text-box">information_detail.png</span>
                           					<span class="chip-icon-box">
                             					<a href="#"><i class="fa fa-download"></i></a>
                           					</span>
                         				</div>
                        			</div>-->  
                  				</div><!---9col-->
                  			 </div><!---forward_by ed--->
                			</div><!---wrapingbox---->
                			
                			<ul class="forwardlist_child">
                  				<li>
                    				<h3 class="forwrad_heading">Forward to</h3>
                    				<div class="forward_to row">
                      					<div class="col-md-8">
                        					<div class="flexitem">
                            					<div class="imgsetion">
                              						<img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/user-circle.png" alt="">
                            					</div>
                            					<div class="imagecontent">
                              						<h4>Priyanshu pandey</h4>
                              						<a href="#">priyanshupandey@.com</a>
                            					</div>
                        					</div><!--flexitems--->
                        					<div class="wraping_only">   
                          						<div class="remarkboxsec">
                            						<span><label for="">Remark</label><label for="">:</label></span>
                            						<p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Nostrum vel quos non, et explicabo eaque aspernatur sed libero corrupti natus expedita nesciunt mollitia nobis dolor quasi saepe nisi qui facere?.</p>
                          						</div>
                        					</div>
                      					</div><!---9col-->
                      					<div class="col-md-4">
                      	  					<div class="remarkboxsec ">
                          						<span>
                          							<label for="">Feedback</label>
                          							<label for="">:</label>
                          						</span>
                          						<p style="margin-left: 3px;">Need more Clarity</p>
                        					</div>
                        					<div class="date_gmt_time" style="">
                          						<div class="date_secbx">
                            						<span class="frwd_date">Aug 5 2022</span>
                            						<span class="frwd_time">10:49 AM</span>
                          						</div>
                          						<!--<span>GMT + 5:30 (IST)</span>-->
                        					</div>
                      					</div>
                   	 				</div><!---forward_by ed--->
                  				</li>
                  <li>
                    <div class="forward_to row">
                      <div class="col-md-8">
                        <div class="flexitem">
                            <div class="imgsetion">
                              <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/user-circle.png" alt="">
                            </div>
                            <div class="imagecontent">
                              <h4>Priyanshu pandey</h4>
                              <a href="#">priyanshupandey@.com</a>
                            </div>
                        </div><!--flexitems--->
                        <div class="wraping_only">   
                          <div class="remarkboxsec">
                            <span><label for="">Remark</label><label for="">:</label></span>
                            <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Nostrum vel quos non, et explicabo eaque aspernatur sed libero corrupti natus expedita nesciunt mollitia nobis dolor quasi saepe nisi qui facere?.</p>
                          </div>
                        </div>
                      </div><!---9col-->
                      <div class="col-md-4">
                        <div class="remarkboxsec ">
                          <span>
                          <label for="">Feedback</label>
                          <label for="">:</label></span>
                          <p style="margin-left: 3px;">Need more Clarity</p>
                        </div>
                      </div>
                    </div><!---forward_by ed--->
                  </li>
                </ul>
              </li>
            </ul>
          </div>  
        </div>
      </div>
      
    </div>
  </div>
   
<!---forwarding_process ed--->


<!---Asking_process_Approvers--->
<div class="modal fade" id="Asking_process_Approvers" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
          		<button type="button" class="close close-round" data-dismiss="modal">&times;</button>
          		<h4 class="modal-title">Stakeholder</h4>
        	</div>
        	<div class="modal-body">
          		<div class="forward_wraping scrollingeffect timlineheight" id="ListNextApproversPPL"> </div>  
			</div>
			<div class="modal-footer text-center">
				<button type="button" id="SetAskApprovers" class="btn custom-btn" onclick="SetNextApprovers();">Submit</button>
				<button type="button" data-dismiss="modal" id="SetApproversClose" class="btn custom-btn-two-cancel">Close</button>
			</div>
		</div>      
    </div>
</div>
   
<!---Asking_process_Approvers ed--->


<!-- approval_doms st-->
<div id="additional_document" class="modal fade" role="dialog">
  <div class="modal-dialog modal-lg">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close close-round" data-dismiss="modal">
          <span class="close-icon">&times;</span>
        </button>
        <h4 class="modal-title">Additional Document</h4>
      </div>
      <div class="modal-body">
          <div class="additional_doms">
            <table class="table" id="tbAppDocs">
              <thead>
                  <tr>
                    <th style="width:20%; color:#333">Documents</th>
                    <th style="width:15%; color:#333">Purpose</th>
                    <th style="width:22%; color:#333">Remaks</th>
                    <th style="width:20%; color:#333">Uploaded by</th>
                    <th style="width:15%; color:#333">Step Name</th>
                    <th style="width:15%"></th>
                  </tr>
              </thead>
              <tbody id="tbdyAppDoc">
              <!--  <tr>
                    <td>
                      <div class="titlewrp">
                        <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/excel_file.png">
                        <p class="fileName" id="DocName" >Filt Title show here</p>
                      </div>
                    </td>
                    <td><p class="purpose_text" id="filePurpose">Lorem, ipsum dolor sit amet consectetur</p></td>
                    <td><p class="remarkmultilines" id="fileRemarks">Lorem ipsum, dolor sit amet consectetur adipisicing elit. Quis laudantium sunt accusantium, nemo quisquam itaque, assumenda totam placeat temporibus ducimus officia incidunt animi ea nulla enim reprehenderit, necessitatibus quam earum.</p>
                    </td>
                    <td>
                      <button type="button" class="custom-edit-btn">
                        <i class="fa fa-pencil"></i>
                      </button>
                      <button type="button" class="custom-edit-btn">
                        <i class="fa fa-trash-o"></i>
                      </button>
                    </td>
                  </tr>   -->
              </tbody>
            </table>
          </div>
          <div class="addbutton_area">
            <button type="button" class="btn custom-btn" data-toggle="modal" data-target="#Approval_doc">
              <span class="fa fa-plus"></span>
            </button>
          </div>
      </div>
     <div class="modal-footer" style="text-align: center; margin-top:0;">
        <button type="button" class="custom-btn-two-cancel" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
<!--- Additional Document ed--->


<!--Attachment modal -->
<div id="Approval_doc" class="modal fade" role="dialog" style="background:rgba(0,0,0,0.5);">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close close-round" data-dismiss="modal">
          <span class="close-icon">&times;</span>
        </button>
        <h4 class="modal-title">Additional Document</h4>
      </div>
      <div class="modal-body">
        
        <div class="wrapfildsinside">
          <label for="">File</label>
          <div class="fieldbx">
            <input type="file" name="" class="form-control" id="ApprovalDoc" multiple>
          </div>
        </div>
        
         <div class="wrapfildsinside">
          <label for="">Purpose</label>
          <div class="fieldbx">
            <input type="text" name="" class="form-control" id="DocPurpose">
          </div>
        </div>
        
        <div class="wrapfildsinside mangflexlabel">
          <label for="">Remarks</label>
          <div class="fieldbx">
            <textarea class="form-control" style="min-height:100px; resize:none;" id="docRemarks"></textarea>
          </div>
        </div>
		
		 <div class="wrapfildsinside mangflexlabel" style="display:none;">
          <label for="">Attach For</label>
          <div class="fieldbx">
            <select id="e_Signature_optis" class="form-control">
              <option value="supporting_document">Supporting Document</option>
              <option value="required_e_signature">Required e-signature</option>
            </select>
          </div>
        </div>
        
        <div class="action_signaturebx supporting_document" style="display:none;">
          <div class="wrapfildsinside mangflexlabel">
          	<label>Restricted Access</label>
          	<div class="fieldbx flexing_both">
          		<input type="checkbox" style="width:17px; height: 17px; margin-top:0;">
          	</div>
          </div>
          
          <div class="wrapfildsinside mangflexlabel" style="display:none;">
          	<label>Restricted at</label>
          	<div class="fieldbx flexing_both">
          		<select class="form-control" multiselect-search='true' multiselect-select-all='true'>
		          <option>opt</option>
		          <option>opt</option>
		        </select>
          	</div>
          </div>

        </div>
        
		<div class="action_signaturebx required_e_signature" style="margin-bottom:19px; display:none;">
		
        <div class="wrapfildsinside">
          <label for="">Signature of</label>
          <div class="fieldbx" id="DocSign">
          	
          	 <label class="radio-inline">
              <input type="radio" value="signatories" name="signatories_opt" checked id="AllSign"> All Signatories
            </label>
            
            <label class="radio-inline">
              <input type="radio" value="selective" name="signatories_opt" id="selectiveSign"> Selective
            </label>

          </div>
        </div>

        <div class="wrapfildsinside hideboxarea selective">
          <label for=""></label>
          <div class="fieldbx">
            <div class="dropdown fullwidth_dropdown">
              <button class="btn dropdown-toggle" type="button" data-toggle="dropdown" id="btnguestclient" aria-expanded="false">
                <span class="slectbox"></span>steps<span class="fa fa-angle-down" style="float:right;">
                </span>
              </button>
               <ul class="dropdown-menu" id="ddpStps">
              <!--    <li><input type="checkbox" value="all_select" id="selectallopts">All Select</li>
                  <li><input type="checkbox" class="checkboxallopt" name="">Step 1</li>
                  <li><input type="checkbox" class="checkboxallopt" name="">Step 2</li>
                  <li><input type="checkbox" class="checkboxallopt" name="">Step 3</li>
                  <li><input type="checkbox" class="checkboxallopt" name="">Step 4</li>	-->
                </ul>
             </div>
          </div>
        </div>

        <div class="wrapfildsinside mangflexlabel">
          <label for="">Signature in Footer</label>
          
          <div class="fieldbx flexing_both">
            <input type="checkbox" id="single_selecopt" style="width:17px; height: 17px; margin-top:0;">
            <div class="single_selecopt" style="display:none; width:100%;">
	            <select name="" class="form-control" style="margin-top:0" id="singleStpddp">
	              <option value="single select">single select</option>
	            </select>
	        </div>    
	      </div>
          
        </div>
        <div class="wrapfildsinside mangflexlabel">
          <label for="">Watermark</label>
          <div class="fieldbx flexing_both">
            <input type="checkbox" class="" style="width:17px; height: 17px; margin-top:0;" id="watermark_slect">
            <div class="watermark_slect" style="display:none; width:100%;">
            	<input type="text" class="form-control" placeholder="Approved" id="docWatermark">
            </div>
          </div>
        </div>
      
        <div class="wrapfildsinside mangflexlabel">
          <label for=""></label>
          <div class="fieldbx flexing_both">
            <label class="checkbox" style="width:100%;">
              <input type="checkbox" name="" style="width:17px; height: 17px; margin-top:0;">
              Show Approval History at Bottom
            </label>
          </div>
        </div>
        
      </div><!---action_signaturebx ed---->
        
      </div>
      <div class="modal-footer" style="text-align:center; margin-top:5px;">
        <button type="button" class="btn custom-btn" id="saveDoc" onclick="SaveApprovalDocs('New')">Submit</button>
        <button type="button" class="btn custom-btn" id="EditDoc" onclick="UpdateDoc()" style="display:none">Submit</button>
      </div>
    </div>

  </div>
</div>



<!-- process_action -->
<div id="process_action" class="modal fade" role="dialog">
  <div class="modal-dialog modal-lg">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close close-round" data-dismiss="modal">
          <span class="close-icon">&times;</span>
        </button>
        <h4 class="modal-title">Process</h4>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Process Name</label><span>:</span> <span style="color:#ff0000">*</span>
              <input type="text" class="form-control" placeholder="CHANGE REQUEST FORM"  id="txtProcessName">
            </div>
            <div class="form-group">
              <label>Process For</label><span>:</span> <span style="color:#ff0000">*</span>
              <input type="text" class="form-control" placeholder="CHANGE REQUEST FORM" id="txtProcessFor">
            </div>
            <div class="form-group">
              <label>Template Name</label><span>:</span> <span style="color:#ff0000">*</span>
              <input type="text" class="form-control" placeholder="CHANGE REQUEST FORM" id="txtTempName">
            </div>
            <div class="form-group">
              <label>Process Owner</label><span>:</span>
              <input type="text" class="form-control" id="txtProcessOwner">
            </div>
            <div class="form-group">
              <label>Published by</label><span>:</span>
              <input type="text" class="form-control" id="txtPublishby">
            </div>
            <div class="form-group">
              <label>Published on</label><span>:</span>
              <input type="text" class="form-control"  id="txtPublishOn">
            </div>
          </div><!---col-md6--->
          <div class="col-md-6">
            <div class="form-group">
              <label>Details</label><span>:</span>
              <textarea id="" cols="30" rows="10" style="resize: none" class="form-control" id="txtProcessDetails"></textarea>
            </div>
            <div class="form-group">
              <label>Instruction (if any)</label><span>:</span>
              <textarea id="" cols="30" rows="10" style="resize: none" class="form-control" id="txtProcessInst"></textarea>
            </div>
            <div class="form-group">
              <label>Prerequisite</label><span>:</span>
              <textarea id="" cols="30" rows="10" style="resize: none" class="form-control" id="txtProcessPre"></textarea>
            </div>

          </div><!--col-md-6--->
        </div>
      </div>
      <div class="modal-footer" style="text-align: center; margin:0; padding:10px;">
        <button type="button" class="btn custom-btn">OK</button>
      </div>
    </div>

  </div>
</div>

<!-- process_action ed -->


<!-- new_history -->
<div id="new_history" class="modal fade" role="dialog">
	<div class="modal-dialog widthajust">
		<div class="modal-content">
      		<div class="modal-header">
        		<button type="button" class="close close-round" data-dismiss="modal">
          			<span class="close-icon">&times;</span>
          		</button>
        		<h4 class="modal-title">History</h4>
      		</div>
      		<div class="modal-body scrollingeffect timlineheight">
      			<div class="timebox">
					<ul class="mainlst" id="AllHistory">
            			
					</ul>
        		</div>
      		</div>
     	</div>
	</div>
</div>
<!-- new_history -->






		<!--	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>  
				<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script> 
				<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" >    </script>      -->
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js">   </script>
	<!--	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script src="multple.js"></script>  
  		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script> -->
		<script src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/js/complex.min.js"></script>
		<script src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/js/math.js"></script>
		<script src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/ApprovalEntry/Common.js?v2"></script>
		<script src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/ApprovalEntry/bstable.js"></script>
		<script src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/ApprovalEntry/multiselect-dropdown.js"></script>
		<script src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/TemplateSetup/ProcessSteps_approvers.js?v14"></script>
		<script src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/ApprovalEntry/ApprovalTemplateTable.js?v12"></script>
		<script src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/ApprovalEntry/ApprovalTableData.js"></script>
		<script type="text/javascript" src="_layouts/15/clienttemplates.js"></script>  
    	<script type="text/javascript" src="_layouts/15/clientforms.js"></script>  
    	<script type="text/javascript" src="_layouts/15/clientpeoplepicker.js"></script>  
    	<script type="text/javascript" src="_layouts/15/autofill.js"></script>    
		
		


<script>
var NewAddedUser=[];	
var ConditionApplied = false;
var ActiveBtnStatus='Submit';
var ActiveSystemIP ='0';
var SignImage=[];
var finalImages = [];
var AskNextApproversARR=[];
$(document).ready(function () {
	$("form").attr('autocomplete', 'off');
	//ReviewedApproveRemark
	$('.EditDataApproveRemark').richText();
	$('.ReviewedApproveRemark').richText();
	$('.RevertRemarksText').richText();
	$('.RejectApproveRemark').richText();
	$('.StepsRemarks').richText();
	$('.ForwardRetMessage').richText();
	$('.RemarksApprovalContent').richText();
	
	
	var Passingtoken = '';
	$(".richText-toolbar").css("display", "none");
	if(window.location.href.indexOf("ApprovalRequestEntry")> -1) 
	{
		if(window.location.href.indexOf("?")> -1) 
    	{
    		Passingtoken = window.atob(titanForWork.getQueryStringParameter('Step'));
			if(Passingtoken == 'Process Steps')
			{
				var QueryDataStep =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,ForwardedUser/EMail,Approvers/EMail&$expand=ForwardedUser,Approvers&$filter=ID eq "+window.atob(titanForWork.getQueryStringParameter('StepID'))+" and Status eq 'Pending'";
				var QueryStepIdData = RequestGetdata(QueryDataStep);
				
				if(QueryStepIdData.length>0)
				{	
					var ExecutionStatus=false;
					if(QueryStepIdData[0].Approvers.__deferred != undefined)
					{
						alert("No stakeholder has been assigned.");
						window.location.replace("approvals.aspx");
					}
					else
					{						
						for(var m=0; m<QueryStepIdData[0].Approvers.results.length; m++)
						{
							if(QueryStepIdData[0].Approvers.results[m].EMail == _spPageContextInfo.userEmail )
							{
								ExecutionStatus=true;
								break;
							}
						}
						if(ExecutionStatus == false)
						{
							if(QueryStepIdData[0].Forwarded == true)
							{
								for(var m=0; m<QueryStepIdData[0].ForwardedUser.results.length; m++)
								{
									if(QueryStepIdData[0].ForwardedUser.results[m].EMail == _spPageContextInfo.userEmail )
									{
										ExecutionStatus=true;
										break;
									}
								}								
							}
						}						
						if(ExecutionStatus == true)
						{//debugger;
							getDynamicTemplateName();						
    						
    						var temp = window.atob(titanForWork.getQueryStringParameter('Template'));
    						$('input[name="selector"]').filter("[templateid='"+temp+"']").attr('checked', true);									
    				
							$.when(PageColomnsDisplay()).then(function(datarespo){
								CreateLabesDynamically(datarespo);						
							})					
							apendlogoandtemplate();
						}
						else
						{
							alert("You are not authorized user to perform required action.");
							window.location.replace("approvals.aspx");
						}
					}					
				}
				else
				{
					alert("The Action has been already performed.");
					window.location.replace("approvals.aspx");					
				}
			}
			else if(Passingtoken == 'Draft')
			{
				//$("#newRequestModal").modal();
				getDynamicTemplateName();						
				var temp = window.atob(titanForWork.getQueryStringParameter('Template'));
    			$('input[name="selector"]').filter("[templateid='"+temp+"']").attr('checked', true);									
				if(temp == '' || temp == null){
				$("#newRequestModal").modal();					
				}else{
				$.when(PageColomnsDisplay()).then(function(datarespo){
									CreateLabesDynamically(datarespo);						
					})					
				apendlogoandtemplate();
				}
			}else{
				$("#newRequestModal").modal();
				getDynamicTemplateName();						
			
			}
    	}
    }
    	
    $(".RevertStepsRadio").click(function(){
  		alert("The paragraph was clicked.");
	});
		
	$(function() {
		$("#file").on('change', function(e) {
			SignImage=[];
  			var fileNum = this.files.length, initial = 0;
 			$.each(this.files,function(idx,elm){
       			SignImage[finalImages .length]=elm;
			});
			console.log(SignImage);
			$(".custom-image-label").css("display", "none");
			$(".approval_image_preview").css("display", "block");
		});
	})

	$.getJSON("https://api.ipify.org/?format=json", function(e) {
		ActiveSystemIP = e.ip
	});

	$('#CLR-TextSignature').click(function(){
		ClearTextSignature();
	});
	
    $('#CLR-ImageSignature').click(function(){
		ClearImageSignature();
		SignImage=[];
		finalImages = [];
	});
	
	$('#CLR-DrawSignature').click(function(){
		ClearDrawSignature();
	});
		
	$('#Pre-Upload-List-Btn').click(function(){
		PreUploadSignList();
	});

	$("#gettemplatenameid").click(function () {
		
		//$('#overlaysearch').show();
		$('#loadertext').removeClass('hide');
		if($("input[name='selector']:checked").attr('templateid') != undefined)
		{	
			setTimeout(function () {		
			$.when(	PageColomnsDisplay()).then(function(datarespo){
				CreateLabesDynamically(datarespo);						
			})					
			apendlogoandtemplate();			
			AskingNextApprovers();
			$('#newRequestModal').modal('hide');
			$('#loadertext').addClass('hide');
			$('#overlaysearch').hide()
			}, 100);
			
			//$('#Onloader').hide();
			
			
		}
		else
		{
			alert('Select Process First.');
		}
	});
	
	// To Save draft request
	$("#savenewDraft").click(function () {
		//$('#overlaysearch').show();
		setTimeout(function () {		
		if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Initiation' || window.atob(titanForWork.getQueryStringParameter('Step')) == 'Draft')
    		{
				saverecordDraft();
		    }
		//$('#overlaysearch').hide()
		}, 100);
	})				
	// To Submit request			
	$("#savenewrequest").click(function () {
		
		if(window.location.href.indexOf("?")> -1) 
    	{
    		if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Initiation')
    		{
    			ActiveBtnStatus = 'Submit';
    			if(AskingApproverStatus == true)
    			{
    				$("#Asking_process_Approvers").modal('show');
    			}
    			else
    			{	//$('#overlaysearch').show();
    				//setTimeout(function () {		
					saverecord();
					//$('#overlaysearch').hide()
					//}, 100);
					
				}    			
    		}
    		else
    		{
    			var attr = $("#savenewrequest").attr('data-target');
				if (typeof attr !== 'undefined' && attr !== false) 
				{
					if(attr == '#approvalEditModal')
					{
						ActiveBtnStatus = 'Edit Data';
						$('#approvalEditModal').modal('show');  						
					}
					else
					{
						ActiveBtnStatus = 'Reviewed';
						$('#approvalReviewedModal').modal('show');  
					}
				}
				else
				{
					//$('#overlaysearch').show();
					ActiveBtnStatus = 'Submit';
					//setTimeout(function () {		
					saverecord();
					//$('#overlaysearch').hide()
					//}, 100);			
				}    			
    		}    			
    	}		
	});
		
		
	$("#RejectRequestSubmit").click(function () {
		ActiveBtnStatus = 'Reject';
		var RemarkText = $("#RejectApproveRemark").val();
		RemarkText = RemarkText.trim();
		//$('#overlaysearch').show();
		if($("#RejectApproveChkBox").prop('checked') == true)
		{
			if(RemarkText.length>15)
			{
				//$('#overlaysearch').show();
				//saverecord();
				//setTimeout(function () {	
					saverecord();
				//}, 100);					

			}
			else
			{
				alert("Enter your remarks for rejection (at least 5 char)!");	
				/*setTimeout(function () {	
					alert("Enter Rejected Remark Message!");
					$('#overlaysearch').hide()
					}, 100);					
				*/
			}
		}
		else
		{	
			alert("Select Rejected Checkbox!");
			/*setTimeout(function () {	
			alert("Select Rejected Checkbox!");
			$('#overlaysearch').hide()
			}, 100);*/					
		}
	});
		
	
	$("#ReviewedRequestSubmit").click(function () {
		
		AskNextApproversARR=[];
		var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,Approvers/Title,Approvers/EMail,ActionTakenby/Title,ActionTakenby/EMail,Author/Title,Author/EMail,AttachmentFiles&$expand=Approvers,ActionTakenby,Author,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"' and ApproverDecidingStep eq '"+window.atob(titanForWork.getQueryStringParameter('StepNo'))+"'&$orderby=Sequence_No asc";
		var QueryResult = RequestGetdata(Query);
		var ExStatus = false;
		if(QueryResult.length>0)
		{			
			for(var k=0; k<QueryResult.length; k++)
			{
				var StakeHolder = EnsureUserMulti($('#AskapprovalReviewedModal'+QueryResult[k].ID).children().children().attr('id'));
				if(StakeHolder.length>0)
				{    
					AskNextApproversARR.push({'StepName' : QueryResult[k].StepName, 'StepApprovers' : StakeHolder,'StepId':QueryResult[k].ID });							
				}
				if(StakeHolder.length == 0)
				{
					alert("Please enter "+QueryResult[k].StepName +" approvers.");
					ExStatus = false;
					break;
				}
				else
				{
					ExStatus = true;
					var EnsureActive = EnsureUserValidate($('#AskapprovalReviewedModal'+QueryResult[k].ID).children().children().attr('id'));
					if(EnsureActive.length>0)
					{
						for(var k=0; k<EnsureActive.length; k++)
						{
							var QueryResultCheckActive=[];
							if(EnsureActive[k].Type == 'Tenant')
							{
								var QueryCheckActive =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Employees')/items?$select=*&$filter=LogonName/EMail eq '"+EnsureActive[k].Email+"' and Status eq 'Active'";
									QueryResultCheckActive = RequestGetdata(QueryCheckActive);
							}
							else
							{
								var QueryCheckActive =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ExternalUsers')/items?$select=*&$filter=LoginName/EMail eq '"+EnsureActive[k].Email+"' and Status eq 'Active'";
									QueryResultCheckActive = RequestGetdata(QueryCheckActive);
							}
								
							if(QueryResultCheckActive.length>0)
							{
								ExStatus = true;
							}
							else
							{
								ExStatus = false;
								alert(EnsureActive[k].Name+ " is not a valid user");
								return false;
								break;
							}															
						}						
					}					
				}					
			}
		}
		else
		{
			ExStatus = true;
		}
		//$('#overlaysearch').show();
		if(ExStatus == true)
		{
			ActiveBtnStatus = 'Reviewed';
			var RemarkText = $("#ReviewedApproveRemark").val();
				RemarkText = RemarkText.trim();
			if($("#ReviewedApproveChkBox").prop('checked') == true)
			{
				//setTimeout(function () {
				saverecord();
				//$('#overlaysearch').hide()
				//}, 100);					

			}
			else
			{	//setTimeout(function () {
				alert("Select Reviewed Checkbox!");
				//$('#overlaysearch').hide()
				//}, 100);					
			}
		}
	});
		
		
	$("#EditDataRequestSubmit").click(function () {
		AskNextApproversARR=[];
		var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,Approvers/Title,Approvers/EMail,ActionTakenby/Title,ActionTakenby/EMail,Author/Title,Author/EMail,AttachmentFiles&$expand=Approvers,ActionTakenby,Author,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"' and ApproverDecidingStep eq '"+window.atob(titanForWork.getQueryStringParameter('StepNo'))+"'&$orderby=Sequence_No asc";
		var QueryResult = RequestGetdata(Query);
		var ExStatus = false;
		if(QueryResult.length>0)
		{
			
			for(var k=0; k<QueryResult.length; k++)
			{
				var StakeHolder = EnsureUserMulti($('#AskapprovalEditModal'+QueryResult[k].ID).children().children().attr('id'));
				if(StakeHolder.length>0)
				{    
					AskNextApproversARR.push({'StepName' : QueryResult[k].StepName, 'StepApprovers' : StakeHolder,'StepId':QueryResult[k].ID });							
				}
				if(StakeHolder.length == 0)
				{
					alert("Please enter "+QueryResult[k].StepName +" approvers.");
					ExStatus = false;
					break;
				}
				else
				{
					ExStatus = true;
					var EnsureActive = EnsureUserValidate($('#AskapprovalEditModal'+QueryResult[k].ID).children().children().attr('id'));
					if(EnsureActive.length>0)
					{
						for(var k=0; k<EnsureActive.length; k++)
						{
							var QueryResultCheckActive=[];
							if(EnsureActive[k].Type == 'Tenant')
							{
								var QueryCheckActive =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Employees')/items?$select=*&$filter=LogonName/EMail eq '"+EnsureActive[k].Email+"' and Status eq 'Active'";
									QueryResultCheckActive = RequestGetdata(QueryCheckActive);
							}
							else
							{
								var QueryCheckActive =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ExternalUsers')/items?$select=*&$filter=LoginName/EMail eq '"+EnsureActive[k].Email+"' and Status eq 'Active'";
									QueryResultCheckActive = RequestGetdata(QueryCheckActive);
							}
								
							if(QueryResultCheckActive.length>0)
							{
								ExStatus = true;
							}
							else
							{
								ExStatus = false;
								alert(EnsureActive[k].Name+ " is not a valid user");
								return false;
								break;
							}															
						}						
					}
				}					
			}
		}
		else
		{
			ExStatus = true;
		}
		//$('#overlaysearch').show();
		if(ExStatus == true)
		{
			ActiveBtnStatus = 'Edit Data';
			var RemarkText = $("#EditDataApproveRemark").val();
				RemarkText = RemarkText.trim();
			if($("#EditDataApproveChkBox").prop('checked') == true)
			{
				//setTimeout(function () {
				saverecord();
				//$('#overlaysearch').hide()
				//}, 100);					

			}
			else
			{	
				//setTimeout(function () {
				var ChkText = $("#ChkText").text();
				ChkText = 'Select '+ChkText+' Checkbox!';
				alert(ChkText);
				//$('#overlaysearch').hide()
				//}, 100);					

			}
		}
	});

	
	$("#attachmentsupload").on('change', function (e) {
		bindAttachments(this,'Docfilename');
	});
	$("#supporting_doc_files").on('change', function (e) {
		bindAttachments(this,'DocfilenameAction');
	});
		

});
			
			
var pagenumbers = "";
function getDynamicTemplateName()
{	
	//var Dept = getUserDept();
	var QueryReq = '';
	if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Process Steps')
	{
		QueryReq = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessMaster')/items?$select=ConditionApplied,Id,Title,ProcessType,RequestFor,FileIcon,TemplateName,Active&$filter=ProcessType eq 'Process' and Id eq '"+window.atob(titanForWork.getQueryStringParameter('Template'))+"'"; 
	}
	else
	{
		var QueryDataGroup =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApproversGroups')/items?$select=*,Approvers/Title,Approvers/EMail&$expand=Approvers&$filter=Approvers/EMail eq '"+_spPageContextInfo.userEmail+"'";
		var QueryGroupsData = RequestGetdata(QueryDataGroup);
		
		var NewQuery='';
		if(QueryGroupsData.length>0)
		{
			for(var e=0; e<QueryGroupsData.length; e++)
			{
				if(e == 0)
				{
					NewQuery = NewQuery + " or (Initiation eq 'Group' and (Group/ID eq '"+QueryGroupsData[e].ID+"'";
				}
				else
				{
					NewQuery = NewQuery + " or Group/ID eq '"+QueryGroupsData[e].ID+"'";
				}
			
			}		
			NewQuery = NewQuery + '))';
		}
		QueryReq = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessMaster')/items?$select=ConditionApplied,Id,Title,ProcessType,RequestFor,FileIcon,TemplateName,Active&$filter=Active eq '1' and ProcessType eq 'Process' and (Initiation eq 'Anyone' or (Initiation eq 'Employee' and Company/Id eq '"+titanForWork.getQueryStringParameter('CompanyId')+"') or (Initiation eq 'Selective' and Initiators/EMail eq '"+_spPageContextInfo.userEmail+"') or (Initiation eq 'Office' and OfficeLocation/Id eq '"+Logged_Location+"') or (Initiation eq 'Department' and Department/Id eq '"+Logged_DepartmentId+"'))"+NewQuery+"&$orderby=RequestFor asc"; 
		//QueryReq = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessMaster')/items?$select=Id,Title,ProcessType,RequestFor,FileIcon,TemplateName,Active&$filter=Active eq '1' and ProcessType eq 'Process' and (Initiation eq 'Anyone' or Initiation eq 'Employee' or Initiation eq 'Group' or (Initiation eq 'Selective' and Initiators/EMail eq '"+_spPageContextInfo.userEmail+"') or (Initiation eq 'Office' and OfficeLocation/Id eq '"+Logged_Location+"') or (Initiation eq 'Department' and Department/Id eq '"+Logged_DepartmentId+"')"+NewQuery+")&$orderby=RequestFor asc"; 
	}
	$.ajax({
	async: false,
	url:QueryReq,
	//url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessMaster')/items?$select=Id,Title,ProcessType,RequestFor,FileIcon,TemplateName,Active&$filter=Active eq '1' and ProcessType eq 'Process' and (Initiation eq 'Anyone' or Initiation eq 'Employee' or Initiation eq 'Employee' or (Initiation eq 'Selective' and Initiators/EMail eq '"+_spPageContextInfo.userEmail+"') or (Initiation eq 'Office' and Initiators/EMail eq '"+_spPageContextInfo.userEmail+"') or (Initiation eq 'Department' and Department/Id eq '"+Dept+"'))",
	//url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessMaster')/items?$select=Id,Title,ProcessType,RequestFor,FileIcon,TemplateName,Active&$filter=Active eq '1' and ProcessType eq 'Process' ",
	type: "GET",
	headers: {
		"accept": "application/json;odata=verbose",
		},
	success: function (data) 
	{
		$("#GroupTemplates").empty().append($('<option></option>').val("-ALL-").html("-ALL-"));
		const items = data.d.results;		
		var uniqueOb = {}
		var uniqueArray = items.filter(obj => !uniqueOb[obj.TemplateName] && (uniqueOb[obj.TemplateName] = true));		
		var incrementidnum = 0;
		var uniqueArrayGroup = uniqueArray.filter(function (filterData) {			
			return filterData.Initiation == 'Group'
	    });	
	    var uniqueArrayEmpl = uniqueArray.filter(function (filterData) {			
			return filterData.Initiation == 'Employee'
	    });	
		if(uniqueArray.length == 0){
			$("#TemplatedBinding1").html('No process found!');
			//setTimeout('window.location.replace("approvals.aspx")',2000);
		}else{
			$.each(uniqueArray, function (i, value) {
				incrementidnum++;
				var iconurl = "";
				if (value.FileIcon != null && value.FileIcon != undefined && value.FileIcon != "") 
				{
					iconurl += value.FileIcon['Url'] ? value.FileIcon['Url'] : "";
				}
				if(value.ProcessType == 'Document')
				{
					iconurl += 'https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/default.png'
				}
				
				var ConditionApplied = value.ConditionApplied;
				if(value.ConditionApplied == null || value.ConditionApplied == false)
				{
					ConditionApplied = false;
				}
				
				var template = "<li class='col-md-4 col-sm-6 col-xs-12 new-request-panel'>\
									<div class='new-request-panel-card new-process-panel-group'>\
										<div class='panel panel-default radio-container'>\
											<input type='radio' id='new-process-option"+ incrementidnum + "' requestfor='"+value.RequestFor+"' templateid='"+value.Id+"' value='" + value.TemplateName + "' name='selector' hreflang='"+ConditionApplied+"'>\
											<label for='new-process-option"+ incrementidnum + "'></label>\
												<div class='check'></div>\
												<div class='panel-heading panel-heading-checked'>\
													<h4 class='panel-title'>\
														<div>\
															<div class='new-request-top-left'>\
																<div class='new-request-top-left-img'>\
																	<img src='"+ iconurl + "' alt='process'>\
																</div>\
																<div class='new-request-top-left-text'>\
																	<div class='new-request-top-left-title ellipsis-1 mb10'>"+ value.Title + "</div>\
																	<div class='new-request-top-left-title-pera ellipsis-1'>"+ value.TemplateName + "</div>\
																	<div class='new-request-top-left-title-pera ellipsis-1'><span>"+ value.RequestFor+ "</span></div>\
																</div>\
															</div>\
														</div>\
													</h4>\
												</div>\
											</div>\
										</div>\
									</li>";
				if (value.TemplateName) 
				{
					$("#TemplatedBinding1").append(template);
				}
			});
			
			if(uniqueArray.length>0)
			{
				uniqueArray.sort(function(a,b){return a.RequestFor< b.RequestFor? -1 : 1});
				for(var e=0; e<uniqueArray.length; e++)
				{
					$("#GroupTemplates").append($('<option></option>').val(uniqueArray[e].RequestFor).html(uniqueArray[e].RequestFor));
				}			
			}
		  }
		},
		error: function (error) 
		{
		}
	});
}


var ischeckk = false;
function saverecord() 
{	
	//$('#overlaysearch').show();
	var requiredfileds = [];
	var nonrequiredfileds =[];
	var datacreate = "";
	var intarr = $("input[name='selector']:checked").attr('templateid');
	var nu = parseInt(intarr);
	var requestforstring = $("input[name='selector']:checked").attr('requestfor'); 
	var requestTile = $('#titleid').text();
	var itemProperties = {};
		itemProperties['RequestFor'] = requestforstring;
		itemProperties['Title'] = requestTile;
		itemProperties['TemplateIDId'] = nu;
	ischeckk = false;
	var fileData = [];
	$("#appenddyamicboxes > .dynamicdatatexboxes.active").each(function () {
	var key = $(this).find(".columnnametxt.active").attr("value");
	//itemProperties[key] = $(this).find(".dynamicvalfeachcls").val();
	var vval = '';	
	if(key  == 'ColumnPeople1' || key  == 'ColumnPeople2' || key  == 'ColumnPeople3' || key  == 'ColumnPeople4'|| key  == 'ColumnPeople5'){
		var EntityUsers= [];
		var peoplePickerDiv = $("[id$='"+key+"_TopSpan']"); 
		var peoplePicker = SPClientPeoplePicker.SPClientPeoplePickerDict[peoplePickerDiv[0].id]; 
		var users = peoplePicker.GetAllUserInfo()				
		for (var j = 0; j < users.length; j++) 
		{	var flag=false;
		/*	var arrUSer = AllTaskUsersEmployeeuser.filter(function (filterData) {
			if(filterData.EMail == users[j].EntityData.Email){flag=true;}
			return filterData.EMail == users[j].EntityData.Email;
	    	});	*/
	    	var QueryCheckActive = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Employees')/items?$select=LogonName/Id,LogonName/Title,Email&$expand=LogonName&$filter=Email eq '"+users[j].EntityData.Email+"' and Status eq 'Active'";
			var arrUSer = RequestGetdata(QueryCheckActive);
			if(arrUSer.length > 0){
				if(arrUSer[0].Email == users[j].EntityData.Email){flag=true;}					
				if(!flag){alert("Selected user "+users[j].DisplayText+" not in list"); return false;}			    
		    	EntityUsers.push(arrUSer[0].LogonName.Id)	    
	    	}
		}
		vval = EntityUsers;
	}else if(key  == 'Checkbox1' || key  == 'Checkbox2' || key  == 'Checkbox3' || key  == 'Checkbox4'|| key  == 'Checkbox5'){
	 	vval = $(this).find(".combine_box_adds .dynamicvalfeachcls.active").prop('checked')
	}else{
		vval = $(this).find(".dynamicvalfeachcls.active").val()
	//	vval = vval.toString();
	}
	if($(this).find(".dynamicvalfeachcls.active").attr('type') == 'file'){
		var lbl = $(this).find(".columnnametxt.active").attr("alerttext");
		var fileInput = jQuery('#'+key);
		if(vval != ''){
			fileData.push({'filename' : vval,'purpose': lbl,'Remarks' : '', 'SignOf': 'No Signature','col' : key, 'ddpmulstp': '', 'SingleStpval':'', 'singleslct': false, 'watermrk' : false ,'watermrkval' : '','File' : fileInput[0].files[0]}) ;
		}
	//	ApprovalDocs.push({'filename' : fileName, 'purpose':purpose, 'Remarks' : Remarks, 'SignOf': SignOf, 'ddpmulstp': ddpmulstp, 'SingleStpval':SingleStpval, 'singleslct': singleslct, 'watermrk' : watermrk ,'watermrkval' : watermrkval})
	}
	if ($(this).find(".columnnametxt.active").attr("mandatorycol") != "true" && vval == "") 
	{
		var dyanmicvalhtml = $(this).find(".columnnametxt.active").attr('alerttext');
		nonrequiredfileds.push(dyanmicvalhtml);
	}		  
	else
	{
		if(key  == 'ColumnPeople1' || key  == 'ColumnPeople2' || key  == 'ColumnPeople3' || key  == 'ColumnPeople4'|| key  == 'ColumnPeople5'){
			var EntityUsers= [];				
			itemProperties[key+'Id'] = {"results": vval }; //vval = EntityUsers;
		}else{
			if($(this).find(".combine_box_adds .dynamicvalfeachcls.active").attr('type') == 'checkbox'){
				itemProperties[key]= vval; //$(this).find(".combine_box_adds .dynamicvalfeachcls.active").prop('checked')
			}
			//itemProperties[key] = $(this).find(".dynamicvalfeachcls.active").val();			
		/*	if(key == 'YesNo'){
				if($(this).find(".dynamicvalfeachcls.active").val() == "Yes")
				{
					itemProperties[key] = true;
				}
				else if($(this).find(".dynamicvalfeachcls.active").val() == "No")
				{
					itemProperties[key] = false;
				}
			}	*/
			else
			{
				var val = '';				
				val = $(this).find(".dynamicvalfeachcls.active").val();				
				if(val == '' || val == null)
				{
					itemProperties[key] = ''; //$(this).find(".dynamicvalfeachcls").val();
				}
				else
				{
					itemProperties[key] = val.toString();
				}
			}
			}
			if ($(this).find(".columnnametxt.active").attr("mandatorycol") == "true" && (vval == "" || vval == undefined)) 
			{
				var dyanmicvalhtml = $(this).find(".columnnametxt.active").attr('alerttext');
				requiredfileds.push(dyanmicvalhtml);
			}
			if(arrNumVal.length>0)	{
							for(a=0;a<arrNumVal.length;a++){
							if($(this).find(".dynamicvalfeachcls.active").val() != ''){
								if(key == arrNumVal[a].col){
									if(arrNumVal[a].min != null &&  arrNumVal[a].max != null){																	
										if($(this).find(".dynamicvalfeachcls.active").val() >= arrNumVal[a].min && $(this).find(".dynamicvalfeachcls.active").val() <= arrNumVal[a].max){
											itemProperties[key] = $(this).find(".dynamicvalfeachcls.active").val();
										}else{
											alert(arrNumVal[a].title+' should be between '+ arrNumVal[a].min +' to '+ arrNumVal[a].max);
											ischeckk =  true; return false;break;
										}
									}else if(arrNumVal[a].min != null && arrNumVal[a].max == null ){
										if($(this).find(".dynamicvalfeachcls.active").val() >= arrNumVal[a].min){
											itemProperties[key] = $(this).find(".dynamicvalfeachcls.active").val();
										}else{
											alert(arrNumVal[a].title+' should be greater than '+ arrNumVal[a].min );
											ischeckk =  true; return false;break;
										}									
									}else if(arrNumVal[a].min == null && arrNumVal[a].max != null ){
										if($(this).find(".dynamicvalfeachcls.active").val() <= arrNumVal[a].max){
											itemProperties[key] = $(this).find(".dynamicvalfeachcls.active").val();
										}else{
											alert(arrNumVal[a].title+' should be less than  '+ arrNumVal[a].max );											
											ischeckk =  true; return false;break;
										}									
									}else if(arrNumVal[a].min == null && arrNumVal[a].max == null ){
										itemProperties[key] = $(this).find(".dynamicvalfeachcls.active").val();
									}
									
								}
								}
							}						
						}
			}
			if(ischeckk){return false;alert(ischeckk);}		  
		})
		if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Initiation')
    	{
    	$("#appenddyamicboxes > .dynamicdatatexboxes.AutoFilled").each(function () {
			var key = $(this).find(".columnnametxt.AutoFilled").attr("value");
		//	for(i=0;i<AutoFilledCols.length;i++){
				if(key  == 'ColumnPeople1' || key  == 'ColumnPeople2' || key  == 'ColumnPeople3' || key  == 'ColumnPeople4'|| key  == 'ColumnPeople5'){
					var EntityUsers= [];
					var peoplePickerDiv = $("[id$='"+key+"_TopSpan']"); 
					var peoplePicker = SPClientPeoplePicker.SPClientPeoplePickerDict[peoplePickerDiv[0].id]; 
					var users = peoplePicker.GetAllUserInfo()				
					for (var j = 0; j < users.length; j++) 
					{	var flag=false;
					/*	var arrUSer = AllTaskUsersEmployeeuser.filter(function (filterData) {
						if(filterData.EMail == users[j].EntityData.Email){flag=true;}
						return filterData.EMail == users[j].EntityData.Email;
				    	}); */
				    var QueryCheckActive = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Employees')/items?$select=LogonName/Id,LogonName/Title,Email&$expand=LogonName&$filter=Email eq '"+users[j].EntityData.Email+"' and Status eq 'Active'";
					var arrUSer = RequestGetdata(QueryCheckActive);
					if(arrUSer[0].Email == users[j].EntityData.Email){flag=true;}					
				    
					if(!flag){alert("Selected user "+users[j].DisplayText+" not in list"); return false;}			    
				    EntityUsers.push(arrUSer[0].LogonName.Id)	    
					}
					itemProperties[key+'Id'] = {"results": EntityUsers};
				}else{
					if(key  == 'Checkbox1' || key  == 'Checkbox2' || key  == 'Checkbox3' || key  == 'Checkbox4'|| key  == 'Checkbox5'){
					 	itemProperties[key] = $(this).find(".combine_box_adds .dynamicvalfeachcls.AutoFilled").prop('checked')
					}else
					//if(key == AutoFilledCols[i].ColName){
						itemProperties[key] = $(this).find(".dynamicvalfeachcls.AutoFilled").val();
					//}
				}
		//	}		
		})
		$("#appenddyamicboxes > .dynamicdatatexboxes:not(.active)").each(function () {
			var key = $(this).find(".columnnametxt:not(.active)").attr("value");
			for(i=0;i<AutoFilledCols.length;i++){
				if(key  == 'ColumnPeople1' || key  == 'ColumnPeople2' || key  == 'ColumnPeople3' || key  == 'ColumnPeople4'|| key  == 'ColumnPeople5'){
					var EntityUsers= [];
					var peoplePickerDiv = $("[id$='"+key+"_TopSpan']"); 
					var peoplePicker = SPClientPeoplePicker.SPClientPeoplePickerDict[peoplePickerDiv[0].id]; 
					var users = peoplePicker.GetAllUserInfo()				
					for (var j = 0; j < users.length; j++) 
					{	var flag=false;
					/*	var arrUSer = AllTaskUsersEmployeeuser.filter(function (filterData) {
						if(filterData.EMail == users[j].EntityData.Email){flag=true;}
						return filterData.EMail == users[j].EntityData.Email;
				    	}); */
				    var QueryCheckActive = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Employees')/items?$select=LogonName/Id,LogonName/Title,Email&$expand=LogonName&$filter=Email eq '"+users[j].EntityData.Email+"' and Status eq 'Active'";
					var arrUSer = RequestGetdata(QueryCheckActive);
					if(arrUSer[0].Email == users[j].EntityData.Email){flag=true;}					
				    
					if(!flag){alert("Selected user "+users[j].DisplayText+" not in list"); return false;}			    
				    EntityUsers.push(arrUSer[0].LogonName.Id)	    
					}
					itemProperties[key+'Id'] = {"results": EntityUsers};
				}else{
					if(key  == 'Checkbox1' || key  == 'Checkbox2' || key  == 'Checkbox3' || key  == 'Checkbox4'|| key  == 'Checkbox5'){
					 	itemProperties[key] = $(this).find(".combine_box_adds .dynamicvalfeachcls").prop('checked')
					}else
					if(key == AutoFilledCols[i].ColName){
						itemProperties[key] = $(this).find(".dynamicvalfeachcls").val();
					}
				}
			}		
		})	}
		if(ischeckk){return false;alert(ischeckk);}	
		else{	
		var itemType = "SP.Data.ApprovalProcessListListItem";
		itemProperties["__metadata"] = { "type": itemType };
		if (requiredfileds.length > 0) 
		{
			for (let i = 0; i < requiredfileds.length; i++) 
			{
				alert("Please enter the value for " + requiredfileds[i] + "");
				$('#overlaysearch').hide();
				break;
				
			}					
		} 
		else 
		{
			validateTable();
			if(window.location.href.indexOf("?")> -1) 
    		{
    			if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Initiation')
    			{	setTimeout(() => {
					if(isValid){
					savedata(JSON.stringify(itemProperties),fileData);			    									
					}
					}, 100);
				}
				else if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Process Steps')
				{
					setTimeout(() => {
					if(isValid){
					var RecId = window.atob(titanForWork.getQueryStringParameter('RecNo'));	    		
					updateData(itemProperties, RecId,'', fileData);						
					}
					}, 100);
				}
			}
		}
		}
	}
	

	var savedata = function (data,fileData) 
	{
		var dfd = $.Deferred()
		$.ajax({
			url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('ApprovalProcessList')/items",
			type: "POST",
			async: false,
			headers: {
				"accept": "application/json;odata=verbose",
				"X-RequestDigest": $("#__REQUESTDIGEST").val(),
				"IF-MATCH": "*",						
				"content-Type": "application/json;odata=verbose"
			},
			data: data,
				/*where Title is column name and you can add more columns by splitting with ,*/
			success: function (data) 
			{
			//	if ($('#attachmentsupload').val() == "") 
			//	{
					var NewlyCreatedItemId = data.d.ID;
					SubmitTbltcols(NewlyCreatedItemId );					
					if(fileData.length > 0){
					/*	var file = $('#' + fileData[0].col);
						var checkfile = CheckFileSize(file);
						if(checkfile){
						ApprovalDocsUpload(NewlyCreatedItemId, fileData, fileData[0].col);
						}*/
						ApprovalDocsUpload(NewlyCreatedItemId, fileData, '');
					}
					if(ApprovalDocs.length > 0){
						ApprovalDocsUpload(NewlyCreatedItemId, AllDocs, '');
					}
					if(ischeck ==  false && ischeckk ==  false)
					{
						if(SavedStpApprovers.length > 0)
						{
							if(ConditionApplied == true)
							{
								AdvanceQueeGenerateProcess('',NewlyCreatedItemId);								
							}
							else
							{
								setTimeout(() => {
									$.when(SaveApproverQueue(NewlyCreatedItemId)).then(function (ProcessListResult) {							      					   																 								
										console.log('Queues created');
									});
								}, 1000);
							
							}
						}
						else
						{//debugger;
							//alert('The approval request has been submitted successfully.');
							alert('Data has been submitted successfully.');
							$('#overlaysearch').hide();
							window.location.replace("approvals.aspx");
						}
					}
			//	}
				if ($('#attachmentsupload').val() == "")
					return;						
			/*	var fileInput = jQuery('#attachmentsupload');
				var fileCount = fileInput[0].files.length;
				console.log(fileCount);
				var filecountset = 0;
				for (var i = 0; i < fileCount; i++) 
				{
					var fileName = fileInput[0].files[i].name;
					var extn = getExtension(fileName);
					if(!returnExtension(extn)){
					filecountset++;
					console.log(i);
						getFileBuffer(i,'attachmentsupload')
						.done(function (arrayBuffer, index) {
							console.log("Success " + index);
							uploadFileSP("ApprovalProcessList", data.d.Id, arrayBuffer, index, 'attachmentsupload');
						})
						.fail(function (error) {
							console.log(error);
							LogError("uploadFile", error);
							alert("Error while uploading file for ID" + id);
						});
						if (fileCount == filecountset) 
						{
							var NewlyCreatedItemId = data.d.ID;
							if(ischeck ==  false && ischeckk ==  false)
							{
							SubmitTbltcols(NewlyCreatedItemId );
							if(SavedStpApprovers.length > 0)
							{
								$.when(SaveApproverQueue(NewlyCreatedItemId)).then(function (ProcessListResult) {							      					   																								
									console.log('Queues created');
								}); 							
							}
							else
							{
								alert('The approval request has been submitted successfully.');
							 	window.location.replace("approvals.aspx");
							}
							}
						}
					}else{
					alert(fileName + ' extention is invalid, please select another file.');
					return false;
					}
				}		*/			
			},
			error: function (error) 
			{
				alert(JSON.stringify(error));
			}
		});
	}
			
var ActiveQueeNo='';
var NextActiveQueeNo='';
var ExistingSignedImage='';
	
var updateData = function (data,Id,ConditionData,fileData) 
{
	Id = parseInt(Id);
	var ExStatus = true;
	if(ConditionApplied == true)
	{
		ExStatus = AdvanceQueeGenerateProcess(data,Id);
	}
	
	if(ExStatus != false)
	{
		var dfd = $.Deferred()
		$.ajax({
			url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('ApprovalProcessList')/items("+Id+")",
			type: "PATCH",
			async: false,
			headers: {
				"accept": "application/json;odata=verbose",
				"X-RequestDigest": $("#__REQUESTDIGEST").val(),
				"X-Http-Method": "PATCH",
				"If-Match": "*",
				"content-Type": "application/json;odata=verbose"
			},
			data: JSON.stringify(data),
			/*where Title is column name and you can add more columns by splitting with ,*/
			success: function (data) 
			{
				var ConditionData = [];
				ModifyProcessListDataSPLCase(ConditionData,Id);
				
				ModifyProcessQueue();
				
					
			//	if ($('#attachmentsupload').val() == "" && $('#supporting_doc_files').val() == "") 
			//	{
					//var NewlyCreatedItemId = data.d.ID;					
					UpdateTableData();
					if(newApprovalDocs.length > 0){
						ApprovalDocsUpload(Id, newApprovalDocs, '');
					}
					if(fileData.length > 0){
					/*	var file = $('#' + fileData[0].col);
						var checkfile = CheckFileSize(file);
						if(checkfile){
						ApprovalDocsUpload(Id, fileData, fileData[0].col);
						}*/
						ApprovalDocsUpload(Id, fileData, '');
					}
					if(ischeck ==  false && ischeckk ==  false)
					{
						if(SavedStpApprovers.length > 0)
						{
							setTimeout(() => {
							if(AskNextApproversARR.length>0)
							{
								SetUpNextAskQueeApprovers();
							}							
							console.log(SavedStpApprovers);							
						 	console.log('Updated');
						 	$('#overlaysearch').hide();
						 	alert('Data has been updated successfully.');
						 	window.location.replace("approvals.aspx");
						 	}, 1000);
						}
					}
			//	}
				
				if ($('#attachmentsupload').val() == "" && $('#supporting_doc_files').val() == "")
				return;	
			/*	Passingtoken = window.atob(titanForWork.getQueryStringParameter('Step'));
				var id = '';
				if(Passingtoken == 'Initiation')
				{
					var fileInput = jQuery('#attachmentsupload');
					id = 'attachmentsupload';
				}
				else
				{
					var fileInput = jQuery('#supporting_doc_files');
					id = 'supporting_doc_files';
				}
				var fileCount = fileInput[0].files.length;
				var filecountset = 0;
				if(fileCount.length>0)
				{
					for (var i = 0; i < fileCount; i++) 
					{
						filecountset++;
						console.log(i);
						getFileBuffer(i,id)
						.done(function (arrayBuffer, index) {
							console.log("Success " + index);
							//uploadFileInList(arrayBuffer, id, index);
							uploadFileSP("ApprovalProcessQueue", StepId, arrayBuffer, index, id);
						})
						.fail(function (error) {
							console.log(error);
							LogError("uploadFile", error);
							alert("Error while uploading file for ID" + id);
						});
						if (fileCount == filecountset) 
						{
							alert("Details are saved successfully.");
							window.location.replace("approvals.aspx"); //location.reload();
						}
					}
				}
				else
				{
					alert("Details are saved successfully.");
					window.location.replace("approvals.aspx"); //location.reload();
				} */
			},
			error: function (error) 
			{
				alert(JSON.stringify(error));
			}
		});
	}
	else
	{
		//alert("Details are saved successfully.");
		alert("Details are saved successfully.");
		$('#overlaysearch').hide();
		window.location.replace("approvals.aspx"); 
	}
}


var GetImageBuffer = function (SignImage) 
{
	var deferred = $.Deferred();
	var reader = new FileReader();
	reader.onload = function (e) 
	{
   		deferred.resolve(e.target.result);
	}
	reader.onerror = function (e) 
	{
		deferred.reject(e.target.error);
	}
	reader.readAsArrayBuffer(SignImage);
	return deferred.promise();
};

			
	var xRequestDigest = $("#__REQUESTDIGEST").val();
	function uploadattachment(id) 
	{
		if(SignImage.length>0)
		{
		    $.each(SignImage, function(index, value){
			    GetImageBuffer (value).then(function (buffer) {
			     	var OrginalFileName = value.name;
			    	var ModifiedFileName = OrginalFileName.replace(/[^.a-zA-Z0-9]/ig,"");
				    $.ajax({
						url: _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items(" + id + ")/AttachmentFiles/add( FileName='" + ModifiedFileName + "')",
				    	method: 'POST',
				    	data: buffer,
				    	async: false,
	    				processData: false,
	    				headers: 
	    				{
	    	  				"Accept": "application/json;odata=verbose",
	    	  				"content-type": "application/json;odata=verbose",
	    	  				"X-RequestDigest": xRequestDigest
	    				},
	    				success: function (data)
	    				{ 
	    					console.log("Image Upload");
	    					if(ExistingSignedImage != '')
	    					{
	    						DeleteItemAttachment(id, ExistingSignedImage);
	    					} 
	    				},
	    				error: function (data) 
	    				{
	    					console.log(data);
	    		  			//alert(data.responseText);
	    				}
	    			});
				});
			});
		}
	}
	
	
	function DeleteItemAttachment(ItemId, FileTitle) 
	{  
		var Dfd = $.Deferred();  
    	var Url = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('ApprovalProcessQueue')/GetItemById(" + ItemId + ")/AttachmentFiles/getByFileName('" + FileTitle + "')  ";  
    	$.ajax({  
			url: Url,  
			type: 'DELETE',  
    	    contentType: 'application/json;odata=verbose',  
    	    headers: {  
    	    	'X-RequestDigest': $('#__REQUESTDIGEST').val(),  
    	    	'X-HTTP-Method': 'DELETE',  
    	        'Accept': 'application/json;odata=verbose'  
			},  
    	    success: function (data) 
    	    {  
				Dfd.resolve(data);
				console.log('Old Signed Image Delete.')  
			},  
        	error: function (error) 
        	{  
				Dfd.reject(JSON.stringify(error));  
        	}  
		});  
    	return Dfd.promise();  
	}

	
	function UniversalUpdateApprovalProcess(listName,item,dataid,SiteUrl)  
	{
		var ActionListStatus=false;
    	var Responce="";
    	$.ajax({  
    	    url: SiteUrl,//_spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('"+listName+"')/items('"+dataid+"')",
    	    type: "POST",  
    	    async:false,
    	    data: JSON.stringify(item),         
    	    headers:  
    	    {  
    	        "Accept": "application/json;odata=verbose",  
    	        "Content-Type": "application/json;odata=verbose",  
    	        "X-RequestDigest": $("#__REQUESTDIGEST").val(),  
    	        "IF-MATCH": "*",  
    	        "X-HTTP-Method": "MERGE"  
    	    },  
    	    success: function(data)
    	    { 	
    	    	ActionListStatus=true;        	
    	    },  
    	    error: function(data) 
    	    {  
    	        Responce=data;
    	        console.log("Error in UniversalUpdate.");
    	    	console.log(data);  
    	    }  
    	}); 
    	return ActionListStatus;    
	}
			
	var TemplateLoaded = false;		
	function apendlogoandtemplate() 
	{
		TemplateLoaded = false; 
		var templatename = $("input[name='selector']:checked").val();
		var templateID =  $("input[name='selector']:checked").attr('templateid')
		if(templatename != undefined){TemplateLoaded = true;}
		GetData("/_api/web/lists/getbytitle('ApprovalProcessMaster')/items?$select=*,TemplateName&$filter=Id eq '" + templateID + "'").done(function (templatename) {

			$("#titleid").empty();
			$("#approvalprocessimgid").empty();
			$("#templatenameid").empty();
			$("#requestfrid").empty();
			if (templatename.d.results.length > 0) 
			{
				$.map(templatename.d.results, function (datre) {
					var fileiconurl = "";
					if (datre.FileIcon != null && datre.FileIcon != undefined && datre.FileIcon != "") 
					{
						fileiconurl += "<img src='" + datre.FileIcon.Url + "' />";
					}
					$("#titleid").append(datre.Title);
					$("#approvalprocessimgid").append(fileiconurl);
					$("#templatenameid").append(datre.TemplateName);
					$("#requestfrid").append(datre.RequestFor);
					
					ConditionApplied = datre.ConditionApplied;
					if(datre.ConditionApplied == null || datre.ConditionApplied == false)
					{
						ConditionApplied = false;
					}
				})
			}
		});
	}
			
	
	var ActiveInitiationScope='';
	function PageColomnsDisplay() 
	{
		
		let promi = $.Deferred();
		ActiveInitiationScope='';
		var templatename = $("input[name='selector']:checked").val();
		var templateID =  $("input[name='selector']:checked").attr('templateid')
		GetData("/_api/web/lists/getbytitle('ApprovalProcessMaster')/items?$select=*,PageColumn,TemplateName&$filter=Id eq '" + templateID + "'").done(function (templatename) {
			if (templatename.d.results.length > 0) 
			{
				promi.resolve(templatename.d.results[0].PageColumn)
				ActiveInitiationScope = templatename.d.results[0].EditScope;
			}
			else
			{
				promi.resolve("");
			}
		});
		return promi.promise();
	}
	
	var ApproversListForward  = '';
	var FormulaColumnList =[];
	var mleList =[];
	var AutoFilledCols = [];	
	var arrNumVal= [];
	var summarizeValues = [];
	function CreateLabesDynamically(pagenumbers) 
	{
		var templatename = $("input[name='selector']:checked").val();
		var templateID = '';//$("input[name='selector']:checked").attr('templateid')
		if(templatename == null || templatename == '')
		{
			templatename =	window.atob(titanForWork.getQueryStringParameter('RecName'));
		}
		templatename = templatename.trim(); templateID = templateID ;
		templateID =  $("input[name='selector']:checked").attr('templateid')
		templateID = templateID ? templateID : window.atob(titanForWork.getQueryStringParameter('Template'));
		arrNumVal = [];mleList=[];AutoFilledCols =[];
		$('.custom-panel').show();
		//GetData("/_api/web/lists/getbytitle('ApprovalTemplateSetup')/items?$select=*,Title,SequenceNo,DefaultValue,ColumnName,ColumnType,Mandatory,DateValidation,NumberValidation,DropdownValues,Active,TemplateID/Id,TemplateID/TemplateName,Author/Title,Author/Id&$expand=TemplateID,Author&$filter= TemplateID/Title eq '" + templatename + "' &$orderby= SequenceNo asc").done(function (plantsdata) {
		GetData("/_api/web/lists/getbytitle('ApprovalTemplateSetup')/items?$select=*,Title,SequenceNo,DefaultValue,ColumnName,ColumnType,Mandatory,DateValidation,NumberValidation,DropdownValues,Active,TemplateID/Id,TemplateID/TemplateName,Author/Title,Author/Id,VisibleFields/Id,VisibleFields/Title&$expand=TemplateID,VisibleFields,Author&$filter= TemplateID/ID eq '" + templateID + "' &$orderby= SequenceNo asc").done(function (plantsdata) {
			$("#appenddyamicboxes").empty();
			$('#Docfilename').empty();			
			
			resultCol = plantsdata.d.results;
			CurrTenplateID = resultCol[0].TemplateID.Id;
			var QueryResult = [];
			var QueryDataRetResult =[];
			var QueryDataQueueResult  = [];
			var Passingtoken='';			
			if(window.location.href.indexOf("?")> -1) 
    		{
    			Passingtoken = window.atob(titanForWork.getQueryStringParameter('Step'));
				if(Passingtoken == 'Initiation')
				{
					var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalTemplateEditScope')/items?$select=*,TableColumns/Id,TableColumns/Title&$expand=TableColumns&$filter=TemplateID eq '"+CurrTenplateID+"' and StepType eq 'Initiation'";
    				QueryResult = RequestGetdata(Query);
    				
    				$(".new-request-top-right-change-Display").css("display", "block");
    				$(".new-request-top-right-change-Display-History").css("display", "none");
    				$("#Rejectrequest").css("display", "none");
					$("#Approverequest").css("display", "none");
					$('#Forwardrequest').css("display", "none");
					$('#Revertrequest').css("display", "none");
					//$("#savenewrequest").text('Submit');
					$('#savenewrequest').removeAttr("data-target");
				}else if(Passingtoken == 'Draft')
				{
					//$(".new-request-top-right-change-Display").css("display", "none");
					$(".new-request-top-right-change-Display").css("display", "block");
    				$(".new-request-top-right-change-Display-History").css("display", "none");
    				$("#Rejectrequest").css("display", "none");
					$("#Approverequest").css("display", "none");
					$('#Forwardrequest').css("display", "none");
					$('#Revertrequest').css("display", "none");
					$("#savenewrequest").text('Submit');
					$('#savenewrequest').removeAttr("data-target");

					var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalTemplateEditScope')/items?$select=*,TableColumns/Id,TableColumns/Title&$expand=TableColumns&$filter=TemplateID eq '"+CurrTenplateID+"' and StepType eq 'Initiation'" ;
						QueryResult = RequestGetdata(Query);
					var QueryDataRet =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessList')/items?$select=*,RequestBy/Id,RequestBy/Title,ColumnPeople1/Id,ColumnPeople1/Title,ColumnPeople2/Id,ColumnPeople2/Title,ColumnPeople3/Id,ColumnPeople3/Title,ColumnPeople4/Id,ColumnPeople4/Title,ColumnPeople5/Id,ColumnPeople5/Title,AttachmentFiles&$expand=RequestBy,ColumnPeople1,ColumnPeople2,ColumnPeople3,ColumnPeople4,ColumnPeople5,AttachmentFiles&$filter=ID eq "+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"";
						QueryDataRetResult = RequestGetdata(QueryDataRet );
					if(QueryDataRetResult[0].AuthorId != _spPageContextInfo.userId)	{
						alert("Unauthorized access!");
	        		    window.location.href = _spPageContextInfo.webAbsoluteUrl;
					}
						
				}
				else if(Passingtoken == 'Process Steps')
				{
					$("#savenewDraft").css("display", "none");
					//$("#AttachDocs").css("display", "none");
					var ActionType = window.atob(titanForWork.getQueryStringParameter('ActionType'));					
					var CurrStepId = window.atob(titanForWork.getQueryStringParameter('StepID'));
					var QueryDataStep =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=StepID&$filter=RequestID eq "+window.atob(titanForWork.getQueryStringParameter('RecNo'))+" and ID eq "+CurrStepId+"&$orderby=Sequence_No asc";
					var QueryStepIdData = RequestGetdata(QueryDataStep);  						
					
					if(QueryStepIdData[0].StepID == 'Initiation' || QueryStepIdData[0].StepID == '')
					{
						var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalTemplateEditScope')/items?$select=*,TableColumns/Id,TableColumns/Title&$expand=TableColumns&$filter=TemplateID eq '"+CurrTenplateID+"' and StepType eq 'Initiation'" ;
	    				QueryResult = RequestGetdata(Query);
	    				if(ActionType == 'Forward-Review-Action')
						{
							$("#ForwardTextDiv").css("display","inline-block");
							$(".new-request-top-right-change-Display").css("display", "none");
							$(".new-request-top-right-change-Display-History").css("display", "none");
							$(".new-request-top-right-change").css("display", "none");
							$(".new-request-top-right").css("display", "none");
							
							$("#Forward-Review-Btn").css("display","inline-block");
							$("#Approverequest").css("display", "none");
							$("#savenewrequest").css("display", "none");
							$("#Rejectrequest").css("display", "none");
							$('#Forwardrequest').css("display", "none");
							$('#Revertrequest').css("display", "none");
							
							var QueryDataStep =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessForward')/items?$select=*,ForwardedBy/Title,ForwardedBy/EMail,ForwardedTo/Title,ForwardedTo/EMail&$expand=ForwardedBy,ForwardedTo&$filter=ApprovalQueueID eq "+window.atob(titanForWork.getQueryStringParameter('StepID'))+"";
							var QueryStepIdData = RequestGetdata(QueryDataStep);
							var ForwardUser = _spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' + escapeProperly(QueryStepIdData[0].ForwardedBy.EMail);
							$("#ForwardedByImage").attr("src",ForwardUser);							
						}
						else
						{
	    					$(".new-request-top-right-change-Display").css("display", "none");
	    					$("#Rejectrequest").css("display", "none");
							$("#Approverequest").css("display", "none");
							$('#Forwardrequest').css("display", "none");
							$('#Revertrequest').css("display", "none");
							$("#savenewrequest").text('Submit');
							$('#savenewrequest').removeAttr("data-target");
						}
					}
					else
					{	if(window.atob(titanForWork.getQueryStringParameter('ActionType')) == 'Forward-Review-Action'){
						QueryResult = [];
						}else{
						var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalTemplateEditScope')/items?$select=*,TableColumns/Id,TableColumns/Title&$expand=TableColumns&$filter=TemplateID eq '"+CurrTenplateID+"' and StepID/ID eq '"+QueryStepIdData[0].StepID+"' and StepType eq 'Process Steps'" ;
						QueryResult = RequestGetdata(Query);
						}
					} 
					if(ActionType == 'Forward-Review-Action')
					{
						$("#ForwardTextDiv").css("display","inline-block");
						$(".new-request-top-right-change-Display").css("display", "none");
						$(".new-request-top-right-change-Display-History").css("display", "none");
						$(".new-request-top-right-change").css("display", "none");
						$(".new-request-top-right").css("display", "none");
						
						$("#Forward-Review-Btn").css("display","inline-block")
						$("#Approverequest").css("display", "none");
						$("#savenewrequest").css("display", "none");
						$("#Rejectrequest").css("display", "none");
						$('#Forwardrequest').css("display", "none");
						$('#Revertrequest').css("display", "none");
						$("#AttachDocs").css('display','none');
						
						var QueryDataStep =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessForward')/items?$select=*,ForwardedBy/Title,ForwardedBy/EMail,ForwardedTo/Title,ForwardedTo/EMail&$expand=ForwardedBy,ForwardedTo&$filter=ApprovalQueueID eq "+window.atob(titanForWork.getQueryStringParameter('StepID'))+"";
						var QueryStepIdData = RequestGetdata(QueryDataStep);
						var ForwardUser = _spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' + escapeProperly(QueryStepIdData[0].ForwardedBy.EMail);
						$("#ForwardedByImage").attr("src",ForwardUser);
					}
					else
					{
						$(".new-request-top-right-change-Display").css("display", "none");
					}
  						
					var QueryDataRet =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessList')/items?$select=*,RequestBy/Id,RequestBy/Title,ColumnPeople1/Id,ColumnPeople1/Title,ColumnPeople2/Id,ColumnPeople2/Title,ColumnPeople3/Id,ColumnPeople3/Title,ColumnPeople4/Id,ColumnPeople4/Title,ColumnPeople5/Id,ColumnPeople5/Title,AttachmentFiles&$expand=RequestBy,ColumnPeople1,ColumnPeople2,ColumnPeople3,ColumnPeople4,ColumnPeople5,AttachmentFiles&$filter=ID eq "+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"";
						QueryDataRetResult = RequestGetdata(QueryDataRet );
   						//console.log(QueryDataRetResult[0].AttachmentFiles.results); 
   						/*	var restendpoint = "/_api/web/lists/getbytitle('ApprovalProcessListTable')/items?$select=*,SetupID/ID&$expand=SetupID&$filter=RequestID eq '"+ItemId+"'&$orderby=ID asc";
    					var QueryTableData = RequestData(restendpoint );	*/
		
					var QueryDataStep =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,Status, Approvers/Title,Approvers/EMail,Approvers/ID,ActionTakenby/Title, ActionTakenby/Id, Modified, AttachmentFiles&$expand=Approvers,AttachmentFiles,ActionTakenby&$filter=RequestID eq "+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"&$orderby=Sequence_No asc";
						QueryDataQueueResult = RequestGetdata(QueryDataStep);  						
   					
   					if(QueryDataQueueResult.length>0)
   					{
   						var ActiveQueeApproversList = $.grep(QueryDataQueueResult, function(v) {
							return v.StepName == window.atob(titanForWork.getQueryStringParameter('StepNo')) || v.Status == "Pending" && v.Status == "Rejected"  
						});
						
						ApproversListForward  = ActiveQueeApproversList[0].ApproversId.results;
						var ApproversDesign='';
						

						for(var i=0; i<ActiveQueeApproversList[0].Approvers.results.length; i++)
    					{    			
    						var ApproversImg=_spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' +ActiveQueeApproversList[0].Approvers.results[i].EMail;
    						ApproversDesign = ApproversDesign +	"<div class='col-md-6 col-sm-6'>"+
                            										"<div class='members-card border-0'>"+
							                            				"<div class='members-card-head'>"+
                                    										"<img src='"+ApproversImg+"'>"+
                                										"</div>"+
                                										"<div class='members-card-body'>"+
                                    										"<div class='members-card-body-info text-ellipsis'>"+
                                        										"<h3 class='member-name text-ellipsis'>"+ActiveQueeApproversList[0].Approvers.results[i].Title+"</h3>"+
                                        										"<p class='member-email text-ellipsis mb0'>"+ActiveQueeApproversList[0].Approvers.results[i].EMail+"</p>"+
                                    										"</div>"+
                                    										"<a class='btn remove-group-btn remove-btn close close-round' onclick='removeUserBox(this, \"" + ActiveQueeApproversList[0].Approvers.results[i].EMail + "\", \"" + ActiveQueeApproversList[0].Approvers.results[i].Title + "\", " + ActiveQueeApproversList[0].Approvers.results[i].ID + ")'><i class='fa fa-times'></i></a>"+
                                										"</div>"+
                            										"</div>"+
                        										"</div>";
		    			}
		    			$("#UsersListForward").empty().append(ApproversDesign);   					
					}
					
	
    				
    				$("#Approverequest").css("display", "none");
    				debugger;
					if(QueryDataRetResult[0].ActionRequired == 'Review Only' || QueryDataRetResult[0].ActionRequired == ' ')
					{
						if(QueryDataRetResult[0].ActionRequired == 'Edit Only')
						{
							$("#savenewrequest").text('Submit');
							$("#approvalReviewedModal h4").text('Submit');
							$("#ReviewedApproveChkBox").prop('checked', true);
							$(".chkboxdiv").css("display", "none");
						}
						else
						{
							$("#savenewrequest").text('Review');
							$("#approvalReviewedModal h4").text('Review');
							$("#ReviewedApproveChkBox").prop('checked', false);
							$(".chkboxdiv").css("display", "block");
						}
						
						//$("#savenewrequest").attr("data-toggle", "modal");
						$("#savenewrequest").attr("data-target", "#approvalReviewedModal");

						$("#Rejectrequest").css("display", "none");
						$('#Forwardrequest').css("display", "none");
						$('#Revertrequest').css("display", "none");
						AskingNextQueeApprovers('approvalReviewedModal')
					}
					else if(QueryDataRetResult[0].ActionRequired == 'Edit & Sign' || QueryDataRetResult[0].ActionRequired == 'Review & Sign' || QueryDataRetResult[0].ActionRequired == 'Review and Sign')
					{
						if(ActionType == 'Forward-Review-Action')
						{	
							$("#ForwardTextDiv").css("display","inline-block");
							$(".new-request-top-right-change-Display").css("display", "none");
							$(".new-request-top-right-change-Display-History").css("display", "none");						
							$("#Approverequest").css("display", "none");
							$("#savenewrequest").css("display", "none");
							$(".new-request-top-right-change").css("display", "none");
							$(".new-request-top-right").css("display", "none");
							
						}
						else
						{
							$("#Approverequest").css("display", "inline-block");
							$("#savenewrequest").css("display", "none");
							AskingNextQueeApprovers('approvalActionModal')

						}
					}
					else if(QueryDataRetResult[0].ActionRequired == 'Edit Data')
					{
						if(QueryStepIdData[0].StepID == 'Initiation' || QueryStepIdData[0].StepID == '')
						{
							$("#savenewrequest").text('Re-Submit');
							$("#ModelIDText").text('Re Submit');
							$("#ChkText").text('Re-Submit');
						}
						else
						{
							$("#savenewrequest").text('Approve');
							$("#ModelIDText").text('Approve');
							$("#ChkText").text('Approved');

						}
						
						$("#savenewrequest").attr("data-target", "#approvalEditModal");	
						AskingNextQueeApprovers('approvalEditModal')			
					}else if(QueryDataRetResult[0].ActionRequired == '')
					{
					
					}
					else
					{
						$("#savenewrequest").text('Approve');
						//$("#savenewrequest").css('position' , 'absolute');$("#savenewrequest").css('left', '427px');	
						$("#Rejectrequest").css("display", "inline-block");
					}
    			}
				else
				{
					alert("Unauthorized access!");
        		    window.location.href = _spPageContextInfo.webAbsoluteUrl;
				}
    		}
    		else
    		{
    			alert("Unauthorized access!");
    	    	window.location.href = _spPageContextInfo.webAbsoluteUrl;
    		}
			
    		if (plantsdata.d.results.length > 0) 
    		{
				$.map(plantsdata.d.results, function (datarepeter) {
					var FilteredRec = $.grep(QueryResult, function(v) {
    					return v.ColumnIDId == datarepeter.Id; // && v.EditScope == 'Partial';
					});
					
					var PermissionStatus='';var VisiblePermissionClass = '';
					if(ActiveInitiationScope == 'Full-Form' || ActiveInitiationScope == 'Full Form'  && window.atob(titanForWork.getQueryStringParameter('Step')) == 'Initiation')
					{
						PermissionStatus='';						
					}
					else if(ActiveInitiationScope == 'Partial')
					{				
						if(FilteredRec.length==0)
						{
							if(datarepeter.ColumnType == 'Currency')
							{
								PermissionStatus = 'disabled="disabled"';
							}
							else if(datarepeter.ColumnType == 'Yes/No')
							{
								PermissionStatus = 'disabled="disabled"';
							}							
							else
							{
								PermissionStatus='disabled="disabled"';
								//VisiblePermissionClass = 'hide';
							}							
						}
						else if(FilteredRec.length > 0)
						{
							
							if(FilteredRec[0].EditScope == 'Invisible'){							
								PermissionStatus = 'disabled="disabled"';	
								VisiblePermissionClass = 'hide';						
							}else{
								PermissionStatus = '';	
							}
						}
					}
					/*else{
						PermissionStatus = '';
						VisiblePermissionClass = 'hide';
					}*/
					
					var dynamictempalte = "";
					var valuefordefault = "";
					var valueinMulti = "";
					var datatypeval = "",classsetnew = "" ;
					var templatehelptext= "", saveclassset = ""; headerstyle = ""; classset = ""; classRich = "";		
				/*	if(datarepeter.ConditionForVisible != null){
						datatypeval ='onchange="checkColVisibility(\''+datarepeter.ConditionForVisible+'\',\''+datarepeter.ColumnName+'\', \''+datarepeter.VisibleFields+'\');"';
						//saveclassset += 'hide ';						
					}*/
					if (datarepeter.DefaultValue != null && datarepeter.DefaultValue != undefined && datarepeter.DefaultValue != "") {
						valuefordefault += datarepeter.DefaultValue ? datarepeter.DefaultValue : "";
						AutoFilledCols.push({'ColName' : datarepeter.ColumnName , 'ColValue' : valuefordefault });
					}							
					
					if (datarepeter.FixedText != null && datarepeter.FixedText != undefined && datarepeter.FixedText != "") {
						valueinMulti += datarepeter.FixedText ? datarepeter.FixedText : "";
						
							}
							
							if (datarepeter.ColumnType != null && datarepeter.ColumnType != undefined && datarepeter.ColumnType != "") {
								if (datarepeter.ColumnType == "Number") {
									//datatypeval += "onkeypress=' return isNumber(event)'";
									arrNumVal.push({'title':datarepeter.Title, 'col': datarepeter.ColumnName, 'min': datarepeter.MinNumber,'max': datarepeter.MaxNumber});
									if(datarepeter.CalculatedValue == true)
									{
										
								   		if(datarepeter.ColumnName == 'CalculatedValue'){
								   		var IsCalculate = true;
								   		var Formula = datarepeter.Formula;
								   		classsetnew = 
								   		//datatypeval += 'onfocusin="return CalculateDynamicValue(this, \''+datarepeter.ColumnName+'\',\''+Formula+'\');"'
								   		FormulaColumnList.push({'Formula':datarepeter.Formula,'ColumnName':datarepeter.ColumnName,'Rel':datarepeter.Title});
								   		datatypeval += 'disabled = disabled';
								   		}
								   		if(datarepeter.SummarizedValue == true){
								   		datatypeval += 'onkeyup ="SetCalculateValue();SetSummarizedValue();"'
								 	  	}								   			
								   		datatypeval += 'onkeyup ="SetCalculateValue();"'
								   										   		
								   	}
								   	if(datarepeter.SummarizedValue == true){
								   		datatypeval += 'onkeyup ="SetSummarizedValue();"'
								   	}
								   	var setnumberlimit = "";
									if(datarepeter.NumberValidation != null && datarepeter.NumberValidation != undefined && datarepeter.NumberValidation != ""){
		                            
										if(datarepeter.NumberValidation == "Integer"){
											datatypeval += "onkeypress='return (event.charCode == 8 || event.charCode == 0 || event.charCode == 13 || event.charCode == 45) ? null : event.charCode >= 48 && event.charCode <= 57 '";//"onkeypress=' return isNumber(event)'";	//'onkeyup return (event.charCode == 8 || event.charCode == 0 || event.charCode == 13) ? null : event.charCode >= 48 && event.charCode <= 57"'
											setnumberlimit +="maxlength='15'";											

										}else if(datarepeter.NumberValidation == "Decimal"){											
											setnumberlimit +="maxlength='15'";
											datatypeval += 'onkeydown = "isDecimal(event)";  onkeypress="isValidate(this)"'; 										
										}								
									}
								}
							}
							var datetypevalstop = "";
							if (datarepeter.ColumnType != null && datarepeter.ColumnType != undefined && datarepeter.ColumnType != "") {
								if (datarepeter.ColumnType == "Date" || datarepeter.ColumnType == "DueDate") {
									datetypevalstop += "stopenterdata"; 
									valuefordefault = '';
								}
							}
							
							if(window.location.href.indexOf("?")> -1) 
    						{
    							var Passingtoken = window.atob(titanForWork.getQueryStringParameter('Step'));
								if(Passingtoken == 'Process Steps' || Passingtoken == 'Draft')
								{
									//QueryDataRetResult
									var ColumnValue = '';
    								ColumnValue = ColumnValueByColumnName(QueryDataRetResult,datarepeter.ColumnName)
    								
    								if(ColumnValue ==  null)
    								{
    									valuefordefault = '';
    								}
    								else
    								{	    																	
    									valuefordefault = ColumnValue;
    									
									}
								}
							}
						
							var datalimitset = ""; urltext = "";
							if (datarepeter.ColumnType != null && datarepeter.ColumnType != undefined && datarepeter.ColumnType != "") {
								if (datarepeter.ColumnType == "Text") {
									if(datarepeter.TextValidation == 'Link' ){
										//datalimitset += "maxlength='250'";
										urltext += 'onkeyup = "return replaceURLWithHTMLLinks(this.value)"'
									}else if(datarepeter.TextValidation == '' || datarepeter.TextValidation == null  ){
										datalimitset += "maxlength='250'"; 
									}else{										
										datalimitset += "maxlength='"+datarepeter.TextValidation+"'"; 
									}
								}
							}
							var serialNum = 0;
							var NewSerail= '';							
							
                             //var templatehelptext= "", saveclassset = ""; headerstyle = ""; classset = ""; classRich = "";
							 if(datarepeter.ColumnType == "FixedText" || datarepeter.ColumnType == "Multiline"){
								 if(datarepeter.ColumnType == "FixedText"){
								 	saveclassset += "dynamicdatatexboxes2 ";
								 	if(datarepeter.Width == 'Column Width'){
								 		saveclassset += "col-md-4";
								 	}else{
								 	saveclassset +=	"full";
								 	}									
									//templatehelptext += "<textarea "+PermissionStatus+" class='dynamicvalfeachcls2 form-control' readonly value='" + valueinMulti + "' rows='5' id='" + datarepeter.ColumnName + "'>"+valueinMulti+"</textarea>";\
									templatehelptext += "<div "+PermissionStatus+" class='dynamicvalfeachcls2' readonly value='" + valueinMulti + "' id='" + datarepeter.ColumnName + "'>"+valueinMulti+"</div>";
								 }else{
								 	saveclassset += " dynamicdatatexboxes "+datarepeter.MLEHeight+" ";
								 	
								 	
								 	if(datarepeter.Width == 'Column Width'){
								 		if(pagenumbers == 2){
								 			saveclassset += "col-md-6 resize_richTexbx";
								 		}else{
								 			saveclassset += "col-md-4 resize_richTexbx";
								 		}								 		
								 	}else if(datarepeter.Width == 'Page Width'){
								 	//	saveclassset += "col-md-12";
								 		saveclassset +=	"full resize_richTexbx";
								 		$(".full").removeClass("col-md-4")
										$(".full").removeClass("col-md-6") 
								 	}
								 	if(PermissionStatus == '')	{
										classset += 'active';
										classRich += 'content_'+datarepeter.ColumnName;
										mleList.push({'col':datarepeter.ColumnName, 'data' : valuefordefault});
										//$('.richText-editor').html(valuefordefault )
										//templatehelptext += "<textarea "+PermissionStatus+" class='dynamicvalfeachcls form-control "+ classRich +" "+ classset +"' value='" + valuefordefault + "' rows='5' style='max-height : 100px' id='" + datarepeter.ColumnName + "' coltype ='"+datarepeter.ColumnType+"'></textarea>";
										templatehelptext += "<div class='dynamicvalfeachcls form-control "+ classRich +" "+ classset +" ' "+PermissionStatus+" style='height:100% !important;min-height : 100px' id='" + datarepeter.ColumnName + "' coltype ='"+datarepeter.ColumnType+"' ></div>";
									}else{
										templatehelptext += "<div class='dynamicvalfeachcls form-control ' "+PermissionStatus+" style='height:100% !important;min-height : 100px'>"+valuefordefault +"</div>";
									}																		
									//if(valuefordefault != '' ){ $('.richText-editor').val(valuefordefault )}								
								 } 							 
								
			                }else if(datarepeter.ColumnType == "Header"){
								saveclassset += "full";
								var colorset = "colorsetdyn";
								headerstyle += "margin-top:25px"
								templatehelptext += "<hr>";
							}else if(datarepeter.ColumnType == "QR Code" || datarepeter.ColumnType == "Web Link"){
								console.log(datarepeter.ColumnType);
								templatehelptext  += "";	
							}else if(datarepeter.ColumnType == 'AttachmentBox')
							{//debugger;
								var PassingStep = window.atob(titanForWork.getQueryStringParameter('Step'));								
								if(PassingStep == 'Initiation'){
									console.log(datarepeter.ColumnType);
									if(PermissionStatus == '')	
									{
											classset += 'active';
									}
									saveclassset += "dynamicdatatexboxes";
									datatypeval ='onchange="validateFileExtensions(\''+datarepeter.ColumnName+'\', \''+datarepeter.DefaultValue+'\', \''+datarepeter.MaxNumber+'\');"';
									templatehelptext += "<input type='file' "+PermissionStatus+"  coltype ='"+datarepeter.ColumnType+"'  class='dynamicvalfeachcls  "+ classset +" "+VisiblePermissionClass+" form-control "+ datetypevalstop + "' " + datatypeval + " value='' id='" + datarepeter.ColumnName +"' "+datalimitset +" "+setnumberlimit+" "+urltext+"  />";
								}else{								
									var ColDoc = [];								
									var RecID = window.atob(titanForWork.getQueryStringParameter('RecNo'));								
									var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessDocuments')/items?$select=*,Author/ID,Author/Title,RequestID/Id,AttachmentFiles&$expand=RequestID,Author,AttachmentFiles&$filter=RequestID/Id eq '"+RecID+"' and ColumnName eq '"+datarepeter.ColumnName+"'";
									var QueryResultDocs = RequestGetdata(Query);
									if(QueryResultDocs.length > 0){
									if(QueryResultDocs[0].AttachmentFiles.results.length > 0){
										saveclassset += "dynamicdatatexboxes";
										templatehelptext += '<div class="total_attch_fils Doc_'+datarepeter.ColumnName+'" >'								
										templatehelptext += '<div class="round_shap">'
									    templatehelptext += '<span class="filename">'+QueryResultDocs[0].AttachmentFiles.results[0].FileName+'</span>'
									    templatehelptext += '<div class="event_btn">'
									    templatehelptext += '<a href="javascript:void(0);" download="'+QueryResultDocs[0].AttachmentFiles.results[0].FileName+'" name="'+QueryResultDocs[0].AttachmentFiles.results[0].FileName+'" onclick="downloadAttach(\'' + QueryResultDocs[0].AttachmentFiles.results[0].ServerRelativeUrl+ '\', \'' + QueryResultDocs[0].AttachmentFiles.results[0].FileName + '\')"per="Download"><i class="fa fa-download"></i></a>'
									    if(PermissionStatus != ''){	
									    //templatehelptext += '<label for="upload_'+datarepeter.ColumnName+'" style="display: inline-block;"><a href="javascript:void(0);" per="Upload"><i class="fa fa-upload"></i></a></label>'
									    //templatehelptext += '<input type="file" name="datafile" style="display:none" id="upload_'+datarepeter.ColumnName+'"class="browse form-control">'
									    //templatehelptext += '<a href="javascript:void(0);" per="Delete" onclick="DeleteColAttachment(\''+QueryResultDocs[0].Id+'\',\''+QueryResultDocs[0].AttachmentFiles.results[0].FileName+ '\', \''+datarepeter.ColumnName+'\')"><i class="fa fa-times"></i></a>'
									    }else{
									    templatehelptext += '<a href="javascript:void(0);" per="Delete" onclick="DeleteColAttachment(\''+PermissionStatus+'\',\''+QueryResultDocs[0].Id+'\',\''+QueryResultDocs[0].AttachmentFiles.results[0].FileName+ '\', \''+datarepeter.ColumnName+'\',\''+datarepeter.DefaultValue+'\',\''+datarepeter.MaxNumber+'\')"><i class="fa fa-times"></i></a>'
									    }
									    templatehelptext += '</div> </div> </div>'
								    }else{
								    	if(PermissionStatus == '')	
										{
												classset += 'active';
										}
								    	saveclassset += "dynamicdatatexboxes";
										datatypeval ='onchange="validateFileExtensions(\''+datarepeter.ColumnName+'\', \''+datarepeter.DefaultValue+'\', \''+datarepeter.MaxNumber+'\');"';
										templatehelptext += "<input type='file' "+PermissionStatus+"  coltype ='"+datarepeter.ColumnType+"'  class='dynamicvalfeachcls  "+ classset +" "+VisiblePermissionClass+" form-control "+ datetypevalstop + "' " + datatypeval + " value='' id='" + datarepeter.ColumnName +"' "+datalimitset +" "+setnumberlimit+" "+urltext+"  />";
								    }
								  }else{
								  if(PermissionStatus == '')	
										{
												classset += 'active';
										}
								    	saveclassset += "dynamicdatatexboxes";
										datatypeval ='onchange="validateFileExtensions(\''+datarepeter.ColumnName+'\', \''+datarepeter.DefaultValue+'\', \''+datarepeter.MaxNumber+'\');"';
										templatehelptext += "<input type='file' "+PermissionStatus+"  coltype ='"+datarepeter.ColumnType+"'  class='dynamicvalfeachcls  "+ classset +" "+VisiblePermissionClass+" form-control "+ datetypevalstop + "' " + datatypeval + " value='' id='" + datarepeter.ColumnName +"' "+datalimitset +" "+setnumberlimit+" "+urltext+"  />";
								  }
								}
							}
							else if(datarepeter.ColumnType == "Checkbox"){								
								console.log(datarepeter.ColumnType);
								if(valuefordefault == 0 ||valuefordefault == null || valuefordefault == ''){
									var value = '';
								}else{
									var value = 'checked' ;
								}
								if(PermissionStatus == '')	{
									classset += 'active';
								}
								var prefix = datarepeter.Prefix ? datarepeter.Prefix : '';
								var suffix = datarepeter.Suffix ? datarepeter.Suffix : '';
								if(datarepeter.Width == 'Switch'){
									saveclassset += "dynamicdatatexboxes";
									templatehelptext  += '<div class="combine_box_adds"><span class="">'+prefix+'</span><label class="switchtoggling"><input type="checkbox" '+PermissionStatus+' coltype ="'+datarepeter.ColumnType+'" class="dynamicvalfeachcls checkbox_widthmange '+ classset +' '+VisiblePermissionClass+'" value="" data-original-value="'+datarepeter.ColumnName+'"  id="'+datarepeter.ColumnName+'" '+value+'> <span class="clickmange"></span></label><span class="">'+suffix+'</span></div>';
								}else{
									saveclassset += "dynamicdatatexboxes";
									templatehelptext  += '<div class="combine_box_adds"><span class="">'+prefix+'</span><input type="checkbox" '+PermissionStatus+' coltype ="'+datarepeter.ColumnType+'" class="dynamicvalfeachcls inline_default_checkbox '+ classset +' '+VisiblePermissionClass+'" value="" data-original-value="'+datarepeter.ColumnName+'"  id="'+datarepeter.ColumnName+'" '+value+'></div>'; 
								}
	
							}
							else if(datarepeter.ColumnType == "Serial Number" ){
								var QueryDataRet =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessList')/items?$filter=TemplateID eq "+CurrTenplateID+"";
								//var QueryDataRet =  _spPageContextInfo.webAbsoluteUrl +	"/_api/Web/Lists/getByTitle('ApprovalProcessList')?$select=ItemCount,Items&$expand=Items&$filter=TemplateID eq "+CurrTenplateID+""								
								QueryDataRetResultSR = RequestGetdata(QueryDataRet );		console.log(QueryDataRetResultSR);
								serialNum = QueryDataRetResultSR.length +datarepeter.SerialStartFrom+1;
								var prefix = datarepeter.Prefix ? datarepeter.Prefix : "";
								var sufix =  datarepeter.Suffix ? datarepeter.Suffix : "";
								NewSerail = prefix  +serialNum+ sufix ;
								saveclassset += "dynamicdatatexboxes";
								classset += 'active';
								if(valuefordefault != ''){
									NewSerail  = valuefordefault;
									
								}
								AutoFilledCols.push({'ColName' : datarepeter.ColumnName , 'ColValue' : NewSerail  });
								templatehelptext += "<input type='text' "+PermissionStatus+"  coltype ='"+datarepeter.ColumnType+"' class='dynamicvalfeachcls form-control "+ datetypevalstop + " " + classset +"' " + datatypeval + " value='" + NewSerail + "' id='" + datarepeter.ColumnName + "' />";
							}						
							else{
								saveclassset += "dynamicdatatexboxes";
								classset += datarepeter.ColumnName 
								if(PermissionStatus == '')	{
										if(datarepeter.ColumnName  != 'CalculatedValue' && datarepeter.ColumnName  != 'SummarizedValue' ){
											classset += ' active';	
										}
								}
								var coltitle = ''; 
								if(datarepeter.ColumnName == 'CalculatedValue'){
									let t = datarepeter.Title; t=t.replaceAll(' ','')
									t=t.replace(/[&\/\\#,+()$~%.'":*?<>{}]/g, '');
									coltitle = '_'+t;
									templatehelptext += "<input type='text' "+PermissionStatus+"  coltype ='"+datarepeter.ColumnType+"'  class='dynamicvalfeachcls	" + classset +" "+VisiblePermissionClass+" form-control "+ datetypevalstop + "' " + datatypeval + " value='" + valuefordefault + "' id='" + datarepeter.ColumnName + coltitle +"' "+datalimitset +" "+setnumberlimit+" "+urltext+"  />";																								
								}else if(datarepeter.ColumnName == 'SummarizedValue'){
									let t = datarepeter.TableIName; 
									let d = datarepeter.TableColumnName;d=d.replace(/[&\/\\#,+()$~%.'":*?<>{}]/g, '');d=d.replaceAll(' ','');
									let f = datarepeter.Formula;
									let l = datarepeter.Title;	l=l.replace(/[&\/\\#,+()$~%.'":*?<>{}]/g, '');l=l.replaceAll(' ','');
									summarizeValues.push({'tblId' : t,'col' : d, 'formula' : f, 'lbl' : l});
									coltitle = '_'+t+'_'+l;
									var Passingtoken = window.atob(titanForWork.getQueryStringParameter('Step'));
									datatypeval += 'onkeyup ="SetSummarizedValue(\''+t+'\',\''+d+'\');"' 										
									if(Passingtoken == 'Process Steps')
									{	
									valuefordefault  =  $('#ttlval_'+t+'_'+d).text();
									}									
									templatehelptext += "<input type='text' "+PermissionStatus+"  coltype ='"+datarepeter.ColumnType+"'  class='dynamicvalfeachcls	" + classset +" form-control "+ datetypevalstop + "' " + datatypeval + " value='" + valuefordefault + "' id='" + datarepeter.ColumnName + coltitle +"' "+datalimitset +" "+setnumberlimit+" "+urltext+"  />";																								
									
								}else{
								templatehelptext += "<input type='text' "+PermissionStatus+"  coltype ='"+datarepeter.ColumnType+"'  class='dynamicvalfeachcls " + classset +" form-control "+ datetypevalstop + "' " + datatypeval + " value='" + valuefordefault + "' id='" + datarepeter.ColumnName + coltitle +"' "+datalimitset +" "+setnumberlimit+" "+urltext+"  />";
								}
							}
							if(datarepeter.ColumnType == "Table"){
								var tbLedtScope = $.grep(QueryResult, function(v) {
									return v.ColumnIDId == datarepeter.ID && (v.ObjectType == 'Table' || v.ObjectType == 'Column');
								});
								
							/*	if(tbLedtScope.length != '0')
									{
										PermissionStatus = 'disabled="disabled"';
									}
								else{	
										PermissionStatus = '';
									}					*/
								//if(tbLedtScope.length > 0){}
								
								if(datarepeter.DefaultValue == 'Rows' && Passingtoken == 'Initiation'){
									getTableInitialData(datarepeter.ID,datarepeter.Width,PermissionStatus,tbLedtScope);
								}else{
	                                appenedtableformat(datarepeter.ID,CurrTenplateID,PermissionStatus, datarepeter.Width,tbLedtScope );
	                            }
							}
							else{
							
							if (pagenumbers == 1) {
								if (datarepeter.Mandatory) {
									dynamictempalte = "<div class='col-md-12 col-sm-6 col-xs-12 "+saveclassset+" "+classset +" "+VisiblePermissionClass+"' id='"+datarepeter.Id+"'>\
													<div class='form-group custom-form-group' style='"+headerstyle+"'>\
														<label class='columnnametxt "+colorset+" "+ classset +"' value='" + datarepeter.ColumnName + "' mandatorycol='true' alerttext='" + datarepeter.Title + "'>" + datarepeter.Title + " : <span style='color:red'>*</style></label>\
														"+templatehelptext+"\
													</div>\
												</div>";

								} else {
									 if(datarepeter.ColumnType == "QR Code" || datarepeter.ColumnType == "Web Link"){
											dynamictempalte = "";
										} else{
														dynamictempalte = "<div class='col-md-12 col-sm-6 col-xs-12 "+saveclassset+" "+classset +" "+VisiblePermissionClass+"' id='"+datarepeter.Id+"'>\
															<div class='form-group custom-form-group' style='"+headerstyle+"'>\
																<label class='columnnametxt "+colorset+" "+ classset +" ' value='" + datarepeter.ColumnName + "' mandatorycol='false' alerttext='" + datarepeter.Title + "'>" + datarepeter.Title + " :</label>\
																"+templatehelptext+"\
															</div>\
														</div>";
										}
								}
							}
							else if (pagenumbers == 2) {
								if (datarepeter.Mandatory) {
									dynamictempalte = "<div class='col-md-6 col-sm-6 col-xs-12 "+saveclassset+" "+classset +" "+VisiblePermissionClass+"' id='"+datarepeter.Id+"'>\
													<div class='form-group custom-form-group' style='"+headerstyle+"'>\
														<label class='columnnametxt "+colorset+" "+ classset +"' value='" + datarepeter.ColumnName + "' mandatorycol='true' alerttext='" + datarepeter.Title + "'>" + datarepeter.Title + " : <span style='color:red'>*</style></label>\
															"+templatehelptext+"\
													</div>\
												</div>";
								} else {
										if(datarepeter.ColumnType == "QR Code" || datarepeter.ColumnType == "Web Link"){
											dynamictempalte = "";
										} else{
												dynamictempalte = "<div class='col-md-6 col-sm-6 col-xs-12 "+saveclassset+" "+classset +" "+VisiblePermissionClass+"' id='"+datarepeter.Id+"'>\
														<div class='form-group custom-form-group' style='"+headerstyle+"'>\
															<label class='columnnametxt "+colorset+" "+ classset +"' value='" + datarepeter.ColumnName + "' mandatorycol='false' alerttext='" + datarepeter.Title + "'>" + datarepeter.Title + " :</label>\
															"+templatehelptext+"\
														</div>\
													</div>";
										}
								}
							}
							else if (pagenumbers == 3) {
								if (datarepeter.Mandatory) {
									dynamictempalte = "<div class='col-md-4 col-sm-6 col-xs-12 "+saveclassset+" "+classset +" "+VisiblePermissionClass+"' id='"+datarepeter.Id+"'>\
													<div class='form-group custom-form-group' style='"+headerstyle+"'>\
														<label class='columnnametxt "+colorset+" "+ classset +"' value='" + datarepeter.ColumnName + "' mandatorycol='true' alerttext='" + datarepeter.Title + "'>" + datarepeter.Title + " : <span style='color:red'>*</style></label>\
															"+templatehelptext+"\
													</div>\
												</div>";
								} else {
									if(datarepeter.ColumnType == "QR Code" || datarepeter.ColumnType == "Web Link"){
											dynamictempalte = "";
										} else{
															dynamictempalte = "<div class='col-md-4 col-sm-6 col-xs-12 "+saveclassset+" "+classset +" "+VisiblePermissionClass+"' id='"+datarepeter.Id+"'>\
															<div class='form-group custom-form-group' style='"+headerstyle+"'>\
																<label class='columnnametxt "+colorset+" "+ classset +"' value='" + datarepeter.ColumnName + "' mandatorycol='false' alerttext='" + datarepeter.Title + "'>" + datarepeter.Title + " </label>\
																"+templatehelptext+"\
															</div>\
														</div>";
									}
								}
							}
							else {
								if (datarepeter.Mandatory) {
									dynamictempalte = "<div class='col-md-4 col-sm-6 col-xs-12 "+saveclassset+" "+classset +" "+VisiblePermissionClass+"' id='"+datarepeter.Id+"'>\
													<div class='form-group custom-form-group' style='"+headerstyle+"'>\
														<label class='columnnametxt "+colorset+" "+classset +"' value='" + datarepeter.ColumnName + "' mandatorycol='true' alerttext='" + datarepeter.Title + "'>" + datarepeter.Title + " : <span style='color:red'>*</style></label>\
															"+templatehelptext+"\
													</div>\
												</div>";
								} else {
									if(datarepeter.ColumnType == "QR Code" || datarepeter.ColumnType == "Web Link"){
											dynamictempalte = "";
										} else{
										dynamictempalte = "<div class='col-md-4 col-sm-6 col-xs-12 "+saveclassset+" "+classset +" "+VisiblePermissionClass+"' id='"+datarepeter.Id+"'>\
											<div class='form-group custom-form-group' style='"+headerstyle+"'>\
												<label class='columnnametxt "+colorset+" "+classset +"' value='" + datarepeter.ColumnName + "' mandatorycol='false' alerttext=''>" + datarepeter.Title + " :</label>\
												"+templatehelptext+"\
											</div>\
										</div>";
									}
								}
							}
						}
							
						$("#appenddyamicboxes").append(dynamictempalte);
						
						console.log(valuefordefault);
						console.log(datarepeter.ColumnName);
						$(".full").addClass("col-md-12")
						// remove a class
						$(".full").removeClass("col-md-4")
						$(".full").removeClass("col-md-6")
						selectddrval(datarepeter.ColumnName, valuefordefault);
						})
						$('.stopenterdata').keydown(function (e) {
							e.preventDefault();
							return false;
						});
						SetCalculateValue();
						SetSummarizedValue();
						SetDatpickerNdropDown(resultCol,'','','',QueryDataRetResult);	
						if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Process Steps'){
							GetAllattachments();
						}					
					}					
					if(personCols.length > 0){
					setTimeout(removeCancel,5000);	
					}
					getTempID(CurrTenplateID);
					
					if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Draft' || window.atob(titanForWork.getQueryStringParameter('Step')) == 'Process Step'){
					var QueryGetDocs =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessDocuments')/items?$select=*,RequestID/Title,RequestID/ID, SelectiveSteps/ID, SelectiveSteps/Title, FooterSignBy/Title, FooterSignBy/ID, Author/Title,Author/EMail,AttachmentFiles&$expand=FooterSignBy,SelectiveSteps,RequestID,Author,AttachmentFiles&$filter=RequestID/ID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"' &$orderby=Created asc";
					var QueryResultDocs = RequestGetdata(QueryGetDocs);
					if(QueryResultDocs.length >0){
					//var attchments = QueryResultDocs[0].AttachmentFiles.results;					
					var Tcounter = 0;
					var bindfile = '';
					var FilterDocs = $.grep(QueryResultDocs, function(v) {
							return v.SignatureOf == 'No Signature'
					}); console.log(FilterDocs); 
					if(FilterDocs != null){
					var attchments = FilterDocs[0].AttachmentFiles.results;
					for (var initial = 0; initial < attchments.length; initial++) {
					
						bindfile += '<div class="approve-process-upload-data-chip upload-chip" id="Ifile_' + Tcounter + '">';
						bindfile += '<i class="fa fa-paperclip color-sky-blue" aria-hidden="true"></i>';
						bindfile += '<span class="px-2 font-14 upload-chip-title" title=' + attchments[initial].FileName + '>' + attchments[initial].FileName  + '</span>';
						bindfile += '<i class="fa fa-times-circle-o text-danger" onclick="RemoveDocument(this.id,\'' + AttachDraftCol+ '\');" id="Ifile_' + Tcounter + '""></i>';						
						bindfile += '<span class="chip-icon-box"> <a href="javascript:void(0);" download="attchments[initial].FileName" name="'+attchments[initial].FileName+'" onclick="downloadAttach(\'' + attchments[initial].ServerRelativeUrl+ '\', \'' + attchments[initial].FileName+ '\')"style="color:#333;"><i class="fa fa-download cursor-pointer" aria-hidden="true"></i></a></span>';
						bindfile += '</div><label for="'+AttachDraftCol+'" style="margin:0"><input name="" id="'+AttachDraftCol+'" type="file" class="browse form-control" multiple="" style="display:none"> </label>';
						//bindfile += '';	
						Tcounter = Tcounter + 1;
					}
					$('#Docfilename'+AttachDraftCol).append(bindfile);
					}
				  }else{
				  var html = '<input type="file" coltype="AttachmentBox" class="dynamicvalfeachcls	ColumnText3 active form-control " value="" id="'+AttachDraftCol+'" undefined="">';
				  $("#"+AttachDraftCol).replaceWith(html);
				  }
				}
				if(QueryDataQueueResult.length > 0){
				/*	var FilteredRec2 = $.grep(QueryDataQueueResult , function(v) {
							return v.StepName == window.atob(titanForWork.getQueryStringParameter('StepNo'))
					}); console.log(FilteredRec2); */
					$('.mainlst').empty();
					var bindfile2 = '';
					/* var arrSubApprover = AllTaskUsersEmployeeuser.filter(function (filterData) {
					     return filterData.UserId == QueryDataRetResult[0].RequestById;
					 }); */
					 var QueryCheckActive =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Employees')/items?$select=LogonName/Id,LogonName/Title,Email&$expand=LogonName&$filter=LogonName/Id eq '"+QueryDataRetResult[0].RequestById+"' and Status eq 'Active'";
					 var arrSubApprover = RequestGetdata(QueryCheckActive);					
					bindfile2 += '<li>'
		            bindfile2 += '<span class="iconbox"> <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/NewEntryAssets/images/time-icon-1.png" alt=""> </span>'
					bindfile2 += '<div class="approvelheadeing">  <h3 class="mainheading">Approval Initiation</h3>  <span class="date-sec">'+moment(QueryDataRetResult[0].Created).format('lll')+'</span> </div>'
		            bindfile2 += '<p class="waitsec initialize">Initialized</p>'	
					bindfile2 += '<div class="row">'
					var Authorattachment = _spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' + escapeProperly(arrSubApprover[0].Email);
		            bindfile2 += '<div class="col-sm-6 flexitem">  <div class="imgsetion"> <img src="'+Authorattachment+'" alt=""> </div>'
		            bindfile2 += '<div class="imagecontent"> <h4>'+arrSubApprover[0].LoginName+'</h4> <a href="#">'+arrSubApprover[0].Email+'</a> </div></div>'
		
		          /*	<div class="col-sm-6"> <h3 style="font-size: 12px; margin-bottom:5px; padding:-left:3px; color:#333">
		                   Attachment files:
		                  </h3>
		                   <div class="signbox">
		                    <div class="upload-chip">
		                      <span class="pr-8 chip-text-box" style="color:#333; cursor:pointer;" title="">Example chart1.pdf</span>
		                      <span class="chip-icon-box">
		                        <a href="" download="" style="color:#333;"><i class="fa fa-download cursor-pointer" aria-hidden="true"></i> </a>
		                      </span>
		                    </div>
		                  </div>
		                </div> */
		           bindfile2 +=  '</div><!--row ed-->  </li>'

					
					
				 for(var q =0;q<QueryDataQueueResult.length;q++){
					var attchments = QueryDataQueueResult[q].AttachmentFiles.results;
					var Tcounter = 0;					
					
					if(QueryDataQueueResult[q].StepName == window.atob(titanForWork.getQueryStringParameter('StepNo'))){
						break;
					}else{
					bindfile2 +=  	'<li>'
			     	bindfile2 +=    '<span class="iconbox"> <img src="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/NewEntryAssets/images/time-icon-4.png" alt="" data-themekey="#"> </span>' 		
			        bindfile2 +=    '<div class="approvelheadeing"> <h3 class="mainheading">'+QueryDataQueueResult[q].StepName+'</h3> <span class="date-sec">'+moment(QueryDataQueueResult[q].Modified).format('lll')+'</span> </div>'
			        bindfile2 +=    '<p class="waitsec initialize">'+QueryDataQueueResult[q].Status+'</p>'
					
					/* var arrApprover = AllTaskUsersEmployeeuser.filter(function (filterData) {
					     return filterData.UserId == QueryDataQueueResult[q].ActionTakenby.Id;
					});	*/
					var QueryCheckActive =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Employees')/items?$select=LogonName/Id,LogonName/Title,Email&$expand=LogonName&$filter=LogonName/Id eq '"+QueryDataQueueResult[q].ActionTakenby.Id+"' and Status eq 'Active'";
					var arrApprover = RequestGetdata(QueryCheckActive);					
					
					if(arrApprover.length>0)
					{
			        	bindfile2 +=    '<div class="row"><div class="col-sm-6 flexitem">'
			        	var UserImage = _spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' + escapeProperly(arrApprover[0].Email);
			     		bindfile2 +=    '<div class="imgsetion"><img src="'+UserImage +'" alt="" data-themekey="#"></div>'
			        	bindfile2 +=    '<div class="imagecontent"><h4>'+QueryDataQueueResult[q].ActionTakenby.Title+'</h4><a href="#">'+arrApprover[0].Email+'</a></div></div>'
			        	bindfile2 +=    '<div class="col-sm-6 flx_verticalsbox"> <h3 style="font-size: 12px; margin-bottom:5px; padding:-left:3px; color:#333"> </h3>'
						bindfile2 +=  	'<div class="signbox">'
					}
					for (var initial2 = 0; initial2 < attchments.length; initial2++) {
					/*  bindfile += '<div class="upload-chip" id="Ifile_' + Tcounter + '">';
						bindfile += '<span class="d-flex align-items-center upload-chip-title">';
						bindfile += '<i class="fa fa-paperclip color-sky-blue" aria-hidden="true"></i>';
						bindfile += '<span class="px-2 font-14 upload-chip-title" title=' + RemoveDuplicate[initial] + '>' + RemoveDuplicate[initial] + '</span></span>';
						bindfile += '<button type="button" onclick="RemoveDocument(this.id);" id="Ifile_' + Tcounter + '"" class="btn p-0 upload-chip-delete-btn"><i class="fa fa-times-circle-o text-danger"></i></button></div>';
						//$('#Docfilename').append('<div id="Ifile_' + Tcounter2 + '"><span class="fa-stack fa-lg" style="line-height: 1em; height: 1em;"><i class="fa fa-paperclip" style="font-size: 20px; font-weight: 500;"></i></i><strong class="fa-stack-1x" style="color:#FFF; font-size:12px; margin-top:2px;">' + Tcounter2 + '</strong></span> ' + RemoveDuplicate2[initial] + '&nbsp;&nbsp;<span class="fa fa-close fa-lg closeBtn" style="color:red;"  onclick="RemoveDocument(this.id);" id="Ifile_' + Tcounter2 + '"" title="remove"></span></div>');
					 */					
			        
			        if(QueryDataQueueResult[q].SignType != 'SignImage')
			        {
			        	bindfile2 +=  '<div class="upload-chip" id="Ifile_' + Tcounter + '">'
			        	bindfile2 +=  '<span class="pr-8 chip-text-box" style="color:#333; cursor:pointer;" title="'+attchments[initial2].FileName+'">'+attchments[initial2].FileName+'</span>'
			        	bindfile2 +=  '<span class="chip-icon-box"> <a href="javascript:void(0);" download="'+attchments[initial2].FileName+'" onclick="downloadAttach(\'' + attchments[initial2].ServerRelativeUrl+ '\', \'' + attchments[initial2].FileName+ '\')"style="color:#333;" ><i class="fa fa-download cursor-pointer" aria-hidden="true"></i></a></span></div>'			        
			        }
				 				  
				/*	bindfile2 += '<div class="approve-process-upload-data-chip upload-chip" id="Ifile_' + Tcounter + '">';
					bindfile2 += '<i class="fa fa-paperclip color-sky-blue" aria-hidden="true"></i>';
					bindfile2 += '<span class="px-2 font-14 upload-chip-title" title=' + attchments[initial2].FileName + '>' + attchments[initial2].FileName  + '</span>';
				//	bindfile2 += '<i class="fa fa-times-circle-o text-danger" onclick="RemoveDocument(this.id);" id="Ifile_' + Tcounter + '""></i></div>';
					bindfile2 += '</div>';  */
					Tcounter = Tcounter + 1;
					}					
					if(QueryDataQueueResult[q].SignType == 'SignText')//SignDraw
    				{	if(QueryDataQueueResult[q].DrawSign == null){QueryDataQueueResult[q].DrawSign = ''}
    				bindfile2 +=
							//	"<div class='process-approve-signature-box'>"+                                    	        							
    								"<span id='SignatureText' class='signature-front'>"+QueryDataQueueResult[q].DrawSign+"</span>"            	                   	        							
    						//	"</div>";
        						 					
					}
					else if(QueryDataQueueResult[q].SignType == 'SignDraw')
					{	if(QueryDataQueueResult[q].DrawSign == null){QueryDataQueueResult[q].DrawSign = ''}
						bindfile2 +=	
								//	"<div class='process-approve-signature-box'>"+
	    								"<img class='process-approve-signature-img' src='"+QueryDataQueueResult[q].DrawSign+"' alt='signature'>"                                  	        							            	               	        								
	   							//	"</div>";	            	               									   					
					}
					else if(QueryDataQueueResult[q].SignType == 'SignImage')
					{
						var SignUrl='';
						if(QueryDataQueueResult[q].DrawSign != null)
						{
							SignUrl = QueryDataQueueResult[q].DrawSign;
						}
						else if(QueryDataQueueResult[q].AttachmentFiles.results.length>0)
						{
							SignUrl = QueryDataQueueResult[q].AttachmentFiles.results[0].ServerRelativeUrl;
						}    						
						bindfile2 +=	
									//"<div class='process-approve-signature-box'>"+
	               	        				"<img class='process-approve-signature-img' src='"+SignUrl+"' alt='signature'>"                                   	        							               	        				
	           	    				//	"</div>";                        								
					}			
					
				//	bindfile2 += '<span id="SignatureText" class="signature-front"><img src="'+QueryDataQueueResult[q].DrawSign+'" alt="">'+QueryDataQueueResult[q].DrawSign+'</span>';
					var remarks = QueryDataQueueResult[q].Remarks;
					if(remarks != null || remarks == ''){ 
					bindfile2 += '</div><div class="imagecontent"><h4>Remarks:</h4><p class="Purposetext">'+remarks+'</p></div>'
					}
					bindfile2 += '</div><!--row ed--></li>';
					}				
				  }				
				  //$('.mainlst').append(bindfile2);
				  //$('.history_listbx').show();	
				}					
				});
				if(mleList.length > 0){
					for(m= 0;m<mleList.length;m++){
					    $('.content_'+mleList[m].col+'.active').richText();					    
					    $('a[title="Add image"]').hide();
					    $('a[title="Add file"]').hide();
					    $('a[title="Add video"]').hide();
					    $('a[title="Add URL"]').hide();
					    $('a[title="Add table"]').hide();
					    $('a[title="Show HTML code"]').hide();
					    $('a[title="Remove styles"]').hide();
					    $('.richText-help').hide();					    
					   	$('.richText-toolbar').hide();
					}
					for(d=0;d<mleList.length;d++){
					
					}
				}
				//$('#overlaysearch').hide();
				//$('#Onloader').hide();
			}
			// this is end or new change code in botla peraiah
			function selectddrval(idval, appendval){
				return $("#"+idval).append(appendval);
			}
               //Botla 
			function isNumber(evt) {
	        //   $(this).val($(this).val().replace(/[^\d].+/, ""));
				evt = (evt) ? evt : window.event;
				var charCode = (evt.which) ? evt.which : evt.keyCode;
				var re = /^-?\d*\.?\d{0,6}$/; 
				var text = $(elem).val();
				
				var isValid = (text.match(re) !== null);			
			/*	if (charcode > 31 && (charCode < 48 || charCode > 57)) {
					return false;
				} 
				if (charcode > 31 && (charcode < 48 || charcode > 57) && charcode != 46) {
		               return false;
		         }
		         if (charcode  != 46 && charcode  != 45 && charcode  != 46 && !(charcode  >= 48 && charcode  <= 57)) {
				    return false;
				  }*/
				return true;
			}
			
			function isDecimal(evt){
			   //var self = $(this);
			  // evt.val(evt.val().replace(/[^0-9\.]/g, ''));
			//   if (evt.shiftKey == true) {
	        //        evt.preventDefault();
	         //   }
	            if (evt.which != 46 && evt.which != 45 && evt.which != 46 && evt.which > 31 && (evt.which >= 48 && evt.which <= 57)) {
				    return false;
				 }
	
	            if ((evt.keyCode >= 48 && evt.keyCode <= 57) || (evt.keyCode >= 96 && evt.keyCode <= 105) || evt.keyCode == 8 || evt.keyCode == 9 || evt.keyCode == 37 || evt.keyCode == 39 || event.keyCode == 46 || evt.keyCode == 189 || evt.keyCode == 190 || evt.keyCode == 45) {
					console.log(evt);
	            } else {
	                evt.preventDefault();
	            }/*     	            
	            if($(this).val().indexOf('.') !== -1 && evt.keyCode == 190)
	                evt.preventDefault();
	  			*/
			}
			function isValidate(e){   
			    var t = e.value;
         		e.value = (t.indexOf(".") >= 0) ? (t.substr(0, t.indexOf(".")) + t.substr(t.indexOf("."), 2)) : t;			   
			}
			
			function GetData(restURL) {
				var def = $.Deferred();
				$.ajax({
					url: _spPageContextInfo.webAbsoluteUrl + restURL,
					async:false,
					contentType: "application/json;odata=verbose",
					headers: { "accept": "application/json;odata=verbose" },
					success: function (data) {
						def.resolve(data);
					},
					error: function (data) {
						def.reject(data);
					}
				});

				return def.promise();
			}
			function uploadFileSP(listName, id, fileArray, fileCount, Id, filename) {
				//var FilesCount = 0;
				var deferred = $.Deferred();
				
				//	var uploadStatus = "";
				//var file = fileArray[0];
				//var getFile = getFileBuffer(file);

				//	getFile.done(function (buffer, status, xhr) {
				//var bytes = new Uint8Array(buffer);
				//var content = new SP.Base64EncodedByteArray();
				if(file == null || file == ''){
					var fileInput = jQuery('#'+Id);
					var fileName = fileInput[0].files[fileCount].name;
				}else{
					var fileName = filename;
				}
				//var parts = fileInput[0].value.split('\\');
				//var fileName = parts[parts.length - 1];			
				var queryUrl = _spPageContextInfo.webAbsoluteUrl + "/_api/lists/GetByTitle('" + listName + "')/items(" + id + ")/AttachmentFiles/add(FileName='" + fileName + "')";
				//var uploadCount = 0;
				$.ajax({
					url: queryUrl,
					type: "POST",
					processData: false,
					contentType: "application/json;odata=verbose",
					data: fileArray,
					async: false,
					headers: {
						"accept": "application/json;odata=verbose",
						"X-RequestDigest": $("#__REQUESTDIGEST").val(),
						"content-length": fileArray.byteLength
					},
					success: function (data) {

						if (fileArray.length > 0) {
							//uploadFileSP("ListName", id, fileArray, fileArray.length);
						}
						else {
							//	alert("Your item has been submitted successfully!");
						}
					},
					error: function (err) {
						alert("Idea has been submitted but some files failed to upload.");
					}
				});
				//deferred.resolve(data);
				//	});

				// getFile.fail(function (err) {
				// 	deferred.reject(err);
				// });
				return deferred.promise();
			}


			function getFileBuffer(i,id, file) {
				var deferred = jQuery.Deferred();
				var fileInput = jQuery('#'+id);
				var reader = new FileReader();

				reader.onloadend = function (e) {
					deferred.resolve(e.target.result, i);
				}
				reader.onerror = function (e) {
					deferred.reject(e.target.error);
				}
				if(file == null || file == ''){
					reader.readAsArrayBuffer(fileInput[0].files[i]);
				}else{					
					reader.readAsArrayBuffer(file.File);
				}
				return deferred.promise();
			}
			var arrFileUpload = [];
			var finalFiles = [];
			var RemoveDuplicate = [];
			//Bind selected attachment in popup
			function bindAttachments(Action,id) {
				arrFileUpload = [];
				//finalFiles =[];
				var fileNum = Action.files.length, initial = 0;
				$.each(Action.files, function (idx, elm) {
					finalFiles[finalFiles.length] = elm;
				});
				RemoveDuplicate = [];
				var arr = finalFiles.filter(function (el) {
					if (RemoveDuplicate.indexOf(el.name) == -1) {
						RemoveDuplicate.push(el.name);
						return true;
					}
					return false;
				});
				arrFileUpload = ReinitializeArray(arr);
			//	$('#Docfilename').empty();
				var bindfile = '';
				Tcounter = 0;
				for (initial; initial < arrFileUpload.length; initial++) {
					/*  bindfile += '<div class="upload-chip" id="Ifile_' + Tcounter + '">';
						bindfile += '<span class="d-flex align-items-center upload-chip-title">';
						bindfile += '<i class="fa fa-paperclip color-sky-blue" aria-hidden="true"></i>';
						bindfile += '<span class="px-2 font-14 upload-chip-title" title=' + RemoveDuplicate[initial] + '>' + RemoveDuplicate[initial] + '</span></span>';
						bindfile += '<button type="button" onclick="RemoveDocument(this.id);" id="Ifile_' + Tcounter + '"" class="btn p-0 upload-chip-delete-btn"><i class="fa fa-times-circle-o text-danger"></i></button></div>';
						//$('#Docfilename').append('<div id="Ifile_' + Tcounter2 + '"><span class="fa-stack fa-lg" style="line-height: 1em; height: 1em;"><i class="fa fa-paperclip" style="font-size: 20px; font-weight: 500;"></i></i><strong class="fa-stack-1x" style="color:#FFF; font-size:12px; margin-top:2px;">' + Tcounter2 + '</strong></span> ' + RemoveDuplicate2[initial] + '&nbsp;&nbsp;<span class="fa fa-close fa-lg closeBtn" style="color:red;"  onclick="RemoveDocument(this.id);" id="Ifile_' + Tcounter2 + '"" title="remove"></span></div>');
					  */
					bindfile += '<div class="approve-process-upload-data-chip upload-chip" id="Ifile_' + Tcounter + '">';
					bindfile += '<i class="fa fa-paperclip color-sky-blue" aria-hidden="true"></i>';
					bindfile += '<span class="px-2 font-14 upload-chip-title" title=' + RemoveDuplicate[initial] + '>' + RemoveDuplicate[initial] + '</span>';
					bindfile += '<i class="fa fa-times-circle-o text-danger" onclick="RemoveDocument(this.id);" id="Ifile_' + Tcounter + '""></i></div>';
					//  bindfile += 

					Tcounter = Tcounter + 1;
				}
				$('#'+id).empty().append(bindfile);
				//   getDocWeight();   // commented to remove file size validaion.
			}


			//remove the attached document
			function RemoveDocument(id, col) {
				var index = id.split('_')[1];
				$("#" + id).remove();
				//delete finalFiles[parseInt(index)];
				finalFiles.splice(parseInt(index), 1);
				if ($('#Docfilename'+col).html() == '') {
					finalFiles = [];
					$("#uploadFileAttach").val('');
				}
				RemoveDuplicate = [];
				var arr = finalFiles.filter(function (el) {
					if (RemoveDuplicate.indexOf(el.name) == -1) {
						RemoveDuplicate.push(el.name);
						return true;
					}
					return false;
				});
				arrFileUpload = ReinitializeArray(arr);
				//$('#Docfilename'+col).remove();
				$('#'+ col).show();
			}

			//Loop on documents to get the details
			function ReinitializeArray(arr) {
				var newArr = [];
				var count = 0;
				//for (var i in arr) 
				for (var i = 0; i < arr.length; i++) {
					newArr[count++] = arr[i];
				}
				return newArr;
			}
			// function uploadFile(id) {
			// 	if ($('#attachmentsupload').val() == "")
			// 		return;

			// 	var fileInput = jQuery('#attachmentsupload');
			// 	var fileCount = fileInput[0].files.length;
			// 	console.log(fileCount);

			// 	for (var i = 0; i < fileCount; i++) {
			// 		console.log(i);
			// 		getFileBuffer(i)
			// 			.done(function (arrayBuffer, index) {
			// 				console.log("Success " + index);
			// 				uploadFileInList(arrayBuffer, id, index);
			// 			})
			// 			.fail(function (error) {
			// 				console.log(error);
			// 				LogError("uploadFile", error);
			// 				alert("Error while uploading file for ID" + id);
			// 			});
			// 	}
			// }
			
function RequestGetdata(Query)
{
    var ResultItems=[];
    var Ownurl =Query;// _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ContactCenter')/items?"+Query+"";  
    $.ajax({  
        url: Ownurl,  
        headers: { Accept: "application/json;odata=verbose" },  
        async:false,  
        success: function (data) 
        { 			
            ResultItems = data.d.results;  
        },
        error: function (data) 
        {  
            console.log("Error in getdata.");
        	console.log(data); 
        }  
    });
    return ResultItems;
}


function ColumnValueByColumnName(QueryResult, _ProcessType) {
	var ListName;
	//var event_pop;
	switch (_ProcessType) {
		case 'ColumnText1': ListName = 	QueryResult[0].ColumnText1; break;
		case 'ColumnText2': ListName = 	QueryResult[0].ColumnText2; break;
		case 'ColumnText3': ListName = 	QueryResult[0].ColumnText3; break;
		case 'ColumnText4': ListName = 	QueryResult[0].ColumnText4; break;
		case 'ColumnText5': ListName = 	QueryResult[0].ColumnText5; break;
		case 'ColumnText6': ListName = 	QueryResult[0].ColumnText6; break;
		case 'ColumnText7': ListName = 	QueryResult[0].ColumnText7; break;
		case 'ColumnText8': ListName = 	QueryResult[0].ColumnText8; break;
		case 'ColumnText9': ListName = 	QueryResult[0].ColumnText9; break;
		case 'ColumnText10': ListName = QueryResult[0].ColumnText10; break;
		case 'ColumnText11': ListName = QueryResult[0].ColumnText11; break;
		case 'ColumnText12': ListName = QueryResult[0].ColumnText12; break;
		case 'ColumnText13': ListName = QueryResult[0].ColumnText13; break;
		case 'ColumnText14': ListName = QueryResult[0].ColumnText14; break;
		case 'ColumnText15': ListName = QueryResult[0].ColumnText15; break;
		case 'ColumnText16': ListName = QueryResult[0].ColumnText16; break;
		case 'ColumnText17': ListName = QueryResult[0].ColumnText17; break;
		case 'ColumnText18': ListName = QueryResult[0].ColumnText18; break;
		case 'ColumnText19': ListName = QueryResult[0].ColumnText19; break;
		case 'ColumnText20': ListName = QueryResult[0].ColumnText20; break;
		case 'ColumnNumber1': ListName = QueryResult[0].ColumnNumber1; break;
		case 'ColumnNumber2': ListName = QueryResult[0].ColumnNumber2; break;
		case 'ColumnNumber3': ListName = QueryResult[0].ColumnNumber3; break;
		case 'ColumnNumber4': ListName = QueryResult[0].ColumnNumber4; break;
		case 'ColumnNumber5': ListName = QueryResult[0].ColumnNumber5; break;
		case 'ColumnNumber6': ListName = QueryResult[0].ColumnNumber6; break;
		case 'ColumnNumber7': ListName = QueryResult[0].ColumnNumber7; break;
		case 'ColumnNumber8': ListName = QueryResult[0].ColumnNumber8; break;
		case 'ColumnNumber9': ListName = QueryResult[0].ColumnNumber9; break;
		case 'ColumnNumber10': ListName = QueryResult[0].ColumnNumber10; break;
		case 'ColumnNumber11': ListName = QueryResult[0].ColumnNumber11; break;
		case 'ColumnNumber12': ListName = QueryResult[0].ColumnNumber12; break;
		case 'ColumnNumber13': ListName = QueryResult[0].ColumnNumber13; break;
		case 'ColumnNumber14': ListName = QueryResult[0].ColumnNumber14; break;
		case 'ColumnNumber15': ListName = QueryResult[0].ColumnNumber15; break;
		case 'ColumnNumber16': ListName = QueryResult[0].ColumnNumber16; break;
		case 'ColumnNumber17': ListName = QueryResult[0].ColumnNumber17; break;
		case 'ColumnNumber18': ListName = QueryResult[0].ColumnNumber18; break;
		case 'ColumnNumber19': ListName = QueryResult[0].ColumnNumber19; break;
		case 'ColumnNumber20': ListName = QueryResult[0].ColumnNumber20; break;
		case 'ColumnDate1': ListName = moment(QueryResult[0].ColumnDate1).format('LL'); break;
		case 'ColumnDate2': ListName = moment(QueryResult[0].ColumnDate2).format('LL'); break;
		case 'ColumnDate3': ListName = moment(QueryResult[0].ColumnDate3).format('LL'); break;
		case 'ColumnDate4': ListName = moment(QueryResult[0].ColumnDate4).format('LL'); break;
		case 'ColumnDate5': ListName = moment(QueryResult[0].ColumnDate5).format('LL'); break;
		case 'ColumnDate6': ListName = moment(QueryResult[0].ColumnDate6).format('LL'); break;
		case 'ColumnDate7': ListName = moment(QueryResult[0].ColumnDate7).format('LL'); break;
		case 'ColumnDate8': ListName = moment(QueryResult[0].ColumnDate8).format('LL'); break;
		case 'ColumnDate9': ListName = moment(QueryResult[0].ColumnDate9).format('LL'); break;
		case 'ColumnDate10': ListName = moment(QueryResult[0].ColumnDate10).format('LL'); break;
		case 'Currency': ListName = QueryResult[0].Currency; break;
		case 'DueDate': ListName = moment(QueryResult[0].DueDate).format('LL'); break;
		case 'Priority': ListName = QueryResult[0].Priority; break;
		case 'YesNo': ListName = QueryResult[0].YesNo; break;
		case 'ColumnMultiline1': ListName = QueryResult[0].ColumnMultiline1; break;
		case 'ColumnMultiline2': ListName = QueryResult[0].ColumnMultiline2; break;
		case 'ColumnMultiline3': ListName = QueryResult[0].ColumnMultiline3; break;
		case 'ColumnMultiline4': ListName = QueryResult[0].ColumnMultiline4; break;
		case 'ColumnMultiline5': ListName = QueryResult[0].ColumnMultiline5; break;
		case 'ColumnMultiline6': ListName = QueryResult[0].ColumnMultiline6; break;
		case 'ColumnMultiline7': ListName = QueryResult[0].ColumnMultiline7; break;
		case 'ColumnMultiline8': ListName = QueryResult[0].ColumnMultiline8; break;
		case 'ColumnMultiline9': ListName = QueryResult[0].ColumnMultiline9; break;
		case 'ColumnMultiline10': ListName = QueryResult[0].ColumnMultiline10; break;
		case 'Checkbox1': ListName = QueryResult[0].Checkbox1; break;
		case 'Checkbox2': ListName = QueryResult[0].Checkbox2; break;
		case 'Checkbox3': ListName = QueryResult[0].Checkbox3; break;
		case 'Checkbox4': ListName = QueryResult[0].Checkbox4; break;
		case 'Checkbox5': ListName = QueryResult[0].Checkbox5; break;		
		case 'ColumnPeople1': ListName = QueryResult[0].ColumnPeople1; break;
		case 'ColumnPeople2': ListName = QueryResult[0].ColumnPeople2; break;
		case 'ColumnPeople3': ListName = QueryResult[0].ColumnPeople3; break;
		case 'ColumnPeople4': ListName = QueryResult[0].ColumnPeople4; break;
		case 'ColumnPeople5': ListName = QueryResult[0].ColumnPeople5; break;
		case 'AutoSerialNumber': ListName = QueryResult[0].AutoSerialNumber; break;
	}
	return ListName;
}


		</script>
		
<script type="text/javascript">

	$('#SignTextRadio[name=SignTypeRadio]').change(function () {
		if ($('#SignTextRadio[name=SignTypeRadio]:checked')) {
			$('.signature-box').addClass('d-block');
            $('.signature-box').removeClass('d-none');
            $('.drag-drop-box, .draw-signature-box').removeClass('d-block');
            $('.drag-drop-box, .draw-signature-box').addClass('d-none');
		}
	});

	
	$('#SignImageRadio[name=SignTypeRadio]').change(function () {
		if ($('#SignImageRadio[name=SignTypeRadio]:checked')) {
			$('.drag-drop-box').addClass('d-block');
            $('.drag-drop-box').removeClass('d-none');
            $('.signature-box, .draw-signature-box').removeClass('d-block');
            $('.signature-box, .draw-signature-box').addClass('d-none');
		}
	});


	$('#SignDrawRadio[name=SignTypeRadio]').change(function () {
		if ($('#SignDrawRadio[name=SignTypeRadio]:checked')) {
			$('.draw-signature-box').addClass('d-block');
            $('.draw-signature-box').removeClass('d-none');
            $('.signature-box, .drag-drop-box').removeClass('d-block');
            $('.signature-box, .drag-drop-box').addClass('d-none');
		}
	});
		
	
	function ClearTextSignature()
	{
		$("#SingTextType").val('');
		$("#RemarksApprovalContent").val('');
	}
	
	function ClearImageSignature()
	{
		$(".approval_image_preview").css("display", "none");
		$("#file").val(null);
		$("#RemarksApprovalContent").val('');
		$(".custom-image-label").css("display", "block");
		$(".approval_image_preview").css("display", "none");
		$('.preup_load').toggleClass('ative_now');
		SelectedSignImages='';
	}

	function ClearDrawSignature()
	{
		$("#RemarksApprovalContent").val('');
		$sigdiv.jSignature('reset');
	}


function ApprovedRequest()
{
	AskNextApproversARR=[];
	var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,Approvers/Title,Approvers/EMail,ActionTakenby/Title,ActionTakenby/EMail,Author/Title,Author/EMail,AttachmentFiles&$expand=Approvers,ActionTakenby,Author,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"' and ApproverDecidingStep eq '"+window.atob(titanForWork.getQueryStringParameter('StepNo'))+"'&$orderby=Sequence_No asc";
	var QueryResult = RequestGetdata(Query);
	var ExStatus = false;
	if(QueryResult.length>0)
	{		
		for(var k=0; k<QueryResult.length; k++)
		{
			var StakeHolder = EnsureUserMulti($('#AskapprovalActionModal'+QueryResult[k].ID).children().children().attr('id'));
			if(StakeHolder.length>0)
			{    
				AskNextApproversARR.push({'StepName' : QueryResult[k].StepName, 'StepApprovers' : StakeHolder,'StepId':QueryResult[k].ID });							
			}
			if(StakeHolder.length == 0)
			{
				alert("Please enter "+QueryResult[k].StepName +" approvers.");
				ExStatus = false;
				break;
			}
			else
			{
				ExStatus = true;
				var EnsureActive = EnsureUserValidate($('#AskapprovalActionModal'+QueryResult[k].ID).children().children().attr('id'));
				if(EnsureActive.length>0)
				{
					for(var k=0; k<EnsureActive.length; k++)
					{
						var QueryResultCheckActive=[];
						if(EnsureActive[k].Type == 'Tenant')
						{
							var QueryCheckActive =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Employees')/items?$select=*&$filter=LogonName/EMail eq '"+EnsureActive[k].Email+"' and Status eq 'Active'";
								QueryResultCheckActive = RequestGetdata(QueryCheckActive);
						}
						else
						{
							var QueryCheckActive =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ExternalUsers')/items?$select=*&$filter=LoginName/EMail eq '"+EnsureActive[k].Email+"' and Status eq 'Active'";
								QueryResultCheckActive = RequestGetdata(QueryCheckActive);
						}
							
						if(QueryResultCheckActive.length>0)
						{
							ExStatus = true;
						}
						else
						{
							ExStatus = false;
							alert(EnsureActive[k].Name+ " is not a valid user");
							return false;
							break;
						}															
					}						
				}	
			}					
		}
	}
	else
	{
		ExStatus = true;
	}
	//$('#overlaysearch').show();
	ActiveBtnStatus = 'ApprovedSign';
	if(ExStatus == true)
	{
		if($("#ApprovedChkbox").prop('checked') == true)
		{				
			var ActiveSingTypeRadio = $('input[name="SignTypeRadio"]:checked').val();
        	if(ActiveSingTypeRadio == 'SignText')
        	{
        		var SignText = $("#SingTextType").val();
        			SignText.trim();
        		if(SignText.length>0)
        		{   
        			var node = document.getElementById('SingTextType');
					domtoimage.toPng(node).then (function (dataUrl) {
						var ImgUrl = dataUrl;
						var img = new Image();
			    		var file = dataURLtoFile(ImgUrl, $("#SingTextType").val().trim() + window.btoa("_AdaptSignature") + ".png");
			    		SignImage=[];
			    		SignImage.push(file);
		    			saverecord();
					})
        			//saverecord();
        		}
        		else
        		{
        			alert("Please Type Your Signature.");
        		}
        	}
        	else if(ActiveSingTypeRadio == 'SignImage')
        	{
        		if(SignImage.length>0 || SelectedSignImages != '')
        		{
        			var node = document.getElementById('SignImgPreview');
					domtoimage.toPng(node).then (function (dataUrl) {
						var ImgUrl = dataUrl;
						var img = new Image();
    					var file = dataURLtoFile(ImgUrl, _spPageContextInfo.userDisplayName + window.btoa("_AdaptSignature") + ".png");
    					SignImage=[];
    					SignImage.push(file);
    					
    					saverecord();
    					//Approvedreq(Action);
					})        			
        			//saverecord();        			
        		}
        		else
        		{
        			alert("Please Select Your Signature Image.");
        		}
        	}
        	else if(ActiveSingTypeRadio == 'SignDraw')
        	{
        		var DrawSingValue = $sigdiv.jSignature('getData', "default");
        		var img = new Image();
    			var file = dataURLtoFile(DrawSingValue, _spPageContextInfo.userDisplayName + window.btoa("_AdaptSignature") + ".png");
    			SignImage=[];
    			SignImage.push(file);
    			
    			alert(SignImage[0].size);
        		if(SignImage[0].size>1000)
        		{
        			saverecord();
        			//setTimeout(function () {
        			//saverecord();
        			//$('#overlaysearch').hide()
					//}, 100);					

        		}
        		else
        		{
        			setTimeout(function () {
        			alert("Please Draw Your Signature.");
        			//$('#overlaysearch').hide()
					}, 100);					

        		}
        	}				
		}
		else
		{
			alert("Select Approved Checkbox!");
		}
	}
}
	
	function removeUserBox(Action, userEmail, UserName, UserId)
	{
    	$(Action).parents('.col-md-6').remove();
    	    
    	ApproversListForward = jQuery.grep(ApproversListForward, function(value) {
  			return value != UserId;
		});
	}


function dataURLtoFile(dataurl, filename) {
    var arr = dataurl.split(','),
        mime = arr[0].match(/:(.*?);/)[1],
        bstr = atob(arr[1]), 
        n = bstr.length, 
        u8arr = new Uint8Array(n);
            
    while(n--){
        u8arr[n] = bstr.charCodeAt(n);
    }
        
    return new File([u8arr], filename, {type:mime});
}



</script>
		
		
<script type="text/javascript">
  
$(function(){

  $('.muti_dropbox li input[type="radio"]').click(function(){
     var storeval = $('.muti_dropbox li input[type="radio"]:checked');
     if(storeval.length>0){
      $(this).siblings('.hideboxs').slideToggle();
      $(this).parent('li').siblings().find('.hideboxs').slideUp();
    }
  })
 
  $('.tottglinbtn').click(function(){

    $(this).toggleClass('activingss');
    $('.increase_effect').toggleClass('activingss');

  });  
  
  
  initializePeoplePickerStakeholder("NewStakeholderList");
  initializePeoplePickerStakeholder("ReturnStakeholderList");
  
  


});


function initializePeoplePicker(peoplePickerElementId,PersonValidation) 
{
	var AllowedUser = PersonValidation == 'Single' ? false : true; 
	var schema = {};
	schema['PrincipalAccountType'] = 'User,DL,SecGroup,SPGroup';
	schema['SearchPrincipalSource'] = 15;
	schema['ResolvePrincipalSource'] =15;
	schema['AllowMultipleValues'] = AllowedUser;
	schema['MaximumEntitySuggestions'] =50;
	schema['Width'] = '280px';
	this.SPClientPeoplePicker_InitStandaloneControlWrapper(peoplePickerElementId,
	null, schema);
}

function initializePeoplePickerStakeholder(peoplePickerElementId) 
{
	var schema = {};
	schema['PrincipalAccountType'] = 'User,DL,SecGroup,SPGroup';
	schema['SearchPrincipalSource'] = 15;
	schema['ResolvePrincipalSource'] =15;
	schema['AllowMultipleValues'] = true;
	schema['MaximumEntitySuggestions'] =50;
	schema['Width'] = '280px';
	this.SPClientPeoplePicker_InitStandaloneControlWrapper(peoplePickerElementId,
	null, schema);
}


function onChangeTask(HTMLID, PplPickerId, UserBoxId) 
{
	var picker = SPClientPeoplePicker.SPClientPeoplePickerDict[HTMLID];
    picker.OnValueChangedClientScript = function (elementId, userInfo) {
    user = '';
    if (userInfo.length > 0)
    {
    	tempUserId = ensureUser($('#ForwardUserPicker1').children().children().attr('id'));
    	var arraycontainsturtles = (ApproversListForward.indexOf(tempUserId) > -1);
        if(arraycontainsturtles == false)
        {
        	var EnsureActive = EnsureUserValidate($('#ForwardUserPicker1').children().children().attr('id'));
			if(EnsureActive.length>0)
			{
				for(var k=0; k<EnsureActive.length; k++)
				{
					var QueryResultCheckActive=[];
					if(EnsureActive[k].Type == 'Tenant')
					{
						var QueryCheckActive =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Employees')/items?$select=*&$filter=LogonName/EMail eq '"+EnsureActive[k].Email+"' and Status eq 'Active'";
							QueryResultCheckActive = RequestGetdata(QueryCheckActive);
					}
					else
					{
						var QueryCheckActive =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ExternalUsers')/items?$select=*&$filter=LoginName/EMail eq '"+EnsureActive[k].Email+"' and Status eq 'Active'";
							QueryResultCheckActive = RequestGetdata(QueryCheckActive);
					}
							
					if(QueryResultCheckActive.length>0)
					{
						ExStatus = true;
						ApproversListForward.push(tempUserId);
           				var tempEmail = userInfo[0].Key.split('|')[2];
          				if (tempEmail.includes('#') == true) 
           				{
           				    tempEmail = tempEmail.replace("#ext#@adaptindia.onmicrosoft.com", '');
           	    			tempEmail = tempEmail.replace("_", '@');
           				}
           				NewAddedUser.push({	Name : userInfo[0].DisplayText,
           									Email:tempEmail});
           				var attachment = _spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' + escapeProperly(tempEmail);           
           				var ForwardUserImg='';
            				ForwardUserImg += "<div class='col-md-6 col-sm-6 userBoxParent'>";
            				ForwardUserImg += "<div class='members-card border-0'>";
							ForwardUserImg += "<div class='members-card-head'>";
            				ForwardUserImg += "<img src='"+attachment+"'>";
            				ForwardUserImg += "</div>";
            				ForwardUserImg += "<div class='members-card-body'>";
            				ForwardUserImg += "<div class='members-card-body-info text-ellipsis'>";
            				ForwardUserImg += "<h3 class='member-name text-ellipsis'>"+userInfo[0].DisplayText+"</h3>";
            				ForwardUserImg += "<p class='member-email text-ellipsis mb0'>"+tempEmail+"</p>";
            				ForwardUserImg += "</div>";
            				ForwardUserImg += "<a class='btn remove-group-btn remove-btn close close-round' onclick='removeUserBox(this, \"" + tempEmail + "\", \"" + userInfo[0].DisplayText + "\", " + tempUserId + ")'><i class='fa fa-times'></i></a>";
            				ForwardUserImg += "</div>";
            				ForwardUserImg += "</div>";
            				ForwardUserImg += "</div>";           
            	
            				$("#" + UserBoxId).append(ForwardUserImg);
            				EmptyPeoplePicker(PplPickerId);
					}
					else
					{
						ExStatus = false;
						EmptyPeoplePicker(PplPickerId);
						alert(EnsureActive[k].Name+ " is not a valid user");
						return false;
						break;
					}															
				}						
			}					
        	
		}
        else if(arraycontainsturtles == true)
        {
          	EmptyPeoplePicker(PplPickerId);
           	alert("User already exists!!");
        }
	}
	};
}


function ensureUser(ID) 
{
	var UserId =0;    
    var peoplePickerTopDivId = ID;
    var peoplePicker = 
    this.SPClientPeoplePicker.SPClientPeoplePickerDict[peoplePickerTopDivId];
    var users = peoplePicker.GetAllUserInfo();
    var arryuser = users[0];
    if(arryuser) 
    {
    	var payload = { 'logonName': arryuser.Key}; 
    	$.ajax({
    	    url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/ensureuser",
    	    type: "POST",
    	    async:false,
    	    contentType: "application/json;odata=verbose",
    	    data: JSON.stringify(payload),
    	    headers: {
    	        "X-RequestDigest": $("#__REQUESTDIGEST").val(),
    	        "accept": "application/json;odata=verbose"
    	            },
        	success: function(data, status, xhr) 
        	{     
         		UserId = data.d.Id;          
        	},
        	error: function(xhr, status, error) 
        	{  
        	
        	}
    	}); 
    }   
    else 
    {
        UserId = 0;
    } 
   	return UserId;    
}


function EmptyPeoplePicker(peoplePickerId) 
{
    var peoplePicker = this.SPClientPeoplePicker.SPClientPeoplePickerDict[peoplePickerId + "_TopSpan"];
   	peoplePicker.DeleteProcessedUser();
}

var QueryResultQuee=[];
function ADDStakeHolder()
{
	QueryResultQuee=[];
	if($('ul.nav-pills').find('li.active')[0].id == 'addstakeholders-LI')
	{
		if(ApproversListForward.length>0)
		{
			var QueryDataStep =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,Status, Approvers/Title,Approvers/EMail,Approvers/ID,ActionTakenby/Title, ActionTakenby/Id, Modified, AttachmentFiles&$expand=Approvers,AttachmentFiles,ActionTakenby&$filter=RequestID eq "+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"&$orderby=Sequence_No asc";
			var QueryResult = RequestGetdata(QueryDataStep);

			var ActiveQueeApproversList = $.grep(QueryResult , function(v) {
				return v.StepName == window.atob(titanForWork.getQueryStringParameter('StepNo')) || v.Status == "Pending" && v.Status == "Rejected"  
			});
			
			var listName="ApprovalProcessQueue";
			var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+listName+"')/items('"+ActiveQueeApproversList[0].ID+"')";
			var item='';
				item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ApproversId':{'results':ApproversListForward}};				
							
			var ExStatus = UniversalUpdateApprovalProcess(listName,item,ActiveQueeApproversList[0].ID,SiteUrl);
			
			if(ExStatus == true)
			{
				var d = new Date();
				var ISODATE = d.toISOString().substring(0, 10);
				var listName="ApprovalProcessList";	
				var item ='';	
					item={'__metadata': { type: 'SP.Data.'+listName+'ListItem'},'ApproversId':{'results':ApproversListForward},'Status':'Forwarded','ApprovedById':_spPageContextInfo.userId,'ApprovedDate':ISODATE};				
								
				var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('ApprovalProcessList')/items('"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"')";
				var ExStatus = UniversalUpdateApprovalProcess(listName,item,window.atob(titanForWork.getQueryStringParameter('RecNo')),SiteUrl);
				
				if(ExStatus == true)
				{
					if(NewAddedUser.length>0)
					{
						GenerateForwardMailDesign()
					}
					else
					{
						alert('Stakeholders Action Completed.');
						$('#forward_stpings').modal('hide');
						window.location.href = titanForWork.getQueryStringParameter('sourcelocation');
					}
				}
				else
				{
					alert('Stakeholders Action Failed.');
				}
			}
			else
			{
				alert('Stakeholders Action Failed.');
			}
		}
		else
		{
			alert('Select Approvers First.')
		}	
	}
	else if ($('ul.nav-pills').find('li.active')[0].id == 'successor_processing-LI')
	{	
		if(Validations() == true)
		{
			var StepName = $("#StepNameText").val();
			var ActionReq  = $("#ActionControlDDL").val();
			var Remarks = $("#StepsRemarks").val();
			var StakeHolder = EnsureUserMulti($('#NewStakeholderList').children().children().attr('id'));
			var SignPosRadio = $('input[name="optionalsec"]:checked').val();
			var PosSign='';
				if(SignPosRadio == 'At Bottom most')
				{
					PosSign = 'BottomMost'
				}
				else if(SignPosRadio == 'At Bottom of')
				{
					PosSign = $("#SignPosDDL").val();
				}
			var Query = "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,RequestID/ID,AttachmentFiles&$expand=RequestID/ID,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"'&$orderby=Sequence_No asc";
				QueryResultQuee = RequestData(Query);
			var FilteredRec2 = $.grep(QueryResultQuee, function(v) {
				return v.StepName == window.atob(titanForWork.getQueryStringParameter('StepNo'))
			});
		
			var NewStepNo=FilteredRec2[0].Sequence_No;
				NewStepNo = parseInt(NewStepNo)+1;
		
			var item='';	
				item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'Sequence_No':NewStepNo,'Title':'Step Approvers','ApproversId':{'results':StakeHolder},'StepName':StepName,'RequestIDId':parseInt(window.atob(titanForWork.getQueryStringParameter('RecNo'))),'TemplateIDId':CurrTenplateID,'ActionRequired':ActionReq,'SignaturePosition':PosSign};
		
			var dfd = $.Deferred()
				$.ajax({
					url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('ApprovalProcessQueue')/items",
					type: "POST",
					async: false,
					headers: {
						"accept": "application/json;odata=verbose",
						"X-RequestDigest": $("#__REQUESTDIGEST").val(),
						"IF-MATCH": "*",						
						"content-Type": "application/json;odata=verbose"
					},
					data: JSON.stringify(item),
					success: function (data) 
					{				
						var ResponceId = data.d.ID;
						var FilteredRec2 = $.grep(QueryResultQuee, function(v) {
							return v.StepName == window.atob(titanForWork.getQueryStringParameter('StepNo'))
						});
	
						var Query = "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,RequestID/ID,AttachmentFiles&$expand=RequestID/ID,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"' and ID ne '"+data.d.ID+"' and Sequence_No gt '"+FilteredRec2[0].Sequence_No+"' &$orderby=Sequence_No asc";
						var QueryResult = RequestData(Query);
						var SeqCounter = 0;
						if(QueryResult.length>0)
						{
							for(var x=0; x<QueryResult.length; x++)
							{
								var NewSequence = QueryResult[x].Sequence_No;
									NewSequence = parseInt(NewSequence)+1;
						
								var listName="ApprovalProcessQueue";
								var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+listName+"')/items('"+QueryResult[x].ID+"')";
								var item='';
									item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'Sequence_No':NewSequence};						
								var ExStatus = UpdateApprovalProcessSequence(listName,item,QueryResult[x].ID,SiteUrl);					
								
							}				
						}
				
						
						if($("#ActionControlDDL").val() == 'Edit Data' || $("#ActionControlDDL").val() == 'Edit Sign')
						{
							var yourArray=[];
							$("input:checkbox[name='PartialTableChkboxSteps']:checked").each(function(){
								yourArray.push($(this).val());
							});
					
							if(yourArray.length>0)
							{
								for(var w=0; w<yourArray.length; w++)
								{
									var listName="ApprovalTemplateEditScope";			
									var item={'__metadata': { type: 'SP.Data.'+listName+'ListItem'},'Title':$("#StepNameText").val(),'ScopeType':'Forward','StepNo':ResponceId.toString(),'TemplateIDId':parseInt(CurrTenplateID), 'StepType':'Process Steps','EditScope':$("#ActionControlDDL").val(),'ColumnIDId':parseInt(yourArray[w])};
									ApprovalTemplateEditScopeSet(listName,item,);
								}
							}
						}
						alert('Successor Step Action Completed.');
						$('#forward_stpings').modal('hide');				
					},
					error: function (error,data) 
					{
						alert(JSON.stringify(error));
					}
				});
			}
		}
		else if($('ul.nav-pills').find('li.active')[0].id == 'Review_Returns-LI')
		{
			var UserFwdList = [];
			var UserFwdReturn = NewForwardRevert; //EnsureUserMulti($('#ReturnStakeholderList').children().children().attr('id'));
				UserFwdList =   NewForwardRevert;			
			var UserFwdReturnMsg = $("#ForwardRetMessage").val();
			var RestrictView = $('#RestrictviewChkbox').is(':checked');
			var ApprovalQueueNo = window.atob(titanForWork.getQueryStringParameter('StepID'));
			
			var QueryDataStep =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessList')/items?$select=*,ForwardedUser/Id,ForwardedUser/Title,ForwardedUser/EMail&$expand=ForwardedUser&$filter=ID eq "+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"";
			var QueryStepIdData = RequestGetdata(QueryDataStep);
			
			if(UserFwdReturn.length>0)
			{				
				var RevtUserList=[];
				for(var x=0; x<UserFwdReturn.length; x++)
				{
					RevtUserList.push(parseInt(UserFwdReturn[x]));
				}
				
				var ListName="ApprovalProcessQueue";
				var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+ListName+"')/items('"+ApprovalQueueNo+"')";
				var Items='';
					Items={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'Forwarded':'true','ForwardedUserId':{'results':RevtUserList}};						
				var ExStatusPrQuee = UpdateApprovalProcessForward(ListName,Items,ApprovalQueueNo,SiteUrl);
				
				
				// Update ApprovalProcessList Data
				var ListName="ApprovalProcessList";
				var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+ListName+"')/items('"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"')";
				var Items='';
					Items={'__metadata': { type: 'SP.Data.ApprovalProcessListListItem'},'ForwardedUserId':{'results':RevtUserList},'Forwarded':'true'};						
				var ExStatusPrList = UpdateApprovalProcessForward(ListName,Items,window.atob(titanForWork.getQueryStringParameter('RecNo')),SiteUrl);
				
							
				if(QueryStepIdData[0].ForwardedUser.__deferred == undefined)
				{
					for(var w=0; w<QueryStepIdData[0].ForwardedUser.results.length; w++)
					{
						const index = UserFwdList.indexOf(QueryStepIdData[0].ForwardedUser.results[w].Id);
						if (index > -1) 
						{
  							UserFwdList.splice(index, 1);
  						}				
					}				
				}
						
				var SetStatusCount = 0;
				for(var i=0; i<UserFwdReturn.length; i++)
				{
					var listName="ApprovalProcessForward";			
					var item={'__metadata': { type: 'SP.Data.'+listName+'ListItem'},'Title':'ProcessForward','ForwardedById':_spPageContextInfo.userId,'ForwardedToId':UserFwdReturn[i],'ForwardedRemarks':UserFwdReturnMsg,'ApprovalQueueIDId':parseInt(ApprovalQueueNo),'RestrictViewToOthers':RestrictView};
					var SetStatus = ApprovalProcessForwardSet(listName,item,);
					SetStatusCount = parseInt(SetStatusCount)+parseInt(SetStatus);			
				}
				
				if(ExStatusPrQuee == true && ExStatusPrList == true && SetStatusCount == UserFwdReturn.length)
				{					
					alert("Action taken successfully.");
					window.location.replace("approvals.aspx");					
				}
			}		
		}
	}



function Validations()
{
	var StepName = $("#StepNameText").val();
	var StakeHolder = EnsureUserMulti($('#NewStakeholderList').children().children().attr('id'));
	var ActionReq  = $("#ActionControlDDL").val();
    if (StepName.trim() == '') 
    {
        alert("Please Enter Step Name.");
        $("#StepNameText").focus();
        return false;
    }
    else if (StakeHolder.length == 0) 
    {
        alert("Please Enter StakeHolders.");
        return false;
    }
    else if (ActionReq == 'Edit Data' || ActionReq == 'Edit Sign')
    {
    	var yourArray=[];
		$("input:checkbox[name='PartialTableChkboxSteps']:checked").each(function(){
			yourArray.push($(this).val());
		});
		if(yourArray.length == 0)
		{
        	alert("Please Select Editable Fields.");        
        	return false
        }
    }       
    return true;
}



function EnsureUserMulti(ID) 
{
	var UserId =[];    
    var peoplePickerTopDivId = ID;
    var peoplePicker = 
    this.SPClientPeoplePicker.SPClientPeoplePickerDict[peoplePickerTopDivId];
    var users = peoplePicker.GetAllUserInfo();
    for(var i=0; i<users.length; i++)
    {
    	var arryuser = users[i];
    	if(arryuser) 
    	{
    		var payload = { 'logonName': arryuser.Key}; 
    		$.ajax({
    		    url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/ensureuser",
    		    type: "POST",
    		    async:false,
    		    contentType: "application/json;odata=verbose",
    		    data: JSON.stringify(payload),
    		    headers: {
    		        "X-RequestDigest": $("#__REQUESTDIGEST").val(),
    		        "accept": "application/json;odata=verbose"
    		            },
        		success: function(data, status, xhr) 
        		{     
        	 		var Users = data.d.Id;
        	 		UserId.push(Users)
        	 		          
        		},
        		error: function(xhr, status, error) 
        		{  
        		
        		}
    		}); 
    	}    	   
    	else 
    	{
    	    UserId = 0;
    	}
    } 
   	return UserId;    
}




var SelectedPrtableSteps=[];
function LoadPartialTableSteps()
{	
	$("#TableFieldsListSteps").empty();
	SelectedPrtableSteps=[];
	var ResultItems=[];
	//var Ownurl =_spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalTemplateSetup')/items?$filter=TemplateID eq '"+CurrTenplateID+"'&$orderby=SequenceNo asc";  
	var Ownurl =_spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalTemplateEditScope')/items?$select=*,ColumnID/Title,ColumnID/ID&$expand=ColumnID&$filter=TemplateID eq '"+CurrTenplateID+"' and StepID/StepName eq '"+window.atob(titanForWork.getQueryStringParameter('StepNo'))+"'&$orderby=ColumnID asc";  
    $.ajax({  
       url: Ownurl,  
       headers: { Accept: "application/json;odata=verbose" },  
       async:true,  
       success: function (data) 
       {debugger
           ResultItems = data.d.results;
           var TableHTML='';
           //var SignposDesign ='';
           
			if(ResultItems.length > 0)
			{
				for(var i=0; i<ResultItems.length; i++)
            	{
           			//if(ResultItems[i].ColumnType!="FixedText" && ResultItems[i].ColumnType!="Header")
           			//{

	               	   	TableHTML = TableHTML +	"<tr>"+
	           		        						"<td>"+ResultItems[i].ColumnID.Title+"</td>"+
	           		        						"<td><input type='checkbox' name='PartialTableChkboxSteps' style='height: 17px; width: 17px;' value='"+ResultItems[i].ColumnID.ID+"'></td>"+
	        							       	"</tr>";
	        		//}            
				}
			}
						
			
			$("#TableFieldsListSteps").empty().append(TableHTML);  
        },
        error: function (data) 
        {  debugger
            console.log("Error in getdata.");
        }  
    });
   
}


function SetTableFieldsListSteps()
{
	var yourArray=[];
	$("input:checkbox[name='PartialTableChkboxSteps']:checked").each(function(){
		yourArray.push($(this).val());
	});
	
	if(yourArray.length>0)
	{
		$('#editablefild').modal('hide');
	}
	else
	{
		alert('Select Table Fields first.')
	}
}


function ClearTableFieldsListSteps()
{
	$('input:checkbox[name="PartialTableChkboxSteps"]').removeAttr('checked');
}


function SetDisplayPrTable4Approvers(Action)
{
	if(Action == 'Edit Data')
	{
		$("#editablefildStepsDIV").css("display", "block");
	}
	else if(Action == 'Edit Sign')
	{
		$("#editablefildStepsDIV").css("display", "block");
	}
	else
	{
		$("#editablefildStepsDIV").css("display", "none");
	}
}



function LoadColumnSignPos()
{	
	var ResultItems=[];
	var Ownurl =_spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalTemplateSetup')/items?$filter=TemplateID eq '"+CurrTenplateID+"'&$orderby=Title asc";  
    $.ajax({  
       url: Ownurl,  
       headers: { Accept: "application/json;odata=verbose" },  
       async:true,  
       success: function (data) 
       {
			ResultItems = data.d.results;          
           	var SignposDesign ='';           
			if(ResultItems.length > 0)
			{
				for(var i=0; i<ResultItems.length; i++)
            	{
           			if(ResultItems[i].ColumnType!="FixedText" && ResultItems[i].ColumnType!="Header")
           			{
           				SignposDesign = SignposDesign +"<option>"+ResultItems[i].Title+"</option>";
	          		}            
				}
			}						
			$("#SignPosDDL").empty().append(SignposDesign);  
        },
        error: function (data) 
        {  
            console.log("Error in getdata.");
        }  
    });    
    SetModalDefaultState(); // Set Control on default state.
    
    var QueryDataStep =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessList')/items?$select=*,ForwardedUser/Id,ForwardedUser/Title,ForwardedUser/EMail&$expand=ForwardedUser&$filter=ID eq "+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"";
	var QueryStepIdData = RequestGetdata(QueryDataStep);
	
	if(QueryStepIdData[0].ActionRequired == 'Edit & Sign')
	{
		$("#ActionControlDDL").empty();
		$("#ActionControlDDL").append($("<option></option>").val('Edit & Sign').html('Edit & Sign'));
		$("#ActionControlDDL").append($("<option></option>").val('Edit & Approve').html('Edit & Approve'));
		$("#ActionControlDDL").append($("<option></option>").val('Edit Only').html('Edit Only'));
		$("#ActionControlDDL").append($("<option></option>").val('Review and Sign').html('Review and Sign'));
		$("#ActionControlDDL").append($("<option></option>").val('Review Only').html('Review Only'));
		$("#ActionControlDDL").val(QueryStepIdData[0].ActionRequired);
	}
	else if(QueryStepIdData[0].ActionRequired == 'Edit & Approve')
	{
		$("#ActionControlDDL").empty();
		$("#ActionControlDDL").append($("<option></option>").val('Edit & Approve').html('Edit & Approve'));
		$("#ActionControlDDL").append($("<option></option>").val('Edit Only').html('Edit Only'));
		$("#ActionControlDDL").append($("<option></option>").val('Review Only').html('Review Only'));
		$("#ActionControlDDL").val(QueryStepIdData[0].ActionRequired);
	}
	else if(QueryStepIdData[0].ActionRequired == 'Edit Only')
	{
		$("#ActionControlDDL").empty();
		$("#ActionControlDDL").append($("<option></option>").val('Edit Only').html('Edit Only'));
		$("#ActionControlDDL").append($("<option></option>").val('Review Only').html('Review Only'));
		$("#ActionControlDDL").val(QueryStepIdData[0].ActionRequired);
	}
	else if(QueryStepIdData[0].ActionRequired == 'Review & Sign' || QueryStepIdData[0].ActionRequired == 'Review and Sign')
	{
		$("#ActionControlDDL").empty();
		$("#ActionControlDDL").append($("<option></option>").val('Review and Sign').html('Review and Sign'));
		$("#ActionControlDDL").append($("<option></option>").val('Review Only').html('Review Only'));
		$("#ActionControlDDL").val(QueryStepIdData[0].ActionRequired);
	}
	else if(QueryStepIdData[0].ActionRequired == 'Review Only')
	{
		$("#ActionControlDDL").empty();
		$("#ActionControlDDL").append($("<option></option>").val('Review Only').html('Review Only'));
		$("#ActionControlDDL").val(QueryStepIdData[0].ActionRequired);
	}
	else
	{	
		$("#ActionControlDDL").empty();
	}
	
	NewForwardRevert=[];
	if(QueryStepIdData[0].ForwardedUser.__deferred == undefined)
	{
		var ForwardUserImg='';
		for(var w=0; w<QueryStepIdData[0].ForwardedUser.results.length; w++)
		{
			NewForwardRevert.push(QueryStepIdData[0].ForwardedUser.results[w].Id);
			var attachment = _spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' + escapeProperly(QueryStepIdData[0].ForwardedUser.results[w].EMail);           
           	ForwardUserImg += "<div class='col-md-6 col-sm-6 userBoxParent'>";
            ForwardUserImg += "<div class='members-card border-0'>";
			ForwardUserImg += "<div class='members-card-head'>";
            ForwardUserImg += "<img src='"+attachment+"'>";
            ForwardUserImg += "</div>";
            ForwardUserImg += "<div class='members-card-body'>";
            ForwardUserImg += "<div class='members-card-body-info text-ellipsis'>";
            ForwardUserImg += "<h3 class='member-name text-ellipsis'>"+QueryStepIdData[0].ForwardedUser.results[w].Title+"</h3>";
            ForwardUserImg += "<p class='member-email text-ellipsis mb0'>"+QueryStepIdData[0].ForwardedUser.results[w].EMail+"</p>";
            ForwardUserImg += "</div>";
            //ForwardUserImg += "<a class='btn remove-group-btn remove-btn close close-round' onclick='RemoveUserBoxRevert(this, \"" + QueryStepIdData[0].ForwardedUser.results[w].EMail+ "\", \"" + QueryStepIdData[0].ForwardedUser.results[w].Title + "\", "+QueryStepIdData[0].ForwardedUser.results[w].Id+ ")'><i class='fa fa-times'></i></a>";
            ForwardUserImg += "</div>";
            ForwardUserImg += "</div>";
            ForwardUserImg += "</div>";    
			
		}
		$("#ListReturnForwardUser").empty().append(ForwardUserImg);	
	}
	else
	{
	
	}   
    
}


function SetDisplayPosBox(Action)
{
	if(Action.value == 'At Bottom of')
	{
		$("#SignPosDDL").css("display", "block");
	}
	else if(Action.value == 'At Bottom most')
	{
		$("#SignPosDDL").css("display", "none");
	}
}


function UpdateApprovalProcessSequence(listName,item,dataid,SiteUrl)  
{
	var ActionListStatus=false;
   	var Responce="";
   	$.ajax({  
		url: SiteUrl,
    	type: "POST",  
    	async:true,
    	data: JSON.stringify(item),         
    	headers:  
    	{  
    		"Accept": "application/json;odata=verbose",  
    	    "Content-Type": "application/json;odata=verbose",  
    	    "X-RequestDigest": $("#__REQUESTDIGEST").val(),  
    	    "IF-MATCH": "*",  
    	    "X-HTTP-Method": "MERGE"  
    	},  
    	success: function(data)
    	{ 	
    	  	ActionListStatus=true;        	
    	},  
    	error: function(data) 
    	{  
    		Responce=data;
    	    console.log("Error in UniversalUpdate.");
    	  	console.log(data);  
    	}  
    }); 
    return ActionListStatus;    
}



function ApprovalTemplateEditScopeSet(listName,item) 
{	
	$.ajax({
		url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('"+listName+"')/items",
		type: "POST",
		contentType: "application/json;odata=verbose",
		data: JSON.stringify(item),
		async: true,
		headers: 
		{
			"Accept": "application/json;odata=verbose",
			"X-RequestDigest": $("#__REQUESTDIGEST").val()
		},
		success: function (data)
		{					
			console.log("add success");		
		},
		error: function (data)
		{	
			console.log("TimeSheetUniversalinsert"); 
			console.log(data); 
		}
	});
}


function SetDefaultState()
{
	$("#ActionControlDDL").val('Review Sign');
	$("#editablefildStepsDIV").css("display", "none");
}


function SetModalDefaultState()
{
	$("#StepNameText").val('');
	//initializePeoplePicker("ForwardUserPicker1"); 
	initializePeoplePickerStakeholder("NewStakeholderList");
	$("#StepsRemarks").val('');
	$("input[name=optionalsec][value='At Bottom most']").prop('checked', true);
	$("#ActionControlDDL").val('Review Sign');
	$("#editablefildStepsDIV").css("display", "none");
	$("#SignPosDDL").css("display", "none");
}

var StepsRevertList=[];
var CurrentStepSeq=0;
function GetStepsRevert()
{
	CurrentStepSeq=0;
	var RecID = titanForWork.getQueryStringParameter('RecNo');
	if(RecID.endsWith("#"))
	{
	    RecID = RecID.substring(0, RecID.length()-1);
 	}
	var Query = "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,Approvers/Title,Approvers/EMail,RequestID/ID,AttachmentFiles&$expand=Approvers,RequestID/ID,AttachmentFiles&$filter=RequestID eq '"+window.atob(RecID)+"' &$orderby=Sequence_No asc";
	var QueryResult = RequestData(Query);
	
	var RevertDesign = '';
	StepsRevertList=[];
	if(QueryResult.length>0)
	{
		var FilteredRec2 = $.grep(QueryResult , function(v) {
			return v.ID == window.atob(titanForWork.getQueryStringParameter('StepID'));
		});
		
		QueryResult = $.grep(QueryResult , function(v) {
			return v.Sequence_No <= FilteredRec2[0].Sequence_No;
		}); 
		
		var Query = "/_api/web/lists/getbytitle('ApprovalProcessList')/items?$select=*,Author/Title,Author/EMail,AttachmentFiles&$expand=Author,AttachmentFiles&$filter=ID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"'";
		var QueryResultProcessList = RequestData(Query);
		var ApproversImg=_spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' +QueryResultProcessList[0].Author.EMail;
		StepsRevertList.push(0);
		RevertDesign  = RevertDesign  +	"<tr>"+
                							"<td>"+
                  								"<div class=''>"+
                    								"<label>"+
                      									//"<input type='radio' name='revertoption' data-toggle='collapse' data-target='#InitiationStep' aria-expanded='false'>"+
                      									"<input type='radio' name='revertoption' value='0' class='RevertStepsRadio' onclick='SetDisplayReturnchkBox(this);'>"+
                      									//"<img src='https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/arrow-right.png' class='changeurl'>"+
                    								"</label>"+
                  								"</div>"+
                							"</td>"+
                							"<td>"+
                  								"<input type='checkbox' id='SkipChkBox0' Class='SkipChkBox' name='CheckBoxSkip' value='0'>"+
                							"</td>"+
                							"<td>"+
                  								"<div class='stpname'>Initiation</div>"+
                  								"<div id='InitiationStep' class='collapse collapsingbox' style='height: 0; overflow: hidden;'>"+
                   									"<div class='actionsboxs'>"+
                     									"<div class='action_areaset' style='padding-right:10px;'>"+
                       										"<label style='margin-bottom: 0'>Action:</label> <span>Initiation</span>"+
                      									"</div>"+
                    								"</div>"+
                   									"<div class='Stakeholder_persons'>"+
                     									"<div class='row no-gutter'>"+
                       										"<div class='col-md-4 col-sm-6 col-xs-12'>"+
                        										"<div class='Stakeholder_flx'>"+
                          											"<img src='"+ApproversImg+"'>"+
                          											"<div class='Stakeholder_detail'>"+
                            											"<h3>"+QueryResultProcessList[0].Author.Title+"</h3>"+
                            											"<a href='#'>"+QueryResultProcessList[0].Author.EMail+"</a>"+
                          											"</div>"+
                        										"</div>"+
                       										"</div>"+
                        								"</div>"+
                   									"</div>"+
                  								"</div>"+
                							"</td>"+
                							"<td>"+
                  								"<a href='#' data-toggle='collapse' data-target='#InitiationStep' class='panel-title-box'><span class='fa fa-angle-down'></span></a>"+
                							"</td>"+
              							"</tr>";
		/*RevertDesign  = RevertDesign  +	"<tr>"+
                								"<td>"+
                  									//"<input type='radio' class='RevertOptionChked' name='revertoption"+QueryResult[i].ID+"' data-toggle='collapse' data-target='#step"+QueryResult[i].ID+"' value='"+QueryResult[i].ID+"'>"+
                  									"<input type='radio' class='RevertOptionChked' name='initiationrevertoption' value='Initiation'>"+
                								"</td>"+
                								"<td>"+
                  									"<input type='radio' name='initiationrevertoption' checked='checked'>"+
                								"</td>"+
                								"<td data-toggle='collapse' data-target='#stepinitiation'>"+
                  									"<div class='stpname'>Initiation</div>"+
                  									"<div id='stepinitiation' class='collapse collapsingbox' style='height: 0; overflow: hidden;'>"+
                   										"<div class='actionsboxs'>"+
                     										"<label>Action:</label> <span>Initiation</span>"+
                   										"</div>"+
                   										"<label>Stakeholder:</label>"+
                   										"<div class='Stakeholder_persons'>"+
                     										//"<div class='row no-gutter'>"+ApproversDesign+ 
                     										"<div class='row no-gutter'>"+ 
                     											"<div class='col-md-4 col-sm-6 col-xs-12'>"+
																	"<div class='Stakeholder_flx'>"+
               															"<img src='"+ApproversImg+"'>"+
                          												"<div class='Stakeholder_detail'>"+
                            												"<h3>"+QueryResultProcessList[0].Author.Title+"</h3>"+
                            												"<a href='#'>"+QueryResultProcessList[0].Author.EMail+"</a>"+
                          												"</div>"+
                        											"</div>"+
                       											"</div>"+                  											                      											
                     										"</div>"+
                   										"</div>"+
                  									"</div>"+
                								"</td>"+
                								"<td>"+
                  									"<a href='#' data-toggle='collapse' data-target='#stepinitiation' class='panel-title-box'>"+
                  									//"<a href='#' data-toggle='collapse' data-target='#step1' class='panel-title-box'>"+
                    									"<span class='fa fa-angle-down'></span>"+
                  									"</a>"+
                								"</td>"+
              								"</tr>";*/
		for(var i=0; i<QueryResult.length; i++)
		{	
			var ApproversDesign='';
			for(var x=0; x<QueryResult[i].Approvers.results.length; x++)
			{
				
				var ApproversImg=_spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' +QueryResult[i].Approvers.results[x].EMail;
				ApproversDesign = ApproversDesign +	"<div class='col-md-4 col-sm-6 col-xs-12'>"+
														"<div class='Stakeholder_flx'>"+
               												"<img src='"+ApproversImg+"'>"+
                          									"<div class='Stakeholder_detail'>"+
                            									"<h3>"+QueryResult[i].Approvers.results[x].Title+"</h3>"+
                            									"<a href='#'>"+QueryResult[i].Approvers.results[x].EMail+"</a>"+
                          									"</div>"+
                        								"</div>"+
                       								"</div>";
			}
			if(i <= QueryResult.length-2)
			{
				StepsRevertList.push(QueryResult[i].ID);
				RevertDesign  = RevertDesign  +	"<tr>"+
                							"<td>"+
                  								//"<div class='hidden_sec'>"+
                  								"<div class=''>"+
                    								"<label>"+
                      									//"<input type='radio' name='revertoption"+QueryResult[i].ID+"' data-toggle='collapse' data-target='#revertoption"+QueryResult[i].ID+"' aria-expanded='false' value="+QueryResult[i].ID+">"+
                      									"<input type='radio' name='revertoption' value="+QueryResult[i].ID+" class='RevertStepsRadio' onclick='SetDisplayReturnchkBox(this);'>"+
                      									//"<img src='https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/arrow-right.png' class='changeurl'>"+
                    								"</label>"+
                  								"</div>"+
                							"</td>"+
                							"<td>"+
                  								"<input type='checkbox' id='SkipChkBox"+QueryResult[i].ID+"' Class='SkipChkBox' name='CheckBoxSkip' value='"+QueryResult[i].ID+"'>"+
                							"</td>"+
                							"<td>"+
                  								"<div class='stpname'>"+QueryResult[i].StepName+"</div>"+
                  								"<div id='revertoption"+QueryResult[i].ID+"' class='collapse collapsingbox' style='height: 0; overflow: hidden;'>"+
                   									"<div class='actionsboxs'>"+
                     									"<div class='action_areaset' style='padding-right:10px;'>"+
                       										"<label style='margin-bottom: 0'>Action:</label> <span>"+QueryResult[i].ActionRequired+"</span>"+
                      									"</div>"+
                    								"</div>"+
                   									"<div class='Stakeholder_persons'>"+
                     									"<div class='row no-gutter'>"+ApproversDesign+
                       									/*"<div class='col-md-4 col-sm-6 col-xs-12'>"+
                        										"<div class='Stakeholder_flx'>"+
                          											"<img src='img-21.jpg'>"+
                          											"<div class='Stakeholder_detail'>"+
                            											"<h3>Dipanker Goswami</h3>"+
                            											"<a href='#'>g.info@gmail.com</a>"+
                          											"</div>"+
                        										"</div>"+
                       										"</div>"+
                        									"<div class='col-md-4 col-sm-6 col-xs-12'>"+
                        										"<div class='Stakeholder_flx'>"+
                          											"<img src='img-21.jpg'>"+
                          											"<div class='Stakeholder_detail'>"+
                            											"<h3>Dipanker Goswami</h3>"+
                            											"<a href='#'>g.info@gmail.com</a>"+
                          											"</div>"+
                        										"</div>"+
                       										"</div>"+
                        									"<div class='col-md-4 col-sm-6 col-xs-12'>"+
                        										"<div class='Stakeholder_flx'>"+
                          											"<img src='img-21.jpg'>"+
                          											"<div class='Stakeholder_detail'>"+
                            											"<h3>Dipanker Goswami</h3>"+
                            											"<a href='#'>g.info@gmail.com</a>"+
                          											"</div>"+
                        										"</div>"+
                       										"</div>"+*/
                     									"</div>"+
                   									"</div>"+
                  								"</div>"+
                							"</td>"+
                							"<td>"+
                  								"<a href='#' data-toggle='collapse' data-target='#revertoption"+QueryResult[i].ID+"' class='panel-title-box'><span class='fa fa-angle-down'></span></a>"+
                							"</td>"+
              							"</tr>";

				/*RevertDesign  = RevertDesign  +	"<tr>"+
                								"<td>"+
                  									//"<input type='radio' class='RevertOptionChked' name='revertoption"+QueryResult[i].ID+"' data-toggle='collapse' data-target='#step"+QueryResult[i].ID+"' value='"+QueryResult[i].ID+"'>"+
                  									"<input type='radio' class='RevertOptionChked' name='revertoption"+QueryResult[i].ID+"' value='"+QueryResult[i].ID+"'>"+
                								"</td>"+
                								"<td>"+
                  									"<input type='radio' name='revertoption"+QueryResult[i].ID+"' checked='checked'>"+
                								"</td>"+
                								"<td data-toggle='collapse' data-target='#step"+QueryResult[i].ID+"'>"+
                  									"<div class='stpname'>"+QueryResult[i].StepName+"</div>"+
                  									"<div id='step"+QueryResult[i].ID+"' class='collapse collapsingbox' style='height: 0; overflow: hidden;'>"+
                   										"<div class='actionsboxs'>"+
                     										"<label>Action:</label> <span>"+QueryResult[i].ActionRequired+"</span>"+
                   										"</div>"+
                   										"<label>Stakeholder:</label>"+
                   										"<div class='Stakeholder_persons'>"+
                     										"<div class='row no-gutter'>"+ApproversDesign+                       											
                     										"</div>"+
                   										"</div>"+
                  									"</div>"+
                								"</td>"+
                								"<td>"+
                  									"<a href='#' data-toggle='collapse' data-target='#step"+QueryResult[i].ID+"' class='panel-title-box'>"+
                  									//"<a href='#' data-toggle='collapse' data-target='#step1' class='panel-title-box'>"+
                    									"<span class='fa fa-angle-down'></span>"+
                  									"</a>"+
                								"</td>"+
              								"</tr>";*/
        	}
        	else
        	{
        		StepsRevertList.push(QueryResult[i].ID);
        		RevertDesign  = RevertDesign  +	"<tr style='display: none;'>"+
                							"<td>"+
                  								"<div class='hidden_sec'>"+
                    								"<label>"+
                      									"<input type='radio' class='RevertStepsRadio' name='revertoption"+QueryResult[i].ID+"' data-toggle='collapse' data-target='#revertoption"+QueryResult[i].ID+"' aria-expanded='false'>"+
                      									"<img src='https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/arrow-right.png' class='changeurl'>"+
                    								"</label>"+
                  								"</div>"+
                							"</td>"+
                							"<td>"+
                  								"<input type='checkbox'>"+
                							"</td>"+
                							"<td>"+
                  								"<div class='stpname'>"+QueryResult[i].StepName+"</div>"+
                  								"<div id='revertoption"+QueryResult[i].ID+"' class='collapse collapsingbox' style='height: 0; overflow: hidden;'>"+
                   									"<div class='actionsboxs'>"+
                     									"<div class='action_areaset' style='padding-right:10px;'>"+
                       										"<label style='margin-bottom: 0'>Action:</label> <span>Edit and Approve</span>"+
                      									"</div>"+
                    								"</div>"+
                   									"<div class='Stakeholder_persons'>"+
                     									"<div class='row no-gutter'>"+
                       										"<div class='col-md-4 col-sm-6 col-xs-12'>"+
                        										"<div class='Stakeholder_flx'>"+
                          											"<img src='img-21.jpg'>"+
                          											"<div class='Stakeholder_detail'>"+
                            											"<h3>Dipanker Goswami</h3>"+
                            											"<a href='#'>g.info@gmail.com</a>"+
                          											"</div>"+
                        										"</div>"+
                       										"</div>"+
                        									"<div class='col-md-4 col-sm-6 col-xs-12'>"+
                        										"<div class='Stakeholder_flx'>"+
                          											"<img src='img-21.jpg'>"+
                          											"<div class='Stakeholder_detail'>"+
                            											"<h3>Dipanker Goswami</h3>"+
                            											"<a href='#'>g.info@gmail.com</a>"+
                          											"</div>"+
                        										"</div>"+
                       										"</div>"+
                        									"<div class='col-md-4 col-sm-6 col-xs-12'>"+
                        										"<div class='Stakeholder_flx'>"+
                          											"<img src='img-21.jpg'>"+
                          											"<div class='Stakeholder_detail'>"+
                            											"<h3>Dipanker Goswami</h3>"+
                            											"<a href='#'>g.info@gmail.com</a>"+
                          											"</div>"+
                        										"</div>"+
                       										"</div>"+
                     									"</div>"+
                   									"</div>"+
                  								"</div>"+
                							"</td>"+
                							"<td>"+
                  								"<a href='#' data-toggle='collapse' data-target='#revertoption"+QueryResult[i].ID+"' class='panel-title-box'><span class='fa fa-angle-down'></span></a>"+
                							"</td>"+
              							"</tr>";

        		/*RevertDesign  = RevertDesign  +	"<tr style='display: none;'>"+
                								"<td>"+                  									
                  									"<input type='radio' class='RevertOptionChked' name='revertoption"+QueryResult[i].ID+"' value='"+QueryResult[i].ID+"' checked='checked'>"+
                								"</td>"+
                								"<td>"+
                  									"<input type='radio' name='revertoption"+QueryResult[i].ID+"'>"+
                								"</td>"+
                								"<td data-toggle='collapse' data-target='#step"+QueryResult[i].ID+"'>"+
                  									"<div class='stpname'>"+QueryResult[i].StepName+"</div>"+
                  									"<div id='step"+QueryResult[i].ID+"' class='collapse collapsingbox' style='height: 0; overflow: hidden;'>"+
                   										"<div class='actionsboxs'>"+
                     										"<label>Action:</label> <span>"+QueryResult[i].ActionRequired+"</span>"+
                   										"</div>"+
                   										"<label>Stakeholder:</label>"+
                   										"<div class='Stakeholder_persons'>"+
                     										"<div class='row no-gutter'>"+ApproversDesign+                       											
                     										"</div>"+
                   										"</div>"+
                  									"</div>"+
                								"</td>"+
                								"<td>"+
                  									"<a href='#' data-toggle='collapse' data-target='#step"+QueryResult[i].ID+"' class='panel-title-box'>"+
                  									//"<a href='#' data-toggle='collapse' data-target='#step1' class='panel-title-box'>"+
                    									"<span class='fa fa-angle-down'></span>"+
                  									"</a>"+
                								"</td>"+
              								"</tr>";*/

        	}
		}	
	}
	
	if(QueryResult.length > 0)
	{
		CurrentStepSeq=QueryResult[QueryResult.length-1].Sequence_No;
		$("#AddRevertStepsBtn").css("display", "inline-block")
		$("#tbodyRevert").empty().append(RevertDesign);
	}
	else
	{
		CurrentStepSeq=0;
		$("#AddRevertStepsBtn").css("display", "none")	
		RevertDesign  = "<tr><td colspan='4'>!! No Steps Found for revert Approval Process !!</td></tr>";
		$("#tbodyRevert").empty().append(RevertDesign);
	}
	/*if(QueryResult.length <= 1)
	{
		CurrentStepSeq=0;
		$("#AddRevertStepsBtn").css("display", "none")	
		RevertDesign  = "<tr><td colspan='4'>!! No Steps Found for revert Approval Process !!</td></tr>";
		$("#tbodyRevert").empty().append(RevertDesign);
	}
	else
	{
		CurrentStepSeq=QueryResult[QueryResult.length-1].Sequence_No;
		$("#AddRevertStepsBtn").css("display", "inline-block")
		$("#tbodyRevert").empty().append(RevertDesign);
	}*/
}


function AddRevertSteps()
{
	var SelectedRadio = $('input[name="revertoption"]:checked').val();;
	
	var FilteredRec2 = $.grep(StepsRevertList, function(v) {
		return v >= SelectedRadio
	});
	
	var Selectedchkbox=[];
	$("input[name='CheckBoxSkip']:checked").each(function(){
		Selectedchkbox.push($(this).val());
	});
		
	for(var x=0; x<Selectedchkbox.length; x++)
	{
		FilteredRec2 = jQuery.grep(FilteredRec2, function(value) {
  			return value != Selectedchkbox[x];
		});
	}
	var InitiatorID = 0;
	if(CurrentStepSeq != 0 && FilteredRec2.length>0)
	{		
		var RecID = titanForWork.getQueryStringParameter('RecNo');
		var Query = "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,Approvers/Title,Approvers/EMail,RequestID/ID,AttachmentFiles&$expand=Approvers,RequestID/ID,AttachmentFiles&$filter=RequestID eq '"+window.atob(RecID)+"' &$orderby=Sequence_No asc";
		var QueryResult = RequestData(Query);
		var ExSeq=0;
		var NewSeqNo = CurrentStepSeq;
		for(var x=0; x<FilteredRec2.length; x++)
		{
			// Update Reverted Column in ApprovalProcessQueue List.
			
			NewSeqNo = parseInt(NewSeqNo)+1;
			
			var SelectedStepFilter = $.grep(QueryResult, function(v) {
    			return v.ID == FilteredRec2[x];
			});
			
			if(SelectedStepFilter.length>0 || FilteredRec2[x] == '0')
			{
				var AppForStep='';
				var AppDecidingStep='';
				if(SelectedStepFilter.length>0)
				{
					if(SelectedStepFilter[0].ApproverForStep != null){AppForStep = "REV:"+SelectedStepFilter[0].ApproverForStep;}
					if(SelectedStepFilter[0].ApproverDecidingStep != null){AppDecidingStep = "REV:"+SelectedStepFilter[0].ApproverDecidingStep;}			
				}
				var item='';
				if(x <= FilteredRec2.length-2)
				{	
					if(x == 0)
					{
						if(FilteredRec2[x] == '0')
						{
							InitiatorID = QueryResult[0].AuthorId;
							if(SelectedStepFilter.length==0)
							{
								//item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ApproverType':SelectedStepFilter[0].ApproverType,'Sequence_No':NewSeqNo,'Title':'Step Approvers','ApproversId':{'results':[_spPageContextInfo.userId]},'StepName':'REV:Initiation','RequestIDId':parseInt(window.atob(titanForWork.getQueryStringParameter('RecNo'))),'TemplateIDId':CurrTenplateID,'ActionRequired':'Edit Data','SignaturePosition':'BottomMost','Status':'Pending'};
								item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ApproverType':'Specific','Sequence_No':NewSeqNo,'Title':'Step Approvers','ApproversId':{'results':[QueryResult[0].AuthorId]},'StepName':'REV:Initiation','RequestIDId':parseInt(window.atob(titanForWork.getQueryStringParameter('RecNo'))),'TemplateIDId':CurrTenplateID,'ActionRequired':'Edit Data','SignaturePosition':'BottomMost','Status':'Pending','StepID':'Initiation'};
							}
							else
							{
								item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ApproverType':SelectedStepFilter[0].ApproverType,'Sequence_No':NewSeqNo,'Title':'Step Approvers','ApproversId':{'results':[SelectedStepFilter[0].AuthorId]},'StepName':'REV:Initiation','RequestIDId':parseInt(window.atob(titanForWork.getQueryStringParameter('RecNo'))),'TemplateIDId':CurrTenplateID,'ActionRequired':'Edit Data','SignaturePosition':'BottomMost','Status':'Pending'};
							}	
						}
						else
						{
							item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ApproverType':SelectedStepFilter[0].ApproverType,'Sequence_No':NewSeqNo,'Title':'Step Approvers','ApproversId':{'results':SelectedStepFilter[0].ApproversId.results},'StepName':'REV:'+SelectedStepFilter[0].StepName,'RequestIDId':parseInt(window.atob(titanForWork.getQueryStringParameter('RecNo'))),'TemplateIDId':CurrTenplateID,'ActionRequired':SelectedStepFilter[0].ActionRequired,'SignaturePosition':SelectedStepFilter[0].SignaturePosition,'Status':'Pending','StepID':SelectedStepFilter[0].StepID,'ApproverRole':SelectedStepFilter[0].ApproverRole,'AskApprover':SelectedStepFilter[0].AskApprover,'ColumnName':SelectedStepFilter[0].ColumnName,'ApproverForStep':AppForStep,'ApproverDecidingStep':AppDecidingStep};
						}
					}
					else
					{
						item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ApproverType':SelectedStepFilter[0].ApproverType,'Sequence_No':NewSeqNo,'Title':'Step Approvers','ApproversId':{'results':SelectedStepFilter[0].ApproversId.results},'StepName':'REV:'+SelectedStepFilter[0].StepName,'RequestIDId':parseInt(window.atob(titanForWork.getQueryStringParameter('RecNo'))),'TemplateIDId':CurrTenplateID,'ActionRequired':SelectedStepFilter[0].ActionRequired,'SignaturePosition':SelectedStepFilter[0].SignaturePosition,'StepID':SelectedStepFilter[0].StepID,'ApproverRole':SelectedStepFilter[0].ApproverRole,'AskApprover':SelectedStepFilter[0].AskApprover,'ColumnName':SelectedStepFilter[0].ColumnName,'ApproverForStep':AppForStep,'ApproverDecidingStep':AppDecidingStep};
					}
				}
				else
				{
					item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ApproverType':SelectedStepFilter[0].ApproverType,'Sequence_No':NewSeqNo,'Title':'Step Approvers','ApproversId':{'results':SelectedStepFilter[0].ApproversId.results},'StepName':'REV:'+SelectedStepFilter[0].StepName,'RequestIDId':parseInt(window.atob(titanForWork.getQueryStringParameter('RecNo'))),'TemplateIDId':CurrTenplateID,'ActionRequired':SelectedStepFilter[0].ActionRequired,'SignaturePosition':SelectedStepFilter[0].SignaturePosition,'StepID':SelectedStepFilter[0].StepID,'ApproverRole':SelectedStepFilter[0].ApproverRole,'AskApprover':SelectedStepFilter[0].AskApprover,'ColumnName':SelectedStepFilter[0].ColumnName,'ApproverForStep':AppForStep,'ApproverDecidingStep':AppDecidingStep};
					
					var listName="ApprovalProcessQueue";
					var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+listName+"')/items('"+SelectedStepFilter[0].ID+"')";
					var itemData='';
						itemData={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'Status':'Reverted','ActionTakenbyId':_spPageContextInfo.userId,'IPAddress':ActiveSystemIP,'Remarks':$("#RevertRemarksText").val()};						
					var ExStatus = UpdateApprovalProcessSequence(listName,itemData,SelectedStepFilter[0].ID,SiteUrl);
				}				
				
				var dfd = $.Deferred()
				$.ajax({
					url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('ApprovalProcessQueue')/items",
					type: "POST",
					async: false,
					headers: {
						"accept": "application/json;odata=verbose",
						"X-RequestDigest": $("#__REQUESTDIGEST").val(),
						"IF-MATCH": "*",						
						"content-Type": "application/json;odata=verbose"
					},
					data: JSON.stringify(item),
					success: function (data) 
					{	
						var listName="ApprovalProcessList";
						var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+listName+"')/items('"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"')";
						if(x == 0)
						{
							if(FilteredRec2[x] == '0')
							{
								var itemData='';
								itemData={'__metadata': { type: 'SP.Data.ApprovalProcessListListItem'},'Status':'Initiated','ApproversId':{'results':[InitiatorID]},'CurrentStep':'REV:Initiation','CurrentStepID':data.d.Id.toString(),'ActionRequired':'Edit Data'};						
							}
							else
							{
								var itemData='';
								itemData={'__metadata': { type: 'SP.Data.ApprovalProcessListListItem'},'Status':'Initiated','ApproversId':{'results':SelectedStepFilter[0].ApproversId.results},'CurrentStep':'REV:'+SelectedStepFilter[0].StepName,'CurrentStepID':data.d.Id.toString(),'ActionRequired':SelectedStepFilter[0].ActionRequired};													
							}						
							var ExStatus = UpdateApprovalProcessSequence(listName,itemData,window.atob(titanForWork.getQueryStringParameter('RecNo')),SiteUrl);													
						}
						ExSeq = ExSeq+1;							
					},
					error: function (error,data) 
					{
						alert(JSON.stringify(error));
					}
				});
			}
		}
		
		var FilteredRec = $.grep(QueryResult, function(v) {
			return v.Sequence_No > CurrentStepSeq;
		});
			
		var SeqCounter = 0;
		if(FilteredRec.length>0)
		{
			for(var y=0; y<FilteredRec.length; y++)
			{
				var NewSequence = FilteredRec[y].Sequence_No;
					NewSequence = parseInt(NewSequence)+parseInt(FilteredRec2.length);
					
				var listName="ApprovalProcessQueue";
				var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+listName+"')/items('"+FilteredRec[y].ID+"')";
				var item='';
					item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'Sequence_No':NewSequence};						
				var ExStatus = UpdateApprovalProcessSequence(listName,item,FilteredRec[y].ID,SiteUrl);					
			
			}				
		}
		
		if(FilteredRec2.length == ExSeq)
		{
			for(var z=0; z<FilteredRec2.length; z++)
			{
				var listName="ApprovalProcessQueue";
				var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+listName+"')/items('"+FilteredRec2[z]+"')";
				var item='';
					item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'Reverted':true};						
				var ExStatus = UpdateApprovalProcessSequence(listName,item,FilteredRec2[z],SiteUrl);
			
			}
			alert('Approval request has been reverted.');
			$('#rever_multistep').modal('hide');
			window.location.replace("approvals.aspx");
		}
	}
	else
	{
		alert('Select Revert Step.');
	}	
	
}


function isMathExpression(str)
{
  	try {Complex.compile(str); } 
  	catch (error){ return false; }
    return true;
} 
 
 
function SetCalculateValue()
{
 	if(FormulaColumnList.length > 0)
 	{
 		for(var i=0; i<FormulaColumnList.length; i++)
		{
			CalculateDynamicValue(FormulaColumnList[i].Rel, FormulaColumnList[i].ColumnName, FormulaColumnList[i].Formula);
		}
 	}
}

function SetSummarizedValue(tblID, tblcol, sumValue, lable)
{
	var SummarizeFilter	 = $.grep(summarizeValues, function(v) {
		return v.tblId == tblID && v.col == tblcol
	}); 
	if(SummarizeFilter.length > 0){		
	for(i=0;i< SummarizeFilter.length;i++)
	{
		//if(summarizeValues[i].tblId == tblID && summarizeValues[i].lbl == lable){
		if(SummarizeFilter[i].formula != null)
		{		
			var Condition = SummarizeFilter[i].formula;
			Condition = Condition.split(',');
			if(Condition.length>0)
			{
				var NewExp='';
				for(var q=0; q<Condition.length; q++)
				{
					var evt = $.trim(Condition[q]);
					if(/^[a-zA-Z0-9- ]*$/.test(evt) == false)
					{
						NewExp = NewExp+evt;
					}
					else
					{	
						evt = evt.trim();
						if(evt == 'value')
						{
							var CurrntVal = sumValue ? sumValue : $("#ttlval_"+SummarizeFilter[i].tblId+"_"+SummarizeFilter[i].col).text();
						}
						else
						{
							var CurrntVal = $('#'+evt).val()	//$(elem).closest("tr").find('td #'+evt).val()
						}
						if(CurrntVal != undefined)
						{
							if(CurrntVal == '')
							{	
								CurrntVal = '0'
							}
							NewExp = NewExp+CurrntVal;
						}
						else
						{				
							NewExp = NewExp+evt;
						}						
					}
				}        											
				if(isMathExpression(NewExp) == true)
				{
					var result = math.evaluate(NewExp);        												 
					result = result.toFixed(2); 
					result = result.toString();  				
					$("#SummarizedValue_"+SummarizeFilter[i].tblId+"_"+SummarizeFilter[i].lbl).val(result);
					//return result;		 
				}	       											
  			} 
  		}
  		else
  		{
  			sumValue  = sumValue ? sumValue : 0;
  			$("#SummarizedValue_"+SummarizeFilter[i].tblId+"_"+SummarizeFilter[i].lbl).val(parseFloat(sumValue).toFixed('2'));
  		}
  	}
  	}else{
  	for(i=0;i< summarizeValues.length;i++)
	{
		//if(summarizeValues[i].tblId == tblID && summarizeValues[i].lbl == lable){
		if(summarizeValues[i].formula != null)
		{		
			var Condition = summarizeValues[i].formula;
			Condition = Condition.split(',');
			if(Condition.length>0)
			{
				var NewExp='';
				for(var q=0; q<Condition.length; q++)
				{
					var evt = $.trim(Condition[q]);
					if(/^[a-zA-Z0-9- ]*$/.test(evt) == false)
					{
						NewExp = NewExp+evt;
					}
					else
					{	
						evt = evt.trim();
						if(evt == 'value')
						{
							var CurrntVal = sumValue ? sumValue : $("#ttlval_"+summarizeValues[i].tblId+"_"+summarizeValues[i].col).text();
						}
						else
						{
							var CurrntVal = $('#'+evt).val()	//$(elem).closest("tr").find('td #'+evt).val()
						}
						if(CurrntVal != undefined)
						{
							if(CurrntVal == '')
							{	
								CurrntVal = '0'
							}
							NewExp = NewExp+CurrntVal;
						}
						else
						{				
							NewExp = NewExp+evt;
						}						
					}
				}        											
				if(isMathExpression(NewExp) == true)
				{
					var result = math.evaluate(NewExp);        												 
					result = result.toFixed(2); 
					result = result.toString();  				
					$("#SummarizedValue_"+summarizeValues[i].tblId+"_"+summarizeValues[i].lbl).val(result);
					//return result;		 
				}	       											
  			} 
  		}
  		else
  		{
  			//sumValue  = 0;
  			if(summarizeValues[i].lbl == tblcol){
  			$("#SummarizedValue_"+summarizeValues[i].tblId+"_"+summarizeValues[i].lbl).val(parseFloat(sumValue).toFixed('2'));
  			}
  		}
  	}
  	}
 	//}
}


function CalculateDynamicValue(Title, Name, Formula) 
{
	if(Formula != null)
	{
		var title = Title.replace(' ','');title= title.replace('%', '');
		var Condition = Formula;
			Condition = Condition.split(',');
		if(Condition.length>0)
		{
			var NewExp='';
			for(var q=0; q<Condition.length; q++)
			{
				var evt = $.trim(Condition[q]);
				if(/^[a-zA-Z0-9- ]*$/.test(evt) == false)
				{
					NewExp = NewExp+evt;
				}
				else
				{
					var CurrntVal = $('#'+evt).val()	//$(elem).closest("tr").find('td #'+evt).val()
					if(CurrntVal != undefined)
					{
						if(CurrntVal == ''){	CurrntVal = '0'}
						NewExp = NewExp+CurrntVal;
					}
					else
					{				
						NewExp = NewExp+evt;
					}	
				}
				
				/*if(evt == '+' || evt == '-' || evt == '*' || evt == '/' || evt == '%')
				{
					NewExp = NewExp+evt;
				}
				else
				{
					var CurrntVal = $('#'+evt).val()	//$(elem).closest("tr").find('td #'+evt).val()
					if(CurrntVal != undefined)
					{
						if(CurrntVal == ''){	CurrntVal = '0'}
						NewExp = NewExp+CurrntVal;
					}
					else
					{				
						NewExp = NewExp+evt;
					}	
				}*/
			}        											
			if(isMathExpression(NewExp) == true)
			{
				var result = math.evaluate(NewExp);        												 
				result = result.toFixed(2); 
				result = result.toString();  
				Title = Title.replaceAll(' ','');
				Title = Title.replace(/[&\/\\#,+()$~%.'":*?<>{}]/g, '');
				$('#'+Name+'_'+Title).val(result);
				return result;		 
			}	       											
  		} 
  	}
}


function PreUploadSignList()
{
	var Query = "/_api/web/lists/getbytitle('EmployeeSignature')/items?$select=*,AttachmentFiles&$expand=AttachmentFiles&$filter=Employee/EMail eq '"+_spPageContextInfo.userEmail+"' and Status eq 'Active' &$orderby=Modified asc";
	var QueryResult = RequestData(Query);
	
	var SignListDesign='';
	if(QueryResult.length>0)
	{
		for(var i=0; i<QueryResult.length; i++)
		{
			if(QueryResult[i].AttachmentFiles.results.length>0)
			{
				SignListDesign = SignListDesign +	"<li>"+
							      						"<a onclick='SelectSignature(this)'hreflang='"+QueryResult[i].ID+"' name='"+QueryResult[i].AttachmentFiles.results[0].ServerRelativeUrl+"'><img src='"+QueryResult[i].AttachmentFiles.results[0].ServerRelativeUrl+"' data-themekey='#'></a>"+
							    					"</li>";	
			}
		}	
	}
	$("#Pre-Upload-Signatures").empty().append(SignListDesign);
}


var SelectedSignImages='';
function SelectSignature(Action)
{
	$(".approval_image_preview").css("display", "block");
	$(".custom-image-label").css("display", "none");
	$("#SignImgPreview").attr("src",Action.name);
	SelectedSignImages = Action.name;
	sourceItemId = Action.hreflang;
}



//var listName="CL1120";
var sourceItemId=0;
var targetItemId=0;
 
function getAttachments() {
	var url = _spPageContextInfo.webAbsoluteUrl;   
    var requestUri = url + "/_api/web/lists/getbytitle('EmployeeSignature')/items(" + sourceItemId + ")/AttachmentFiles";
    return $.ajax({
        url: requestUri,
        type: "GET",
        headers: { "ACCEPT": "application/json;odata=verbose" }       
    });
}
function CopySignatureFile(){
    getAttachments().done(function(data){
        $.each(data.d.results,function(i,item){
            //var fileUrl=item.ServerRelativeUrl;
            var url = _spPageContextInfo.webAbsoluteUrl;
            var targetFileName=item.FileName;
            var sourceSiteUrlList = url + "/_api/web/lists/getbytitle('EmployeeSignature')/items("+sourceItemId+")/AttachmentFiles/getbyfilename('" + targetFileName + "')/$value";
            var targetSiteUrl = url + "/_api/lists/GetByTitle('ApprovalProcessQueue')/items(" + targetItemId + ")/AttachmentFiles/add(FileName='" + targetFileName + "')";
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', sourceSiteUrlList, true);
            xhr.setRequestHeader('binaryStringResponseBody', 'true');
            xhr.responseType = 'arraybuffer';
            xhr.onload = function (e) {
                if (this.status == 200) {
                    var arrayBuffer = this.response;
                    $.ajax({
                        url: targetSiteUrl,
                        method: 'POST',
                        async: false,
                        data: arrayBuffer,
                        processData: false,
                        headers: { 'binaryStringRequestBody': 'true', 'Accept': 'application/json;odata=verbose;charset=utf-8', 'X-RequestDigest':  $('#__REQUESTDIGEST').val() }
                    }).done(function (postData) {
                            console.log('we did it!');
                    }).fail(function (jqXHR, errorText) {
                            //alert(errorText.statusText);
                            
                    });
                }
            }
            xhr.send();         
        }); 
    }); 
}


function SetDisplayReturnSignPos(Action)
{
	if(Action == 'Review & Sign')
	{
		$("#ReturnSignPos").css("display", "block");
		ReturnLoadColumnSignPos();
	}
	else if(Action == 'Review Only')
	{
		$("#ReturnSignPos").css("display", "none");
	}
}

function removeCancel(){
for(p = 0;p<personCols.length;p++){ $('#'+personCols[p]).find(".sp-peoplepicker-delImage").hide();}
}

function ReturnLoadColumnSignPos()
{	
	var ResultItems=[];
	var Ownurl =_spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalTemplateSetup')/items?$filter=TemplateID eq '"+CurrTenplateID+"'&$orderby=Title asc";  
    $.ajax({  
       url: Ownurl,  
       headers: { Accept: "application/json;odata=verbose" },  
       async:true,  
       success: function (data) 
       {
           ResultItems = data.d.results;          
           var SignposDesign ='';           
			if(ResultItems.length > 0)
			{
				for(var i=0; i<ResultItems.length; i++)
            	{
           			if(ResultItems[i].ColumnType!="FixedText" && ResultItems[i].ColumnType!="Header")
           			{
           				SignposDesign = SignposDesign +"<option>"+ResultItems[i].Title+"</option>";
	          		}            
				}
			}						
			$("#RevertSignPosDDL").empty().append(SignposDesign);  
        },
        error: function (data) 
        {  
            console.log("Error in getdata.");
        }  
    });
    
    //SetModalDefaultState(); // Set Control on default state.
    
}


function SetDisplayReturnchkBox(Action)
{
	var SelectedRadio = $('input[name="revertoption"]:checked').val();;
	var FilteredRec2 = $.grep(StepsRevertList, function(v) {
		return v <= SelectedRadio
	});
	var index = StepsRevertList.indexOf(parseInt(SelectedRadio));
	$(".SkipChkBox").css("display", "block");
	$('.SkipChkBox').prop('checked', false);
	if(StepsRevertList.length - FilteredRec2.length == 1)
	{
		$(".SkipChkBox").css("display", "none");
	}
	else if(index == -1)
	{
		$("#SkipChkBox0").css("display", "none");
	}
	else if(FilteredRec2.length>0)
	{
		for(var i=0; i<FilteredRec2.length; i++)
		{
			$("#SkipChkBox"+FilteredRec2[i]).css("display", "none");
		}
	}

}


function mySearchFunction() {
  var input = document.getElementById("Search");
  var filter = input.value.toLowerCase();
  var nodes = document.getElementsByClassName('new-request-panel');

  for (i = 0; i < nodes.length; i++) {
    if (nodes[i].innerText.toLowerCase().includes(filter)) {
      nodes[i].style.display = "block";
    } else {
      nodes[i].style.display = "none";
    }
  }
}



function ApprovalProcessForwardSet(listName,item) 
{	
	var ActionListStatus=0;
	$.ajax({
		url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('"+listName+"')/items",
		type: "POST",
		contentType: "application/json;odata=verbose",
		data: JSON.stringify(item),
		async: false,
		headers: 
		{
			"Accept": "application/json;odata=verbose",
			"X-RequestDigest": $("#__REQUESTDIGEST").val()
		},
		success: function (data)
		{					
			console.log("add success");
			ActionListStatus=1; 		
		},
		error: function (data)
		{	
			ActionListStatus=0;
			console.log("TimeSheetUniversalinsert"); 
			console.log(data); 
		}
	});
	return ActionListStatus;
}


function UpdateApprovalProcessForward(listName,item,dataid,SiteUrl)  
{
	var ActionListStatus=false;
   	var Responce="";
   	$.ajax({  
		url: SiteUrl,
    	type: "POST",  
    	async:false,
    	data: JSON.stringify(item),         
    	headers:  
    	{  
    		"Accept": "application/json;odata=verbose",  
    	    "Content-Type": "application/json;odata=verbose",  
    	    "X-RequestDigest": $("#__REQUESTDIGEST").val(),  
    	    "IF-MATCH": "*",  
    	    "X-HTTP-Method": "MERGE"  
    	},  
    	success: function(data)
    	{ 	
    	  	ActionListStatus=true;        	
    	},  
    	error: function(data) 
    	{  
    		Responce=data;
    	    console.log("Error in UniversalUpdate.");
    	  	console.log(data);  
    	}  
    }); 
    return ActionListStatus;    
}


var NewForwardRevert=[];
function ValidateExistingApprovers(HTMLID, PplPickerId, UserBoxId) 
{
	var picker = SPClientPeoplePicker.SPClientPeoplePickerDict[HTMLID];
    picker.OnValueChangedClientScript = function (elementId, userInfo) {
    user = '';
    if (userInfo.length > 0)
    {
    	tempUserId = EnsureUserMulti($('#ReturnStakeholderList').children().children().attr('id'));
    	if(tempUserId.length>0)
    	{
    		for(var x=0; x<tempUserId.length; x++)
    		{	
    			var EmpId = tempUserId[x];
    			var arraycontainsturtles = (ApproversListForward.indexOf(EmpId) > -1);
    			var arraycontainsturtles2 = (NewForwardRevert.indexOf(EmpId) > -1);
        		if(arraycontainsturtles == false && arraycontainsturtles2 == false)
        		{    
        			var EnsureActive = EnsureUserValidate($('#ReturnStakeholderList').children().children().attr('id'));
					if(EnsureActive.length>0)
					{
						for(var k=0; k<EnsureActive.length; k++)
						{
							var QueryResultCheckActive=[];
							if(EnsureActive[k].Type == 'Tenant')
							{
								var QueryCheckActive =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Employees')/items?$select=*&$filter=LogonName/EMail eq '"+EnsureActive[k].Email+"' and Status eq 'Active'";
									QueryResultCheckActive = RequestGetdata(QueryCheckActive);
							}
							else
							{
								var QueryCheckActive =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ExternalUsers')/items?$select=*&$filter=LoginName/EMail eq '"+EnsureActive[k].Email+"' and Status eq 'Active'";
									QueryResultCheckActive = RequestGetdata(QueryCheckActive);
							}
								
							if(QueryResultCheckActive.length>0)
							{
								ExStatus = true;
								NewForwardRevert.push(EmpId);
								ApproversListForward.push(EmpId);
           						var tempEmail = userInfo[x].Key.split('|')[2];
          						if (tempEmail.includes('#') == true) 
           						{
           						    tempEmail = tempEmail.replace("#ext#@adaptindia.onmicrosoft.com", '');
           							tempEmail = tempEmail.replace("_", '@');
           						}
           						var attachment = _spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' + escapeProperly(tempEmail);           
           						var ForwardUserImg='';
            						ForwardUserImg += "<div class='col-md-6 col-sm-6 userBoxParent'>";
            						ForwardUserImg += "<div class='members-card border-0'>";
									ForwardUserImg += "<div class='members-card-head'>";
            						ForwardUserImg += "<img src='"+attachment+"'>";
            						ForwardUserImg += "</div>";
            						ForwardUserImg += "<div class='members-card-body'>";
            						ForwardUserImg += "<div class='members-card-body-info text-ellipsis'>";
            						ForwardUserImg += "<h3 class='member-name text-ellipsis'>"+userInfo[0].DisplayText+"</h3>";
            						ForwardUserImg += "<p class='member-email text-ellipsis mb0'>"+tempEmail+"</p>";
            						ForwardUserImg += "</div>";
            						ForwardUserImg += "<a class='btn remove-group-btn remove-btn close close-round' onclick='RemoveUserBoxRevert(this, \"" + tempEmail + "\", \"" + userInfo[0].DisplayText + "\", " + tempUserId + ")'><i class='fa fa-times'></i></a>";
            						ForwardUserImg += "</div>";
            						ForwardUserImg += "</div>";
            						ForwardUserImg += "</div>";           
            	
            						$("#" + UserBoxId).append(ForwardUserImg);
            						EmptyPeoplePicker(PplPickerId);
							}
							else
							{
								ExStatus = false;
								EmptyPeoplePicker(PplPickerId);
								alert(EnsureActive[k].Name+ " is not a valid user");
								return false;
								break;
							}															
						}						
					}					
				}
        		else if(arraycontainsturtles == true || arraycontainsturtles2 == true)
        		{
        		  	EmptyPeoplePicker(PplPickerId);
        		  	if(arraycontainsturtles2 == true)
        		  	{
        		  		alert(userInfo[0].DisplayText+" already exists!!");
        		   	}
        		   	else
        		   	{
        		   		alert(userInfo[0].DisplayText+" is a stakeholder in this step. \nPlease select any another user to forward.");
        		   	}
        		}
        	}
        }
	}
	};
}


function RemoveUserBoxRevert(Action, userEmail, UserName, UserId)
	{
    	$(Action).parents('.col-md-6').remove();
    	    
    	NewForwardRevert = jQuery.grep(NewForwardRevert, function(value) {
  			return value != UserId;
		});
	}

function SetFeedbackRecord()
{
	var RadioValue = $('input[name="ok_section"]:checked').val();
	var Remarks = $("#RemarkFeedback").val();
	if ($("#reviewedbox").is(":checked"))
	{
    	var QueryDataStep =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessForward')/items?$select=*&$filter=ApprovalQueueID eq "+window.atob(titanForWork.getQueryStringParameter('StepID'))+" and ForwardedTo eq "+_spPageContextInfo.userId+"";
		var QueryStepIdData = RequestGetdata(QueryDataStep);
		if(QueryStepIdData.length>0)
		{
			var ListName="ApprovalProcessForward";
			var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+ListName+"')/items('"+QueryStepIdData[0].Id+"')";
			var Items='';
				Items={'__metadata': { type: 'SP.Data.ApprovalProcessForwardListItem'},'FeedBack':RadioValue,'FeedBackRemarks':Remarks};						
			var ExStatusPrQuee = UpdateApprovalProcessForward(ListName,Items,QueryStepIdData[0].Id,SiteUrl);			
			if(ExStatusPrQuee == true)
			{
				alert("Action taken successfully.");
				window.location.replace("approvals.aspx");				
			}		
		}
	}
	else
	{
		alert("Select reviewedbox.");
	}

}


function GetForwardHistory()
{
	var QueryDataStep =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessForward')/items?$select=*,ForwardedBy/Title,ForwardedBy/EMail,ForwardedTo/Title,ForwardedTo/EMail&$expand=ForwardedBy,ForwardedTo&$filter=ApprovalQueueID eq "+window.atob(titanForWork.getQueryStringParameter('StepID'))+"";
	var QueryStepIdData = RequestGetdata(QueryDataStep);
	var Remark = '';
	//if(QueryStepIdData[0].ForwardedRemarks != null){Remark = QueryStepIdData[0].ForwardedRemarks;}
	if(QueryStepIdData[QueryStepIdData.length-1].ForwardedRemarks != null){Remark = QueryStepIdData[QueryStepIdData.length-1].ForwardedRemarks;}
	$("#ForwardbyTitle").text(QueryStepIdData[0].ForwardedBy.Title);
	$("#ForwardbyEmail").text(QueryStepIdData[0].ForwardedBy.EMail);
	$("#ForwardbyRemark").html(Remark);
	var ForwardUser = _spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' + escapeProperly(QueryStepIdData[0].ForwardedBy.EMail);
	$("#ForwardbyPhoto").attr("src",ForwardUser);
	
	var eventDateObj=new Date(QueryStepIdData[0].Created);
	var Event_time = eventDateObj.toTimeString();
	var H = +Event_time.substr(0, 2);
	var h = (H % 12) || 12;
	var ampm = H < 12 ? " AM" : " PM";
		Event_time= h + Event_time.substr(2, 3) + ampm;

	var ActionDate = moment(QueryStepIdData[0].Created).format('LL');
	
	$("#ActionDate").text(ActionDate);
	$("#ActionTime").text(Event_time);
	
	var Forward2Design='';
	for(var x=0; x<QueryStepIdData.length; x++)
	{	
		var ForDesign='';
		if(x==0)
		{
			ForDesign = "<h3 class='forwrad_heading'>Forwarded To</h3>";
		}
		
		var eventDateObj=new Date(QueryStepIdData[x].Modified);
		var Event_time = eventDateObj.toTimeString();
		var H = +Event_time.substr(0, 2);
		var h = (H % 12) || 12;
		var ampm = H < 12 ? " AM" : " PM";
			Event_time= h + Event_time.substr(2, 3) + ampm;

		var ActionDate = moment(QueryStepIdData[x].Modified).format('LL');
		
		var FeedBack='';
		var FeedBackRemark='';
		var WaitingFeedBack='';
		if(QueryStepIdData[x].FeedBack != null)
		{
			FeedBack=QueryStepIdData[x].FeedBack;
		}
		else
		{
			WaitingFeedBack = "style='display: none'";
			FeedBack = "Waiting for feedback..";
		}
		if(QueryStepIdData[x].FeedBackRemarks != null){FeedBackRemark=QueryStepIdData[x].FeedBackRemarks}

		var ForwardUser = _spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' + escapeProperly(QueryStepIdData[x].ForwardedTo.EMail);
		if(QueryStepIdData[x].RestrictViewToOthers == true && QueryStepIdData[x].ForwardedBy.EMail == _spPageContextInfo.userEmail || QueryStepIdData[x].RestrictViewToOthers == false)
		{
			Forward2Design = Forward2Design +	"<li>"+ForDesign+
													"<div class='forward_to row'>"+
														"<div class='col-md-8'>"+
															"<div class='flexitem'>"+
																"<div class='imgsetion'>"+
																	"<img src='"+ForwardUser+"'>"+
																"</div>"+
																"<div class='imagecontent'>"+
																	"<h4>"+QueryStepIdData[x].ForwardedTo.Title+"</h4>"+
																	"<a href='#'>"+QueryStepIdData[x].ForwardedTo.EMail+"</a>"+
																"</div>"+
															"</div>"+
														"</div>"+
														"<div class='col-md-4'>"+
															"<div class='remarkboxsec'>"+
																"<span "+WaitingFeedBack+">"+
																	"<label for=''>Feedback</label>"+
																	"<label for=''>:</label>"+
																"</span>"+
																"<p style='margin-left: 3px; font-weight: 800;'>"+FeedBack+"</p>"+
															"</div>"+
															"<div class='date_gmt_time'"+WaitingFeedBack+">"+
																"<div class='date_secbx'>"+
																	"<span class='frwd_date'>"+ActionDate+" </span>"+
																	"<span class='frwd_time'>"+Event_time+"</span>"+
																"</div>"+
															"</div>"+
														"</div>"+
														"<div class='col-md-11 wraping_only' "+WaitingFeedBack+">"+
															"<div class='remarkboxsec'>"+
																"<span><label>Remark</label><label>:</label></span>"+
																"<p>"+FeedBackRemark+"</p>"+
															"</div>"+
														"</div>"+
													"</div>"+                    							
                  								"</li>";
    	}
	
	}
	$(".forwardlist_child").empty().append(Forward2Design);
	


}


</script>


<script type="text/javascript">
	$(function(){
		$('.preload_img').click(function(){
			$('.preup_load').toggleClass('ative_now');
		});
	 	$('button[data-toggle="tooltip"]').tooltip(); 
	});

</script>		

<script type="text/javascript">
  
$(function(){
	$('.radio_grouping input[type="radio"]').click(function(){
   		var storecheck = $('.radio_grouping input[type="radio"]:checked').attr('data-target');
   		$('.boxhere').not("."+storecheck).removeClass('active_show');
   		$("."+storecheck).addClass('active_show');
	})
})


$(document).ready(function(){
	initializePeoplePicker("ForwardUserPicker1", 'Single'); 
	
	$("#ReturnStakeholderList_TopSpan").keyup(function () {
    	ValidateExistingApprovers('ReturnStakeholderList_TopSpan','ReturnStakeholderList','ListReturnForwardUser')
    });
    
    $("#ReturnStakeholderList_TopSpan_AutoFillDiv").click(function () {
    	ValidateExistingApprovers('ReturnStakeholderList_TopSpan','ReturnStakeholderList','ListReturnForwardUser')
    });
    
    $("#ForwardUserPicker1_TopSpan").keyup(function () {
        onChangeTask('ForwardUserPicker1_TopSpan','ForwardUserPicker1','UsersListForward')
    });
  	
  	$("#ForwardUserPicker1_TopSpan_AutoFillDiv").click(function () {
    	onChangeTask('ForwardUserPicker1_TopSpan','ForwardUserPicker1','UsersListForward')
    	
    });

  		//SetFeedBackdata	ReturnStakeholderList_TopSpan_AutoFillDiv_MenuList
  	$('#SetFeedBackdata').click(function(){
		//$('.preup_load').toggleClass('ative_now');
		SetFeedbackRecord();
	});
	
	$('#newRequestModalClose').click(function(){
		if(TemplateLoaded == true)
		{
			$('#newRequestModal').modal('hide');
		}
		else
		{
			window.location.replace("approvals.aspx");
		}
	}); 

});


var AskingApproverStatus = false;
function AskingNextApprovers()
{
	AskingApproverStatus = false;
	var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalTemplateSteps')/items?$select=*,AttachmentFiles&$expand=AttachmentFiles&$filter=TemplateID eq '"+$("input[name='selector']:checked").attr('templateid')+"' and ApproverDecidingStep eq 'Initiation' and AskApprover eq '1'&$orderby=Sequence_No asc";
	var QueryResult = RequestGetdata(Query);
	$("#ListNextApproversPPL").empty();
	
	if(QueryResult.length>0)
	{	
		AskingApproverStatus = true;			
		for(var k=0; k<QueryResult.length; k++)
		{	
			var NextAppDesign='';
				NextAppDesign = NextAppDesign	+	"<div class='form-group custom-form-group mb10'>"+
    		           									"<label>Stakeholder for "+QueryResult[k].StepName+" : <strong><span class='color-red'>*</span></strong></label>"+
    	               									"<div class='AskApprovers' id='AskApprover"+QueryResult[k].ID+"'></div>"+
    	           									"</div>";
    		$("#ListNextApproversPPL").append(NextAppDesign);
    	    initializeAskPeoplePicker("AskApprover"+QueryResult[k].ID);				
		}			
	}

}


function initializeAskPeoplePicker(peoplePickerElementId) 
{
	var schema = {};
	schema['PrincipalAccountType'] = 'User,DL,SecGroup,SPGroup';
	schema['SearchPrincipalSource'] = 15;
	schema['ResolvePrincipalSource'] =15;
	schema['AllowMultipleValues'] = true;
	schema['MaximumEntitySuggestions'] =50;
	schema['Width'] = '280px';
	this.SPClientPeoplePicker_InitStandaloneControlWrapper(peoplePickerElementId,
	null, schema);
}


function SetNextApprovers()
{
	//$('#overlaysearch').show();
	var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalTemplateSteps')/items?$select=*,AttachmentFiles&$expand=AttachmentFiles&$filter=TemplateID eq '"+$("input[name='selector']:checked").attr('templateid')+"' and ApproverDecidingStep eq 'Initiation' and AskApprover eq '1'&$orderby=Sequence_No asc";
	var QueryResult = RequestGetdata(Query);
	if(QueryResult.length>0)
	{
		var ExStatus = false;
		for(var k=0; k<QueryResult.length; k++)
		{
			var StakeHolder = EnsureUserMulti($('#AskApprover'+QueryResult[k].ID).children().children().attr('id'));
			
			if(StakeHolder.length == 0)
			{
				alert("Please enter "+QueryResult[k].StepName +" approvers.");
				ExStatus = false;
				break;
			}
			else
			{
				ExStatus = true;
				var EnsureActive = EnsureUserValidate($('#AskApprover'+QueryResult[k].ID).children().children().attr('id'));
				if(EnsureActive.length>0)
				{
					for(var k=0; k<EnsureActive.length; k++)
					{
						var QueryResultCheckActive=[];
						if(EnsureActive[k].Type == 'Tenant')
						{
							var QueryCheckActive =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Employees')/items?$select=*&$filter=LogonName/EMail eq '"+EnsureActive[k].Email+"' and Status eq 'Active'";
								QueryResultCheckActive = RequestGetdata(QueryCheckActive);
						}
						else
						{
							var QueryCheckActive =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ExternalUsers')/items?$select=*&$filter=LoginName/EMail eq '"+EnsureActive[k].Email+"' and Status eq 'Active'";
								QueryResultCheckActive = RequestGetdata(QueryCheckActive);
						}
							
						if(QueryResultCheckActive.length>0)
						{
							ExStatus = true;
							if(StakeHolder.length>0)
							{    
								objIndex = SavedStpApprovers.findIndex((obj => obj.StName == QueryResult[k].StepName));
								SavedStpApprovers[objIndex].StUser = StakeHolder;
								SavedStpApprovers[objIndex].UsrID = StakeHolder;							
							}
						}
						else
						{
							ExStatus = false;
							alert(EnsureActive[k].Name+ " is not a valid user");
							return false;
							break;
						}															
					}						
				}
			}					
		}
		//setTimeout(function () {
		if(ExStatus == true)
		{
			saverecord();
		}
		//$('#overlaysearch').hide()
		//}, 100);					
		
	}
}


function AskingNextQueeApprovers(MName)
{
	var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,Approvers/Title,Approvers/EMail,ActionTakenby/Title,ActionTakenby/EMail,Author/Title,Author/EMail,AttachmentFiles&$expand=Approvers,ActionTakenby,Author,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"' and Status eq 'Pending'&$orderby=Sequence_No asc";
	var QueryResult = RequestGetdata(Query);
	$("#ListPPL"+MName).empty();
	if(QueryResult.length>0)
	{
		if(QueryResult[0].AskApprover == true)
		{
			var QueryGetsteps =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,Approvers/Title,Approvers/EMail,ActionTakenby/Title,ActionTakenby/EMail,Author/Title,Author/EMail,AttachmentFiles&$expand=Approvers,ActionTakenby,Author,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"' and ApproverDecidingStep eq '"+window.atob(titanForWork.getQueryStringParameter('StepNo'))+"'&$orderby=Sequence_No asc";
			QueryResultGetsteps = RequestGetdata(QueryGetsteps);
			if(QueryResultGetsteps.length>0)
			{				
				for(var k=0; k<QueryResultGetsteps.length; k++)
				{	
					var NextAppDesign='';
						NextAppDesign = NextAppDesign	+	"<div class='form-group custom-form-group mb10'>"+
	    	                   									"<label>Stakeholder for "+QueryResultGetsteps[k].StepName+" :<strong><span class='color-red'> *</span></strong></label>"+
	    	                   									"<div class='AskApprovers' id='Ask"+MName+QueryResultGetsteps[k].ID+"'></div>"+
	    	               									"</div>";
	    			$("#ListPPL"+MName).append(NextAppDesign);
	    	        initializeAskPeoplePicker("Ask"+MName+QueryResultGetsteps[k].ID);				
				}			
			}
		}
	}
}


function SetUpNextAskQueeApprovers()
{
	var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,Approvers/Title,Approvers/EMail,ActionTakenby/Title,ActionTakenby/EMail,Author/Title,Author/EMail,AttachmentFiles&$expand=Approvers,ActionTakenby,Author,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"' and Status eq 'Pending'&$orderby=Sequence_No asc";
	var QueryResult = RequestGetdata(Query);
	
	//AskNextApproversARR
	if(QueryResult.length>0)
	{
		for(var i=0; i<AskNextApproversARR.length; i++)
		{
			if(QueryResult[0].ID == AskNextApproversARR[i].StepId)
			{
				// UPDATE APPROVAL PROCESS LIST
				var listName="ApprovalProcessList";
				var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+listName+"')/items('"+QueryResult[0].ID+"')";
				var item='';
					item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ApproversId':{'results':AskNextApproversARR[i].StepApprovers}};							
				var ExStatus = UniversalUpdateApprovalProcess(listName,item,QueryResult[0].ID,SiteUrl);
	
				// UPDATE APPROVAL PROCESS QUEUE
				var listName="ApprovalProcessQueue";
				var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+listName+"')/items('"+AskNextApproversARR[i].StepId+"')";
				var item='';
					item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ApproversId':{'results':AskNextApproversARR[i].StepApprovers}};							
				var ExStatus = UniversalUpdateApprovalProcess(listName,item,AskNextApproversARR[i].StepId,SiteUrl);
			}
			else
			{
				var listName="ApprovalProcessQueue";
				var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+listName+"')/items('"+AskNextApproversARR[i].StepId+"')";
				var item='';
					item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ApproversId':{'results':AskNextApproversARR[i].StepApprovers}};				
								
				var ExStatus = UniversalUpdateApprovalProcess(listName,item,AskNextApproversARR[i].StepId,SiteUrl);
			}
		}
	}
	else
	{
	
	}
}



function EnsureUserValidate(ID) 
{
	var UserId =[];    
    var peoplePickerTopDivId = ID;
    var peoplePicker = 
    this.SPClientPeoplePicker.SPClientPeoplePickerDict[peoplePickerTopDivId];
    var users = peoplePicker.GetAllUserInfo();
    for(var i=0; i<users.length; i++)
    {
    	var arryuser = users[i];
    	if(arryuser) 
    	{
    		var payload = { 'logonName': arryuser.Key}; 
    		$.ajax({
    			url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/ensureuser",
    		    type: "POST",
    		    async:false,
    		    contentType: "application/json;odata=verbose",
    		    data: JSON.stringify(payload),
    		    headers: {
    		        "X-RequestDigest": $("#__REQUESTDIGEST").val(),
    		        "accept": "application/json;odata=verbose"
    		            },
        		success: function(data, status, xhr) 
        		{     
        	 		var Users = data.d.Id;
        	 		UserId.push({Type:users[i].ProviderName,Email:data.d.Email,Name:data.d.Title});				     	 		          
        		},
        		error: function(xhr, status, error) 
        		{  
        		
        		}
    		}); 
    	}    	   
    	else 
    	{
    	    UserId = 0;
    	}
    } 
   	return UserId;    
}


function GroupingTemplates(ActionValue)
{
	var input, filter, ul, li, a, i, txtValue;
		input = ActionValue;
	filter = input.toUpperCase();
	ul = document.getElementById("TemplatedBinding1");
	li = ul.getElementsByTagName('li');
	if(filter != '-ALL-')
	{  			
		for (i = 0; i < li.length; i++) 
		{
  			a = li[i].getElementsByTagName("span")[0];
  			txtValue = a.textContent || a.innerText;
  			if (txtValue.toUpperCase() == filter.toUpperCase()) 
  			{
    			li[i].style.display = "";
  			} 
  			else 
  			{
    			li[i].style.display = "none";
  			}
		}
	}
	else
	{
   		for (i = 0; i < li.length; i++) 
   		{
        	a = li[i].getElementsByTagName("span")[0];
        	txtValue = a.textContent || a.innerText;
        	if (txtValue.toUpperCase().indexOf(filter) == -1) 
        	{
           		li[i].style.display = "";
        	} 
        	else 
        	{
           		li[i].style.display = "none";
        	}
    	}  		
  	}
}

$(document).ready(function(){

 $('input[name="signatories_opt"]').on('click', function(){
  var valstore = $(this).val();
  if($(this).is(':checked')){
    $('.hideboxarea').not('.'+valstore).removeClass('active');
    $('.'+valstore).addClass('active');
    addDdpStps('ddpStps');
  }
});

$('.modal').on("hidden.bs.modal",function(e){
	if($('.modal:visible').length){
		$('body').addClass('modal-open');
	}
	});
// All select option script //

  $('#selectallopts').click(function(){
    if($(this).is(':checked')){
      $('.checkboxallopt').each(function(){
        $(".checkboxallopt").prop('checked', true);
      })
    }else{
          $('.checkboxallopt').each(function(){
              $(".checkboxallopt").prop('checked', false);
          })
      }
  });

// Signature in Footer opton //

  $('#single_selecopt').on('click', function(){
    if($(this).is(':checked')){
      $('.single_selecopt').slideDown(100);
      addDdpStps('');
    }
    else{
      $('.single_selecopt').slideUp(100);
    }
 })
 
 $('#watermark_slect').on('click', function(){
    if($(this).is(':checked')){
      $('.watermark_slect').slideDown(100);
      addDdpStps('');
    }
    else{
      $('.watermark_slect').slideUp(100);
    }

  })

});


var ApprovalDocs = [];var AllDocs = [];var editFile = '';
function SaveApprovalDocs(action){
	ApprovalDocs  = [];
	if(action == 'Edit'){
		$('#EditDoc').show();
		$('#savedoc').hide();
		/*var purpose = $('#DocPurpose').val();				
		var Remarks = $('#docRemarks').val();	
		var editedData = {'filename' : fileName, 'purpose':purpose, 'Remarks' : Remarks};
		items[items.indexOf(oldValue)] = newValue*/

		
	} else{
		$('#EditDoc').hide();
		$('#savedoc').show();
	var fileInput = jQuery('#ApprovalDoc');
	var fileCount = fileInput[0].files.length
	console.log(fileCount);	
	var filecountset = 0;var stp = '';var stpId = '';
//	$('#countingbx').val(fileCount);
	for (var i = 0; i < fileCount; i++) 
	{		
		var fileName = fileInput[0].files[i].name;
		var extn = getExtension(fileName);
		if(!returnExtension(extn)){
		filecountset++;
		console.log(i);	
		var purpose = $('#DocPurpose').val();				
		var Remarks = $('#docRemarks').val();
		var AttachFor = $('#e_Signature_optis').val();
		var SignOf  = 'All Signatories';
		var ddpmulstp = $('#ddpStps').val();
		var	singleslct = $("#single_selecopt").prop("checked") ? 1 : 0;				
		var SingleStpval = $('#singleStpddp').val();
		var watermrk = $("#watermark_slect").prop("checked") ? 1 : 0;				
		var watermrkval = $('#docWatermark').val();		
		if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Process Steps'){
			stp = window.atob(titanForWork.getQueryStringParameter('StepNo'));
			stpId = window.atob(titanForWork.getQueryStringParameter('StepID'))
		}else{
			stp = 'Initiation'
			stpId = 0;
		}
		ApprovalDocs.push({'filename' : fileName, 'purpose':purpose, 'Remarks' : Remarks, 'SignOf': SignOf, 'ddpmulstp': ddpmulstp, 'SingleStpval':SingleStpval, 'singleslct': singleslct, 'watermrk' : watermrk ,'watermrkval' : watermrkval, 'extn' : extn, 'attachfor' : AttachFor, 'Step': stp, 'StepID': stpId, 'File' : fileInput[0].files[i] })
		AllDocs.push({'filename' : fileName, 'purpose':purpose, 'Remarks' : Remarks, 'SignOf': SignOf, 'ddpmulstp': ddpmulstp, 'SingleStpval':SingleStpval, 'singleslct': singleslct, 'watermrk' : watermrk ,'watermrkval' : watermrkval, 'extn' : extn, 'attachfor' : AttachFor, 'Step': stp, 'StepID': stpId, 'File' : fileInput[0].files[i]})
		}else{
		alert(fileName + ' should not be uploaded. This file may be malicious.  Please select another file.');
		return false;
		}
	 }
	}
	var RemoveDuplicate = [];var newDocs=[];
	if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Process Steps'){
		var CurrStpeId = window.atob(titanForWork.getQueryStringParameter('StepID'));//newDocs=ApprovalDocs;
	}else{
		var CurrStpeId = '0';//newDocs=AllDocs;
	}
	//var CurrStpeId = window.atob(titanForWork.getQueryStringParameter('StepID'));
	$.each(AllDocs, function(key, value) {
        var exists = false;
        $.each(RemoveDuplicate, function(k, val2) {
          if(value.filename == val2.filename && val2.StepID == value.StepID){ exists = true }; 
        });
        if(exists == false && value.filename!= "") { RemoveDuplicate.push(value); }
     });	        
	console.log(AllDocs);
	var ApprovalFiles =ReinitializeArray(RemoveDuplicate);    
	BindApprovalDoc(ApprovalFiles , 'ApprovalDoc', action, stp);
	$('#ApprovalDoc').val('');
	$('#DocPurpose').val('');	$('#docRemarks').val('');			
}
var newApprovalDocs = [];
function BindApprovalDoc(ApprovalDoc, id, action, stp){
	newApprovalDocs =[];
	$('#tbdyAppDoc').empty();
	var count = $('.countingbx').text();
	$('.countingbx').text(ApprovalDoc.length);
	var ApprovalDochtml = '';
	for(i=0;i<ApprovalDoc.length;i++){	 	
	var Authorattachment = _spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' + escapeProperly(_spPageContextInfo.userEmail);
		ApprovalDochtml += '<tr id="Doc_'+i+'"><td><div class="titlewrp">';
		var extn = ApprovalDoc[i].extn.toUpperCase();
		if(extn == 'JPEG' || extn == 'GIF' || extn == 'PNG' || extn == 'JPG'){
		 	var path = 'https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/MyDocuments/DMS/assets/images/jpg.png';
		}else if(extn == 'DOC' || extn == 'DOCX'){
			var path = 'https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/MyDocuments/DMS/assets/images/docx.png';
		}else if(extn == 'CSV' || extn == 'XLS' || extn == 'XLSX'){
			var path = 'https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/ProcessApproval/assets/images/excel_file.png';
		}else if(extn == 'PDF'){
			var path = 'https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/MyDocuments/DMS/assets/images/pdf.png';
		}else{
			var path = 'https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/MyDocuments/DMS/assets/images/file-icon.png';
		}
	    ApprovalDochtml += '<img src="'+path+'">'
	    //ApprovalDochtml += '<a href="javascript:void(0);" download="'+ApprovalDoc[i].filename+'" onclick="downloadAttach(\'' + ApprovalDoc[i].filename + '\', \'' + ApprovalDoc[i].filename + '\')" class="" style="color:#1d6ec0; display:block; ">
	    ApprovalDochtml += '<p class="fileName" id="DocName" >'+ApprovalDoc[i].filename+'</p>';
	    if(stp == ApprovalDoc[i].Step){	   
	    ApprovalDochtml += '<span class="fa fa-close fa-lg closeBtn" style="color:red;" onclick="RemoveDoc(this.id,\''+ApprovalDoc[i].filename + '\')" id="Doc_'+i+'" title="remove"></span>';  //</a>
	    }
	    ApprovalDochtml += '</div></td>'
	    ApprovalDochtml += '<td><p class="purpose_text" id="filePurpose">'+ApprovalDoc[i].purpose+'</p></td>'
	    ApprovalDochtml += '<td><p class="remarkmultilines" id="fileRemarks">'+ApprovalDoc[i].Remarks+'</p></td>'
	    ApprovalDochtml += '<td><div class="flexitem"><div class="imgsetion"><div class="empoyeeimg" style="float:left;"><img title="'+_spPageContextInfo.userDisplayName+'" src="'+Authorattachment+'" alt="" data-themekey="#"></div></div><div class="imagecontent"><h4>'+_spPageContextInfo.userDisplayName+'</h4><a href="#" style="cursor: auto;">'+_spPageContextInfo.userEmail+'</a></div></div></td>'
	    ApprovalDochtml += '<td>'+ApprovalDoc[i].Step+'<br>'+moment(new Date).format('LL')+'</td>'
	    if(stp == ApprovalDoc[i].Step){	
	    	newApprovalDocs.push(ApprovalDoc[i])   
		    ApprovalDochtml += '<td><button type="button" class="custom-edit-btn"><i class="fa fa-pencil" id="file_'+i+'" data-toggle="modal" data-target="#Approval_doc" onclick="EditAttachment(this.id, \''+ApprovalDoc[i].filename+'\',\''+ApprovalDoc[i].purpose+'\',\''+ApprovalDoc[i].Remarks+'\',\''+action+'\', \''+id+'\')"></i></button>'
		    ApprovalDochtml += '<button type="button" class="custom-edit-btn"><i class="fa fa-trash-o" id="Doc_'+i+'" onclick="RemoveDoc(this.id,\''+ApprovalDoc[i].filename + '\')"></i></button></td>'	    
	    }else{
	    	ApprovalDochtml += '<td></td>';
	    	ApprovalDochtml += '<td></td>';
	    }
	    ApprovalDochtml += '</tr>';
    }
    $('#tbdyAppDoc').append(ApprovalDochtml);
    $('#Approval_doc').modal('hide');

}

function ApprovalDocsUpload(ProcessId, docss, checkCol){
	var dfd = $.Deferred();
	var DocType = '';
	var col = '';
	for(i=0;i< docss.length;i++){
		var itemProperties = {};
		itemProperties['Title'] =  "Document Approval"
		itemProperties['RequestIDId'] =  ProcessId;
		itemProperties['ColumnName'] =  docss[i].col;
		itemProperties['Purpose'] = docss[i].purpose;
		itemProperties['Remarks'] = docss[i].Remarks;
		if(docss[i].attachfor == 'required_e_signature'){		 
			DocType = 'Approved Document' 
		}else if(docss[i].attachfor == 'supporting_document'){
			DocType = 'Supporting Document';
		}else{
			DocType = 'Column Document';
			col = docss[i].col;
		}
		itemProperties['DocumentType'] = DocType;
		itemProperties['SignatureOf'] = docss[i].SignOf
		if(docss[i].SignOf == "Selective Steps"){	itemProperties['SelectiveStepsId'] = 734; }
		itemProperties['SignInFooter'] = docss[i].singleslct ? true : false ;
		if(docss[i].singleslct == 1){		itemProperties['FooterSignById'] = docss[i].singleslct ? parseInt(docss[i].SingleStpval) : '';}
		itemProperties['Watermark'] = docss[i].watermrk ? true : false ;
		itemProperties['WatermarkText'] = docss[i].watermrk == 1? docss[i].watermrkval : '';
		if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Process Steps'){
			stp = window.atob(titanForWork.getQueryStringParameter('StepNo'));//ApprovalDoc[i].Step;
			itemProperties['Status'] = 'Pending';
		}else{	stp = 'Initiation';itemProperties['Status'] = '';}		
		itemProperties['Step'] = stp ;
		var CurrstpId = docss[i].StepID ? docss[i].StepID.toString() : '0';
		itemProperties['StepQueueID'] = CurrstpId; //docss[i].StepID.toString();
		var itemType = "SP.Data.ApprovalProcessDocumentsListItem";	
		itemProperties["__metadata"] = { "type": itemType };
		$.ajax({
			url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('ApprovalProcessDocuments')/items",
			type: "POST",
			async: false,
			headers: {
				"accept": "application/json;odata=verbose",
				"X-RequestDigest": $("#__REQUESTDIGEST").val(),
				"IF-MATCH": "*",						
				"content-Type": "application/json;odata=verbose"
			},
			data: JSON.stringify(itemProperties),
				/*where Title is column name and you can add more columns by splitting with ,*/
			success: function (data){ 
				if(col == '')	{
				var fileInput = jQuery('#ApprovalDoc');
				var varId = 'ApprovalDoc';
				}else{
				var fileInput = jQuery('#' + col);
				var varId = col //checkCol;
				}
				var fileCount = fileInput[0].files.length
				console.log(fileCount);
			//	if(fileCount > 0){
			//	for (var i=0; i < fileCount; i++) 	{				
					var fileName = docss[i].filename; //fileInput[0].files[i].name;
					//filecountset++;
					console.log(i);					
					if(fileName != null){					
						getFileBuffer(i,varId, docss[i])
						.done(function (arrayBuffer, index) {
							console.log("Success " + index);
							uploadFileSP("ApprovalProcessDocuments", data.d.Id, arrayBuffer, index, varId, fileName);
						})
						.fail(function (error) {
							console.log(error);
							LogError("uploadFile", error);
							alert("Error while uploading file for ID" + id);
						}); 
					}
		//	 }
		//		}
		
			},
			error: function (error) 
			{
				alert(JSON.stringify(error));
			}
		});
	}
	return dfd.promise();

}
</script>


<!-----approval document setting---->
<script type="text/javascript">

function AdvanceQueeGenerateProcess(MetaData,NewlyCreatedItemId)
{
	var ExeStatus = false;
	if(ActiveBtnStatus == 'Reject')
	{
		var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalStepsConditions')/items?$select=*,StepId/Title,StepId/StepName,AttachmentFiles&$expand=StepId,AttachmentFiles&$filter=TemplateID eq '"+$("input[name='selector']:checked").attr('templateid') +"' and (TriggerOn eq 'On Reject') and (Action eq 'Next Step' or Action eq 'Complete')";
		var QueryResult = RequestGetdata(Query);	
	}
	else
	{
		var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalStepsConditions')/items?$select=*,StepId/Title,StepId/StepName,AttachmentFiles&$expand=StepId,AttachmentFiles&$filter=TemplateID eq '"+$("input[name='selector']:checked").attr('templateid') +"' and (TriggerOn eq 'Approval or Submit' or TriggerOn eq null) and (Action eq 'Next Step' or Action eq 'Complete')";
		var QueryResult = RequestGetdata(Query);
	}
	
	if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Initiation')
    {
    	var FilteredRec = $.grep(QueryResult, function(v) {
			return v.StepType == 'Initiation'
		});
		
		var ConditionRes=[];
		var q=0;
		if(FilteredRec.length>0)
		{
			for(q=0; q<FilteredRec.length; q++)
			{
				if(FilteredRec[0].ConditionApplied == false)
				{
					ConditionRes = ConditionRes.concat(FilteredRec);
				}
				else
				{
					var Query1 =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessList')/items?$select=*,AttachmentFiles&$expand=AttachmentFiles&$filter="+FilteredRec[q].ConditionScripts+" and ID eq '"+NewlyCreatedItemId+"'";
					var QueryResult1 = RequestGetdata(Query1);
					if(QueryResult1.length>0)
					{											
						ConditionRes = ConditionRes.concat(FilteredRec[q]);											
					}
				}									
			}
		
			if(ConditionRes.length>0)
			{			
				for(var x=0; x<QueryResult.length; x++)
				{
					var NextNo = ConditionRes[ConditionRes.length-1].NextStepId;
					if(NextNo != null)
					{
						var FilteredRec = $.grep(QueryResult, function(v) {
							return v.StepIdId == NextNo
						});
						if(FilteredRec.length>0)
						{
							if(FilteredRec[0].ConditionApplied == true)
							{
								break;
							}
							else
							{
								ConditionRes = ConditionRes.concat(FilteredRec);
								QueryResult = QueryResult.filter(function( obj ) {
  									return obj.Id !== FilteredRec[0].Id;
								});
							}
						}
					}
				}		
			}
			
			var PermissionExe = true; 
			if(ConditionRes.length>0)
			{
				if(ConditionRes[0].StepType != 'Initiation')
				{
					var Query = "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,RequestID/ID,AttachmentFiles&$expand=RequestID/ID,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"' and StepID eq '"+ConditionRes[0].StepIdId+"' and Status eq 'Not Started'&$orderby=Sequence_No asc";
					var QueeQueryResult = RequestData(Query);
					if(QueeQueryResult.length>0)
					{
						PermissionExe = false;
					}
				}
			}

			var TempSavedStpApprovers = SavedStpApprovers;
			if(PermissionExe == true)
			{
				SavedStpApprovers=[];
				for(var y=0; y<ConditionRes.length; y++)
				{
					var FilteredRec1 = $.grep(TempSavedStpApprovers, function(v) {
						return v.Id == ConditionRes[y].NextStepId;
					});
					SavedStpApprovers = SavedStpApprovers.concat(FilteredRec1);				
				}		
				
				$.when(SaveApproverQueue(NewlyCreatedItemId)).then(function (ProcessListResult) {							      					   																 								
					console.log('Queues created');
				});										
			}
			else
			{
				alert("Conflict Conditions.")
			}									    							
		}
		else
		{
			alert("Conflict Conditions. Contact Process Administration.")
		}
	}
	else if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Process Steps')
	{
		var FilteredRec = $.grep(QueryResult, function(v) {
			return v.StepType == 'Process Steps' && v.StepId.StepName == window.atob(titanForWork.getQueryStringParameter('StepNo'))
		});
		
		var ConditionRes=[];
		if(FilteredRec.length == 1)
		{
			if(FilteredRec[0].Action != 'Complete')
			{				
				if(FilteredRec.length>0)
				{	
					if( ActiveBtnStatus != 'Reject')
					{			
						for(var x=0; x<QueryResult.length; x++)
						{
							var NextNo = '';
							if(ConditionRes.length>0)
							{
								NextNo = ConditionRes[ConditionRes.length-1].NextStepId;
							}
							else
							{
								NextNo = FilteredRec[0].NextStepId;
							}
							if(NextNo != null)
							{
								var FilteredRec = $.grep(QueryResult, function(v) {
									return v.StepIdId == NextNo
								});
								if(FilteredRec.length>0)
								{
									if(FilteredRec[0].ConditionApplied == true)
									{
										break;
									}
									else
									{
										ConditionRes = ConditionRes.concat(FilteredRec);
										QueryResult = QueryResult.filter(function( obj ) {
  											return obj.Id !== FilteredRec[0].Id;
										});
									}
								}
							}
						}
					}
					else if(ActiveBtnStatus == 'Reject')
					{
						ConditionRes = ConditionRes.concat(FilteredRec);
						
						if(FilteredRec.length>0)
						{
							var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalStepsConditions')/items?$select=*,StepId/Title,StepId/StepName,AttachmentFiles&$expand=StepId,AttachmentFiles&$filter=TemplateID eq '"+$("input[name='selector']:checked").attr('templateid') +"' and (TriggerOn eq 'Approval or Submit' or TriggerOn eq null) and (Action eq 'Next Step' or Action eq 'Complete')";
							var QueryResult = RequestGetdata(Query);

							for(var x=0; x<QueryResult.length; x++)
							{
								var NextNo = '';
								if(ConditionRes.length>0)
								{
									NextNo = ConditionRes[ConditionRes.length-1].NextStepId;
								}
								else
								{
									NextNo = FilteredRec[0].NextStepId;
								}
								if(NextNo != null)
								{
									var FilteredRec = $.grep(QueryResult, function(v) {
										return v.StepIdId == NextNo
									});
									if(FilteredRec.length>0)
									{
										if(FilteredRec[0].ConditionApplied == true)
										{
											break;
										}
										else
										{
											ConditionRes = ConditionRes.concat(FilteredRec);
											QueryResult = QueryResult.filter(function( obj ) {
  												return obj.Id !== FilteredRec[0].Id;
											});
										}
									}
								}
							}
						}
						
						var Query = "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,RequestID/ID,AttachmentFiles&$expand=RequestID/ID,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"' and ID gt '"+window.atob(titanForWork.getQueryStringParameter('StepID'))+"'&$orderby=Sequence_No asc";
						var Result4CancleSteps = RequestData(Query);
						if(Result4CancleSteps.length>0)
						{
							for(var e=0; e<Result4CancleSteps.length; e++)
							{
								var listName="ApprovalProcessQueue";
								var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+listName+"')/items('"+Result4CancleSteps[e].ID+"')";
								var item='';
									item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'Status':'Cancelled','ActionTakenbyId':_spPageContextInfo.userId};						
									var ExStatus = UpdateApprovalProcessSequence(listName,item,Result4CancleSteps[e].ID,SiteUrl);								
							}				
						}						
					}		
				}
				
				var PermissionExe = true; 
				if(ConditionRes.length>0)
				{
					var Query = "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,RequestID/ID,AttachmentFiles&$expand=RequestID/ID,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"' and StepID eq '"+ConditionRes[0].StepIdId+"' and Status eq 'Not Started'&$orderby=Sequence_No asc";
					var QueeQueryResult = RequestData(Query);
					if(QueeQueryResult.length>0)
					{
						PermissionExe = false;
					}
				
				}
				else
				{
					PermissionExe = false;
				}
				
				

				
				var TempSavedStpApprovers = SavedStpApprovers;
				if(PermissionExe == true)
				{
					if(ConditionRes.length > 0)
					{	
						SavedStpApprovers=[];
						for(var y=0; y<ConditionRes.length; y++)
						{
							if(ConditionRes[y].StepType != 'Initiation')
							{
								if(ActiveBtnStatus != 'Reject')
								{
									var FilteredRec1 = $.grep(TempSavedStpApprovers, function(v) {
										return v.Id == ConditionRes[y].StepIdId;
									});
								}
								else if(ActiveBtnStatus == 'Reject')
								{
									var FilteredRec1 = $.grep(TempSavedStpApprovers, function(v) {
										return v.Id == ConditionRes[y].NextStepId;
									});							
								}
								SavedStpApprovers = SavedStpApprovers.concat(FilteredRec1);				
							}			
						}		
						
						var Query = "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,RequestID/ID,AttachmentFiles&$expand=RequestID/ID,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"'&$orderby=Sequence_No asc";
						var QueeQueryResult = RequestData(Query);
						
						var QueeNo = QueeQueryResult[QueeQueryResult.length-1].Sequence_No;
						QueeNo = parseInt(QueeNo)+1;
					
					
						$.when(SaveApproverQueue(window.atob(titanForWork.getQueryStringParameter('RecNo')),'SPLCase',QueeNo)).then(function (ProcessListResult) {							      					   																 								
							console.log('Queues created');
						});														
					}	
				}
								
				/*	if(PermissionExe == true)
					{
						var Query = "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,RequestID/ID,AttachmentFiles&$expand=RequestID/ID,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"'&$orderby=Sequence_No asc";
						var QueeQueryResult = RequestData(Query);
						
						var QueeNo = QueeQueryResult[QueeQueryResult.length-1].Sequence_No;
							QueeNo = parseInt(QueeNo)+1;
							
						SavedStpApprovers=[];
						SavedStpApprovers = SavedStpApprovers.concat(FilteredRec1);
						
						$.when(SaveApproverQueue(window.atob(titanForWork.getQueryStringParameter('RecNo')),'SPLCase',QueeNo)).then(function (ProcessListResult) {							      					   																 								
							console.log('Queues created');
						});
					}
				*/
			}
			ExeStatus = true;			
		}
		else if(FilteredRec.length > 1)
		{
			UpdatingDataAdvcase(MetaData,NewlyCreatedItemId,FilteredRec);
			//updateData(MetaData,NewlyCreatedItemId,FilteredRec);
			
			ExeStatus = false;
			
		}
		else
		{
			ExeStatus = true;
		}		
	}
	return ExeStatus;
}



var UpdatingDataAdvcase = function (data,Id,ConditionData) 
{
	Id = parseInt(Id);			
	var dfd = $.Deferred()
	$.ajax({
		url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('ApprovalProcessList')/items("+Id+")",
		type: "PATCH",
		async: false,
		headers: {
			"accept": "application/json;odata=verbose",
			"X-RequestDigest": $("#__REQUESTDIGEST").val(),
			"X-Http-Method": "PATCH",
			"If-Match": "*",
			"content-Type": "application/json;odata=verbose"
		},
		data: JSON.stringify(data),
		/*where Title is column name and you can add more columns by splitting with ,*/
		success: function (data) 
		{		
			var DataChange = ModifyProcessListDataSPLCase(ConditionData,Id);			
			ModifyProcessQueue();
			
			if ($('#attachmentsupload').val() == "" && $('#supporting_doc_files').val() == "") 
			{
				//var NewlyCreatedItemId = data.d.ID;					
				UpdateTableData();
				if(ischeck ==  false && ischeckk ==  false)
				{
					if(SavedStpApprovers.length > 0)
					{
						if(AskNextApproversARR.length>0)
						{
							SetUpNextAskQueeApprovers();
						}							
						console.log(SavedStpApprovers);							
					 	console.log('Updated');
					 	$('#overlaysearch').hide();
					 	//alert('The approval request has been updated successfully.');
					 	alert('Data has been updated successfully.');
					 	window.location.replace("approvals.aspx");
					}
				}
			}
			if ($('#attachmentsupload').val() == "" && $('#supporting_doc_files').val() == "")
			return;	
			Passingtoken = window.atob(titanForWork.getQueryStringParameter('Step'));
			var id = '';
			if(Passingtoken == 'Initiation') {
				var fileInput = jQuery('#attachmentsupload');
				id = 'attachmentsupload';
			}else{
				var fileInput = jQuery('#supporting_doc_files');
				id = 'supporting_doc_files';
			}
			
			if(fileInput.prop('files') != undefined)
			{
				var fileCount = fileInput[0].files.length;
				console.log(fileCount);
				var filecountset = 0;
				for (var i = 0; i < fileCount; i++) 
				{
					filecountset++;
					console.log(i);
					getFileBuffer(i,id)
					.done(function (arrayBuffer, index) {
						console.log("Success " + index);
						//uploadFileInList(arrayBuffer, id, index);
						uploadFileSP("ApprovalProcessQueue", StepId, arrayBuffer, index, id);
					})
					.fail(function (error) {
							console.log(error);
						LogError("uploadFile", error);
						alert("Error while uploading file for ID" + id);
						$('#overlaysearch').hide();
					});
					if (fileCount == filecountset) 
					{
						alert("Details are saved successfully.");
						$('#overlaysearch').hide();
						window.location.replace("approvals.aspx"); //location.reload();
					}
				}
			}
		},	
		error: function (error) 
		{
			alert(JSON.stringify(error));
		}
	});
}


function ModifyProcessListDataSPLCase(ConditionData,Id)
{
	if(ConditionData.length>0)
	{	
		if(ActiveBtnStatus == 'Reject')
		{
			var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalStepsConditions')/items?$select=*,StepId/Title,StepId/StepName,AttachmentFiles&$expand=StepId,AttachmentFiles&$filter=TemplateID eq '"+$("input[name='selector']:checked").attr('templateid') +"' and (TriggerOn eq 'On Reject') and (Action eq 'Next Step' or Action eq 'Complete')";
			var QueryResult = RequestGetdata(Query);	
		}
		else
		{
			var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalStepsConditions')/items?$select=*,StepId/Title,StepId/StepName,AttachmentFiles&$expand=StepId,AttachmentFiles&$filter=TemplateID eq '"+$("input[name='selector']:checked").attr('templateid') +"' and (TriggerOn eq 'Approval or Submit' or TriggerOn eq null) and (Action eq 'Next Step' or Action eq 'Complete')";
			var QueryResult = RequestGetdata(Query);
		}
		
		var ConditionRes=[];
		var q=0;
		for(q=0; q<ConditionData.length; q++)
		{
			var Query1 =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessList')/items?$select=*,AttachmentFiles&$expand=AttachmentFiles&$filter="+ConditionData[q].ConditionScripts+" and ID eq '"+Id+"'";
			var QueryResult1 = RequestGetdata(Query1);
			if(QueryResult1.length>0)
			{											
				ConditionRes = ConditionRes.concat(ConditionData[q]);											
			}									
		}
		
		if(ConditionRes.length>0)
		{	
			
		
			for(var x=0; x<QueryResult.length; x++)
			{
				var NextNo = ConditionRes[ConditionRes.length-1].NextStepId;
				if(NextNo != null)
				{
					var FilteredRec = $.grep(QueryResult, function(v) {
						return v.StepIdId == NextNo
					});
					if(FilteredRec.length>0)
					{
						if(FilteredRec[0].ConditionApplied == true)
						{
							break;
						}
						else
						{
							ConditionRes = ConditionRes.concat(FilteredRec);
							QueryResult = QueryResult.filter(function( obj ) {
  								return obj.Id !== FilteredRec[0].Id;
							});
						}
					}
				}
			}		
		}
		
		var TempSavedStpApprovers = SavedStpApprovers;
		if(ConditionRes.length > 0)
		{	
			SavedStpApprovers=[];
			//var FilteredRec1 = $.grep(SavedStpApprovers, function(v) {
			//	return v.Id == ConditionRes[0].NextStepId;
			//});
			for(var y=0; y<ConditionRes.length; y++)
			{
				if(ConditionRes[y].StepType != 'Initiation')
				{
					var FilteredRec1 = $.grep(TempSavedStpApprovers, function(v) {
						return v.Id == ConditionRes[y].NextStepId;
					});
					SavedStpApprovers = SavedStpApprovers.concat(FilteredRec1);				
				}			
			}		
		
			//SavedStpApprovers=[];
			//SavedStpApprovers = SavedStpApprovers.concat(FilteredRec1);
				
			var Query = "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,RequestID/ID,AttachmentFiles&$expand=RequestID/ID,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"'&$orderby=Sequence_No asc";
			var QueeQueryResult = RequestData(Query);
				
			var QueeNo = QueeQueryResult[QueeQueryResult.length-1].Sequence_No;
				QueeNo = parseInt(QueeNo)+1;
	
			
			$.when(SaveApproverQueue(window.atob(titanForWork.getQueryStringParameter('RecNo')),'SPLCase',QueeNo)).then(function (ProcessListResult) {							      					   																 								
				console.log('Queues created');
			});														
		}
	}
			
	var Query = "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,RequestID/ID,AttachmentFiles&$expand=RequestID/ID,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"' and Status ne 'Cancelled' &$orderby=Sequence_No asc";
	var QueryResult = RequestData(Query);
	
	var SeqArray=[];
	var FilteredRec2 = $.grep(QueryResult, function(v) {
		return v.StepName == window.atob(titanForWork.getQueryStringParameter('StepNo')) && v.Status == 'Pending'
	}); 

	if(FilteredRec2[0].AttachmentFiles.results.length>0)
	{
		ExistingSignedImage = FilteredRec2[0].AttachmentFiles.results[0].FileName;
	}

	if(FilteredRec2.length>0)
	{
		ActiveQueeNo = FilteredRec2[0].ID;
		var StepNo = FilteredRec2[0].Sequence_No; //window.atob(titanForWork.getQueryStringParameter('StepNo'));			
	}
	
	var StepId = FilteredRec2[0].Id; 
	var SeqIndex = '';
	for(var i=0; i<QueryResult.length; i++)
	{
		SeqArray.push(QueryResult[i].Sequence_No);								
	}
	SeqIndex = SeqArray.indexOf(StepNo);
	
	if(SeqArray.length>SeqIndex+1)
	{
		let index = [SeqIndex+1];
		let indexArr = index.map(i => SeqArray[i]);
		var NewIndexValue = indexArr.toString();
		var FilteredRec = $.grep(QueryResult, function(v) {
			return v.Sequence_No == NewIndexValue;
		});
		NextActiveQueeNo = FilteredRec[0].ID;
		console.log(FilteredRec);
	}
	
	var data = {};	
	data.CurrentStepID = NextActiveQueeNo.toString();
	var Item = '';
		Item = {'__metadata': { type: 'SP.Data.ApprovalProcessListListItem'},'CurrentStepID':NextActiveQueeNo.toString()};				

	if(NextActiveQueeNo == '')
	{
		if(ActiveBtnStatus == 'Submit' || ActiveBtnStatus == 'ApprovedSign' || ActiveBtnStatus == 'Reviewed' || ActiveBtnStatus == 'Edit Data')
		{
			data.CurrentStep = 'Final',
			data.ApprovedById = _spPageContextInfo.userId,
			data.ActionRequired = 'Final',
			data.Status = 'Approved'
			Item = {'__metadata': { type: 'SP.Data.ApprovalProcessListListItem'},'CurrentStepID':NextActiveQueeNo.toString(),'CurrentStep':'Final','ApprovedById':_spPageContextInfo.userId,'ActionRequired':'Final','Status':'Approved'};
		}
		else if(ActiveBtnStatus == 'Reject')
		{
			data.ActionRequired = 'Rejected',
			data.Status = 'Rejected',
			data.ApprovedById = _spPageContextInfo.userId
			Item = {'__metadata': { type: 'SP.Data.ApprovalProcessListListItem'},'CurrentStepID':NextActiveQueeNo.toString(),'ApprovedById':_spPageContextInfo.userId,'ActionRequired':'Rejected','Status':'Rejected'};			
		}
	}
	else
	{
		if(ActiveBtnStatus == 'Submit' || ActiveBtnStatus == 'ApprovedSign' || ActiveBtnStatus == 'Reviewed' || ActiveBtnStatus == 'Edit Data')
		{					
			Item = {'__metadata': { type: 'SP.Data.ApprovalProcessListListItem'},'CurrentStepID':NextActiveQueeNo.toString(),'CurrentStep':FilteredRec[0].StepName,'ActionRequired':FilteredRec[0].ActionRequired,'ApproversId':{'results': FilteredRec[0].ApproversId.results}};						
		}
		else if(ActiveBtnStatus == 'Reject')
		{	
			if(ActiveBtnStatus == 'Reject')
			{
				var Query1 =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalStepsConditions')/items?$select=*,StepId/Title,StepId/StepName,AttachmentFiles&$expand=StepId,AttachmentFiles&$filter=TemplateID eq '"+$("input[name='selector']:checked").attr('templateid') +"' and (TriggerOn eq 'On Reject') and (Action eq 'Next Step' or Action eq 'Complete')";
				var QueryResult = RequestGetdata(Query1);	
			}
			var FilteredReg = []
			if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Process Steps')
			{	
				FilteredReg = $.grep(QueryResult, function(v) {
					return v.StepType == 'Process Steps' && v.StepId.StepName == window.atob(titanForWork.getQueryStringParameter('StepNo'))
				});
			}
			if(FilteredReg.length>0)
			{
				Item = {'__metadata': { type: 'SP.Data.ApprovalProcessListListItem'},'CurrentStepID':NextActiveQueeNo.toString(),'CurrentStep':FilteredRec[0].StepName,'ActionRequired':FilteredRec[0].ActionRequired,'ApproversId':{'results': FilteredRec[0].ApproversId.results}};						
			}
			else
			{				
				Item = {'__metadata': { type: 'SP.Data.ApprovalProcessListListItem'},'CurrentStepID':NextActiveQueeNo.toString(),'CurrentStep':FilteredRec[0].StepName,'Status':'Rejected','ActionRequired':'Rejected','ApprovedById':_spPageContextInfo.userId};						
			}
		}
	}
	var listName="ApprovalProcessList";	//Action.name.split(',')[4]
	var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+listName+"')/items('"+Id+"')";
	var ExStatus = UniversalUpdateApprovalProcess(listName,Item,Id,SiteUrl); //listName,item,dataid,SiteUrl
	
	return ExStatus;
}


function ModifyProcessQueue()
{
	var ActiveSingTypeRadio='';
	var listName="ApprovalProcessQueue";
	var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+listName+"')/items('"+ActiveQueeNo+"')";
	var item='';
				
	if(ActiveBtnStatus == 'Submit')
	{					
		item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ActionTakenbyId':_spPageContextInfo.userId,'Status':'Reviewed'};				
	}
	else if(ActiveBtnStatus == 'Reject')
	{
		item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ActionTakenbyId':_spPageContextInfo.userId,'Status':'Rejected','Remarks':$("#RejectApproveRemark").val()};
	}
	else if(ActiveBtnStatus == 'Reviewed')
	{
		item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ActionTakenbyId':_spPageContextInfo.userId,'Status':'Reviewed','Remarks':$("#ReviewedApproveRemark").val()};
	}
	else if(ActiveBtnStatus == 'Edit Data')
	{
		item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ActionTakenbyId':_spPageContextInfo.userId,'Status':'Approved','Remarks':$("#EditDataApproveRemark").val()};
	}				
	else if(ActiveBtnStatus  == 'ApprovedSign')
	{
		ActiveSingTypeRadio = $('input[name="SignTypeRadio"]:checked').val();
		var listName="ApprovalProcessQueue";
		if(ActiveSingTypeRadio == 'SignText')
		{
			item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ActionTakenbyId':_spPageContextInfo.userId,'Status':'Approved','SignType':'SignText','DrawSign':$("#SingTextType").val(),'Remarks':$("#RemarksApprovalContent").val(),'IPAddress':ActiveSystemIP};
		}
		else if(ActiveSingTypeRadio == 'SignImage')
		{
			targetItemId = ActiveQueeNo;
			item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ActionTakenbyId':_spPageContextInfo.userId,'Status':'Approved','SignType':'SignImage','Remarks':$("#RemarksApprovalContent").val(),'IPAddress':ActiveSystemIP,'DrawSign':''};						
		}
		else if(ActiveSingTypeRadio == 'SignDraw')
		{
			var DrawSingValue = $sigdiv.jSignature('getData', "default");
			item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'ActionTakenbyId':_spPageContextInfo.userId,'Status':'Approved','SignType':'SignDraw','DrawSign':DrawSingValue,'Remarks':$("#RemarksApprovalContent").val(),'IPAddress':ActiveSystemIP};
		} 
	}
		
	var ExStatus = UniversalUpdateApprovalProcess(listName,item,ActiveQueeNo,SiteUrl);
	//if(ExStatus == true && ActiveSingTypeRadio == 'SignImage')
	if(ExStatus == true)
	{
		if(SignImage.length>0)
		{
			uploadattachment(ActiveQueeNo);
		}
		/*if(SelectedSignImages != '')
		{
			CopySignatureFile();
		}
		else
		{
			uploadattachment(ActiveQueeNo);
		}*/
	}
			
	var SiteUrl = _spPageContextInfo.webAbsoluteUrl+ "/_api/web/lists/GetByTitle('"+listName+"')/items('"+NextActiveQueeNo+"')";
	if(NextActiveQueeNo != '')
	{
		var item='';					
		item={'__metadata': { type: 'SP.Data.ApprovalProcessQueueListItem'},'Status':'Pending'};
		if(ActiveBtnStatus == 'Reject')
		{				
			//var ExStatus = UniversalUpdateApprovalProcess(listName,item,NextActiveQueeNo ,SiteUrl);				
		}
		else
		{
			var ExStatus = UniversalUpdateApprovalProcess(listName,item,NextActiveQueeNo ,SiteUrl);
		}
	}
}


function GetHistoryDtl()
{
	$("#AllHistory").empty();
	var Query =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessQueue')/items?$select=*,Approvers/Title,Approvers/EMail,ActionTakenby/Title,ActionTakenby/EMail,Author/Title,Author/EMail,AttachmentFiles&$expand=Approvers,ActionTakenby,Author,AttachmentFiles&$filter=RequestID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"'&$orderby=Sequence_No asc";
	var QueryResult = getdata(Query);
	
	var HistoryDesign='';
	var ApproversListID=[];
	if(QueryResult.length>0)
	{
		var QueryInitialized =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalProcessList')/items?$select=*,AttachmentFiles,TemplateID/Title,Approvers/Title,Approvers/EMail,Author/Title,Author/EMail&$expand=AttachmentFiles,TemplateID,Approvers,Author&$filter=ID eq '"+window.atob(titanForWork.getQueryStringParameter('RecNo'))+"'";
		var QueryResultInitialized = getdata(QueryInitialized);		
		if(QueryResultInitialized.length>0)
		{	
			var eventDateObj=new Date(QueryResultInitialized[0].Created);
			var ActionTime = eventDateObj.toTimeString();
			var H = +ActionTime.substr(0, 2);
			var h = (H % 12) || 12;
			var ampm = H < 12 ? " AM" : " PM";
				ActionTime= h + ActionTime.substr(2, 3) + ampm;

			var RequestByPhoto=_spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' +QueryResultInitialized[0].Author.EMail;
			HistoryDesign = HistoryDesign + "<li>"+
												"<span class='iconbox'>"+
													"<img src='https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/time-icon-1.png' alt=''>"+
    											"</span>"+
												"<div class='approvelheadeing'>"+
													"<h3 class='mainheading'>Approval Initiation</h3>"+
       												"<span  class='date-sec'>"+moment(QueryResultInitialized[0].Created).format('DD MMM YYYY')+" "+ActionTime+"</span>"+
    											"</div>"+
    											"<p class='waitsec initialize'>Initialized</p>"+
    											"<div class='row'>"+
    												"<div class='col-sm-6 flexitem'>"+
														"<div class='imgsetion'>"+
															"<img src='"+RequestByPhoto+"' alt=''>"+
            											"</div>"+
            											"<div class='imagecontent'>"+
															"<h4>"+QueryResultInitialized[0].Author.Title+"</h4>"+
															"<a href='#'>"+QueryResultInitialized[0].Author.EMail+"</a>"+
            											"</div>"+
        											"</div>"+
													"<div class='col-sm-6 flexitem'>"+
														"<div class='imagecontent'>"+
															"<h4>Purpose:</h4>"+
            	    										"<p class='Purposetext'>"+QueryResultInitialized[0].Title+"</p>"+
            											"</div>"+
        											"</div>"+
    											"</div>"+
   											"</li>";
		}
		
		for(var i=0; i<QueryResult.length; i++)
		{
			if(QueryResult[i].ActionTakenbyId != null)
			{
				var eventDateObj=new Date(QueryResult[i].Modified);
				var ActionTime = eventDateObj.toTimeString();
				var H = +ActionTime.substr(0, 2);
				var h = (H % 12) || 12;
				var ampm = H < 12 ? " AM" : " PM";
					ActionTime= h + ActionTime.substr(2, 3) + ampm;
				
				var ActionByPhoto=_spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' +QueryResult[i].ActionTakenby.EMail;				
				var StatusImg = '';
				if(QueryResult[i].Status== "Rejected"){StatusImg = "https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/rejected-img.png";}
				else if(QueryResult[i].Status== "Initiated" || QueryResult[i].Status == 'Pending'){StatusImg ="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/initiated-img.png";}
				else if(QueryResult[i].Status== "Approved"){StatusImg ="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/approved-img.png";}
				else if(QueryResult[i].Status== "Reviewed"){StatusImg ="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/approved-img.png";}
				else if(QueryResult[i].Status== "Forwarded"){StatusImg ="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/forwarded-img.png";}
				else if(QueryResult[i].Status== "Cancelled"){StatusImg ="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/cancellation.png";}
				else if(QueryResult[i].Status== "Not Started"){StatusImg ="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/time-icon-2.png";}
				else if(QueryResult[i].Status== "Reverted"){StatusImg ="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/Reverted.png";}
				
				var SignatureDesignHTML='';
				if(QueryResult[i].SignType == 'SignText')//SignDraw
    			{
    				SignatureDesignHTML = "<span id='SignatureText' class='signature-front'>"+QueryResult[i].DrawSign+"</span>";
				}
				else if(QueryResult[i].SignType == 'SignDraw')
				{
					SignatureDesignHTML = "<img class='process-approve-signature-img' src='"+QueryResult[i].DrawSign+"' alt='signature'>";                                  	        							
				}
				else if(QueryResult[i].SignType == 'SignImage')
				{
					var SignUrl='';
					if(QueryResult[i].AttachmentFiles.results.length>0)
					{
						SignUrl = QueryResult[i].AttachmentFiles.results[0].ServerRelativeUrl;
					}    						
					SignatureDesignHTML = "<img class='process-approve-signature-img' src='"+SignUrl+"' alt='signature'>";                                   	        							
				}
				 					
				var Statusrev = '';	
				var ColorCode = "style='color:#4e9a06'";			
				if(QueryResult[i].Status == 'Rejected')
				{
					Statusrev = 'Rejected';
					ColorCode = "style='color:red'";
				}
				else if(QueryResult[i].Status == 'Cancelled')
				{
					Statusrev = 'Cancelled';
					ColorCode = "style='color:red'";
				}
				else
				{
					if(QueryResult[i].ActionRequired == 'Edit Data'){ Statusrev = 'Edit and  Approved'}
					else if(QueryResult[i].ActionRequired == 'Edit & Sign'){Statusrev = 'Edit and  Approved'}
					else if(QueryResult[i].ActionRequired == 'Review Only'){Statusrev = "Reviewed"}
					else if(QueryResult[i].ActionRequired == 'Review & Sign'){Statusrev = "Reviewed and Approved"}
					else if(QueryResult[i].ActionRequired == 'Edit Only'){Statusrev = "Re-Submitted"}				
				}
				
				if(QueryResult[i].SignType == 'SignText' && QueryResult[i].DrawSign == null)
				{
					SignatureDesignHTML = '';
				}
				var UploadDoc='';
				
				if(QueryResult[i].ActionRequired != 'Review & Sign')
				{
					if(QueryResult[i].AttachmentFiles.results.length>0)
					{
						if(QueryResult[i].SignType != 'SignImage')
						{
							UploadDoc = "<div class='upload-chip'>"+
			                      			"<span class='pr-8 chip-text-box' style='color:#333; cursor:pointer;' title=''>"+QueryResult[i].AttachmentFiles.results[0].FileName+"</span>"+
			                      			"<span class='chip-icon-box'>"+
			                        			"<a href='"+QueryResult[i].AttachmentFiles.results[0].ServerRelativeUrl+"' download='' style='color:#333;'><i class='fa fa-download cursor-pointer' aria-hidden='true'></i></a>"+
			                      			"</span>"+
			                    		"</div>";
			            }
					}	 
				}			
				
				var RemarksText='';
				var RemarksDisplay='display: none';
				if(QueryResult[i].Remarks != null)
				{
					RemarksText = QueryResult[i].Remarks;
					RemarksDisplay = "";
				}
														
				HistoryDesign = HistoryDesign + "<li>"+
    												"<span class='iconbox'>"+
        												"<img src='"+StatusImg+"'>"+
    												"</span>"+
													"<div class='approvelheadeing'>"+
        												"<h3 class='mainheading'>"+QueryResult[i].StepName+"</h3>"+
        												"<span  class='date-sec'>"+moment(QueryResult[i].Modified).format('DD MMM YYYY')+" "+ActionTime+"</span>"+
    												"</div>"+    												
    												"<p class='waitsec completed' "+ColorCode+">"+Statusrev+"</p>"+
    												"<div class='row'>"+
        												"<div class='col-sm-6 flexitem'>"+
            												"<div class='imgsetion'>"+
                												"<img src='"+ActionByPhoto+"'>"+
            												"</div>"+
            												"<div class='imagecontent'>"+
                												"<h4>"+QueryResult[i].ActionTakenby.Title+"</h4>"+
                												"<a href='#'>"+QueryResult[i].ActionTakenby.EMail+"</a>"+
            												"</div>"+
        												"</div>"+
														"<div class='col-sm-6 flexitem'>"+
            												"<div class='signbox'>"+
																"<div class='m-0'>"+
																	"<span class='pr-8 chip-text-box' style='color:#333; cursor:pointer;' title=''></span>"+
																	"<span class='chip-icon-box'>"+SignatureDesignHTML+"</span>"+UploadDoc+
																	
                												"</div>"+                											
            											"</div>"+
        											"</div>"+
    												//"</div>"+
    												"<div style='margin-top:10px;'>"+
														"<div class='remak_text' style='"+RemarksDisplay+"'>"+
															"<label style='font-weight: 600;'>Remarks:</label>"+
															"<span class='remarkbox'>"+RemarksText+"</span>"+
														"</div>"+
													"</div>"+
												"</li>";
			}
			else
			{
				var Statusrev = '';
				var ColorCode = "style='color:#4e9a06'";			
				if(QueryResult[i].Status == 'Rejected')
				{
					Statusrev = 'Rejected';
					ColorCode = "style='color:red'";
				}
				else if(QueryResult[i].Status == 'Cancelled')
				{
					Statusrev = 'Cancelled';
					ColorCode = "style='color:red'";
				}				
				else
				{
					if(QueryResult[i].ActionRequired == 'Edit Data'){ Statusrev = 'Edit and  Approved'}
					else if(QueryResult[i].ActionRequired == 'Edit & Sign'){Statusrev = 'Edit and  Approved'}
					else if(QueryResult[i].ActionRequired == 'Review Only'){Statusrev = "Reviewed"}
					else if(QueryResult[i].ActionRequired == 'Review & Sign'){Statusrev = "Reviewed and Approved"}
					else if(QueryResult[i].ActionRequired == 'Edit Only'){Statusrev = "Re-Submitted"}				
				}
				
				var StatusImg = '';
				if(QueryResult[i].Status== "Rejected"){StatusImg = "https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/rejected-img.png";}
				else if(QueryResult[i].Status== "Initiated" || QueryResult[i].Status == 'Pending'){StatusImg ="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/initiated-img.png";}
				else if(QueryResult[i].Status== "Approved"){StatusImg ="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/approved-img.png";}
				else if(QueryResult[i].Status== "Reviewed"){StatusImg ="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/approved-img.png";}
				else if(QueryResult[i].Status== "Forwarded"){StatusImg ="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/forwarded-img.png";}
				else if(QueryResult[i].Status== "Cancelled"){StatusImg ="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/cancellation.png";}
				else if(QueryResult[i].Status== "Not Started"){StatusImg ="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/time-icon-2.png";}
				else if(QueryResult[i].Status== "Reverted"){StatusImg ="https://cdn.jsdelivr.net/gh/Titan4workGit/TitanRepo@latest/SiteAssets/Approvals/assets/images/Reverted.png";}

				if(QueryResult[i].ApproverType == 'Specific')
				{
					ApproversListID.push(QueryResult[i].ID);
					HistoryDesign = HistoryDesign +	"<li style='background:#f4f3f3;'>"+
            											"<span class='iconbox'>"+
              												"<img src='"+StatusImg+"'>"+
            											"</span>"+
														"<div class='approvelheadeing'>"+
              												"<h3 class='mainheading'>"+QueryResult[i].StepName+"</h3>"+
            											"</div>"+
              											"<span class='waitsec' style='color:#000'></span>"+
                 											//"<span class='signbx_area' style='margin-left: 15px;'>"+QueryResult[i].ApproverRole+"</span>"+
              											"<div class='row no-gutter' style='margin-top: 10px;' id='ApproverList"+QueryResult[i].ID+"'>"+
                  											"<div class='col-sm-6 col-md-4 flexitem wrap_textbox'>"+
                    											"<div class='imgsetion'>"+
                      												"<img src='img/user-circle.png'>"+
                    											"</div>"+
                    											"<div class='imagecontent'>"+
                      												"<h4>swapnil Katriaya</h4>"+
                      												"<a>swampilAdaptIndia.com</a>"+
                    											"</div>"+
                  											"</div>"+
                  											"<div class='col-sm-6 col-md-4 flexitem wrap_textbox'>"+
                    											"<div class='imgsetion'>"+
                      												"<img src='img/user-circle.png'>"+
                    											"</div>"+
                    											"<div class='imagecontent'>"+
                      												"<h4>Lakan kumar sharma</h4>"+
                      												"<a>lakahanAdaptIndia.com</a>"+
                    											"</div>"+
                  											"</div>"+
                  										"</div>"+ 
													"</li>";
					
				}
				else if(QueryResult[i].ApproverType == 'Role Based')
				{
					ApproversListID.push(QueryResult[i].ID);
					HistoryDesign = HistoryDesign +	"<li style='background:#f4f3f3;'>"+
            											"<span class='iconbox'>"+
              												"<img src='"+StatusImg+"'>"+
            											"</span>"+
														"<div class='approvelheadeing'>"+
              												"<h3 class='mainheading'>"+QueryResult[i].StepName+"</h3>"+
            											"</div>"+
              											"<span class='waitsec' style='color:#000'>"+Statusrev+"</span>"+
                 										"<span class='signbx_area' style='margin-left: 15px;'>"+QueryResult[i].ApproverRole+"</span>"+
              											"<div class='row no-gutter' style='margin-top: 10px;' id='ApproverList"+QueryResult[i].ID+"'>"+
                  											"<div class='col-sm-6 col-md-4 flexitem wrap_textbox'>"+
                    											"<div class='imgsetion'>"+
                      												"<img src='img/user-circle.png'>"+
                    											"</div>"+
                    											"<div class='imagecontent'>"+
                      												"<h4>swapnil Katriaya</h4>"+
                      												"<a>swampilAdaptIndia.com</a>"+
                    											"</div>"+
                  											"</div>"+
                  											"<div class='col-sm-6 col-md-4 flexitem wrap_textbox'>"+
                    											"<div class='imgsetion'>"+
                      												"<img src='img/user-circle.png'>"+
                    											"</div>"+
                    											"<div class='imagecontent'>"+
                      												"<h4>Lakan kumar sharma</h4>"+
                      												"<a>lakahanAdaptIndia.com</a>"+
                    											"</div>"+
                  											"</div>"+
                  										"</div>"+ 
													"</li>";					
				}
				else if(QueryResult[i].ApproverType == 'Field')
				{
					ApproversListID.push(QueryResult[i].ID);
					var Query4Field =  _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ApprovalTemplateSetup')/items?$select=*&$filter=TemplateID eq '"+QueryResult[i].TemplateIDId+"'and ColumnName eq '"+QueryResult[i].ColumnName+"'";
					var QueryResult4Field = getdata(Query4Field);
					var ColumnTitle='';
					if(QueryResult4Field.length>0)
					{
						ColumnTitle = QueryResult4Field[0].Title;
					}

					HistoryDesign = HistoryDesign + "<li style='background:#f4f3f3;'>"+
                										"<span class='iconbox'>"+
                  											"<img src='"+StatusImg+"'>"+
                										"</span>"+
                										"<div class='approvelheadeing'>"+  
                  											"<h3 class='mainheading'>"+QueryResult[i].StepName+"</h3>"+
                										"</div>"+
                										"<p class=''>"+Statusrev+"</p>"+
                										"<div class='column_values'>"+
                  											"<label for=''>Column Value: </label>"+
                  											"<span class='column_naming'> "+ColumnTitle+"</span>"+
                										"</div>"+ 
            										"</li>";
				}
				else if(QueryResult[i].ApproverType == 'Group')
				{
					ApproversListID.push(QueryResult[i].ID);
					HistoryDesign = HistoryDesign +	"<li style='background:#f4f3f3 !important;'>"+
            											"<span class='iconbox'>"+
              												"<img src='"+StatusImg+"'>"+
            											"</span>"+
            											"<div class='approvelheadeing'>"+
              												"<h3 class='mainheading'>"+QueryResult[i].StepName+"</h3>"+
            											"</div>"+
              											"<span class='waitsec' style='color:#000'>"+Statusrev+"</span>"+
              											"<div class='row no-gutter' style='margin-top: 10px;' id='ApproverList"+QueryResult[i].ID+"'>"+
                  											"<div class='col-sm-6 col-md-4 flexitem wrap_textbox'>"+
                    											"<div class='imgsetion'>"+
                      												"<img src='img/user-circle.png'>"+
                    											"</div>"+
                    											"<div class='imagecontent'>"+
                      												"<h4>swapnil Katriaya</h4>"+
                      												"<a>swampilAdaptIndia.com</a>"+
                    											"</div>"+
                  											"</div>"+    
              											"</div>"+
													"</li>";
				}
			}			
		}	
	}	
	$("#AllHistory").empty().append(HistoryDesign);
	
	if(ApproversListID.length>0)
	{
		for(var T=0; T<ApproversListID.length; T++)
		{
			var FilteredRec = $.grep(QueryResult, function(v) {
    				return v.ID == ApproversListID[T];
			});
			if(FilteredRec.length>0 && FilteredRec[0].Approvers.__deferred == undefined )//ColumnValue.__deferred == undefined
			{
				var ApproversDesignList='';
				for(var a=0; a<FilteredRec[0].Approvers.results.length; a++)
				{
					var ActionByPhoto=_spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?accountname=' +FilteredRec[0].Approvers.results[a].EMail;
					ApproversDesignList= ApproversDesignList+	"<div class='col-sm-6 col-md-4 flexitem wrap_textbox'>"+
                    												"<div class='imgsetion'>"+
                    													"<img src='"+ActionByPhoto+"'>"+
                    												"</div>"+
                    												"<div class='imagecontent'>"+
                    													"<h4>"+FilteredRec[0].Approvers.results[a].Title+"</h4>"+
                    													"<a>"+FilteredRec[0].Approvers.results[a].EMail+"</a>"+
                    												"</div>"+
                  												"</div>";												
				}
				$('#ApproverList'+FilteredRec[0].ID).empty().append(ApproversDesignList);	
			}					
		}
	}
}


function getdata(Query)
{
    var ResultItems=[];
    var Ownurl =Query;// _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('ContactCenter')/items?"+Query+"";  
    $.ajax({  
        url: Ownurl,  
        headers: { Accept: "application/json;odata=verbose" },  
        async:false,  
        success: function (data) 
        { 			
            ResultItems = data.d.results;  
        },
        error: function (data) 
        {  
            console.log("Error in getdata.");
        	console.log(data); 
        }  
    });
    return ResultItems;
}

</script>

<script type="text/javascript">
  
$(function(){
	$('.action_signaturebx.required_e_signature').hide();
  	$('#e_Signature_optis').on('change', function(){
    	var mathclass = $(this).val();
    	$('.action_signaturebx').not('.'+mathclass).hide();
    	$('.'+mathclass).show();
  	});
})


// Save data as draft

function saverecordDraft() 
{
	var requiredfileds = [];
	var nonrequiredfileds =[];
	var datacreate = "";
	var intarr = $("input[name='selector']:checked").attr('templateid');
	var nu = parseInt(intarr);
	var requestforstring = $("input[name='selector']:checked").attr('requestfor'); 
	var requestTile = $('#titleid').text();
	var itemProperties = {};
		itemProperties['RequestFor'] = requestforstring;
		itemProperties['Title'] = requestTile;
		itemProperties['TemplateIDId'] = nu;
	ischeckk = false;
	itemProperties['Status'] = 'Draft';
	var fileData =[];
	$("#appenddyamicboxes > .dynamicdatatexboxes.active").each(function () {
	var key = $(this).find(".columnnametxt.active").attr("value");
	//itemProperties[key] = $(this).find(".dynamicvalfeachcls").val();
	var vval = '';
	if(key  == 'ColumnPeople1' || key  == 'ColumnPeople2' || key  == 'ColumnPeople3' || key  == 'ColumnPeople4'|| key  == 'ColumnPeople5'){
		var EntityUsers= [];
		var peoplePickerDiv = $("[id$='"+key+"_TopSpan']"); 
		var peoplePicker = SPClientPeoplePicker.SPClientPeoplePickerDict[peoplePickerDiv[0].id]; 
		var users = peoplePicker.GetAllUserInfo()				
		for (var j = 0; j < users.length; j++) 
		{	var flag=false;
		/*	var arrUSer = AllTaskUsersEmployeeuser.filter(function (filterData) {
				if(filterData.EMail == users[j].EntityData.Email){flag=true;}
				return filterData.EMail == users[j].EntityData.Email;
	   		});	*/
	   		var QueryCheckActive = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Employees')/items?$select=LogonName/Id,LogonName/Title,Email&$expand=LogonName&$filter=Email eq '"+users[j].EntityData.Email+"' and Status eq 'Active'";
			var arrUSer = RequestGetdata(QueryCheckActive);
			if(arrUSer[0].Email == users[j].EntityData.Email){flag=true;}					
		if(!flag){alert("Selected user "+users[j].DisplayText+" not in list"); return false;}			    
	    	EntityUsers.push(arrUSer[0].LogonName.Id)	    
		}
		vval = EntityUsers;
	}else if(key  == 'Checkbox1' || key  == 'Checkbox2' || key  == 'Checkbox3' || key  == 'Checkbox4'|| key  == 'Checkbox5'){
	 	vval = $(this).find(".combine_box_adds .dynamicvalfeachcls.active").prop('checked')
	}else{
		vval = $(this).find(".dynamicvalfeachcls.active").val()
	}
	if($(this).find(".dynamicvalfeachcls.active").attr('type') == 'file'){
		var lbl = $(this).find(".columnnametxt.active").attr("alerttext");
		var fileInput = jQuery('#'+key);
		fileData.push({'filename' : vval,'purpose': lbl,'Remarks' : '', 'SignOf': 'No Signature','col' : key, 'ddpmulstp': '', 'SingleStpval':'', 'singleslct': false, 'watermrk' : false ,'watermrkval' : '','File' : fileInput[0].files[0] }) ;
	//	ApprovalDocs.push({'filename' : fileName, 'purpose':purpose, 'Remarks' : Remarks, 'SignOf': SignOf, 'ddpmulstp': ddpmulstp, 'SingleStpval':SingleStpval, 'singleslct': singleslct, 'watermrk' : watermrk ,'watermrkval' : watermrkval})
	}
	if ($(this).find(".columnnametxt.active").attr("mandatorycol") != "true" && vval == "") 
	{
		var dyanmicvalhtml = $(this).find(".columnnametxt.active").attr('alerttext');
		nonrequiredfileds.push(dyanmicvalhtml);
	}		  
	else
	{
		if(key  == 'ColumnPeople1' || key  == 'ColumnPeople2' || key  == 'ColumnPeople3' || key  == 'ColumnPeople4'|| key  == 'ColumnPeople5'){
			var EntityUsers= [];				
			itemProperties[key+'Id'] = {"results": vval }; //vval = EntityUsers;
		}else{
			if($(this).find(".combine_box_adds .dynamicvalfeachcls.active").attr('type') == 'checkbox'){
				itemProperties[key]= vval; //$(this).find(".combine_box_adds .dynamicvalfeachcls.active").prop('checked')
			}
			//itemProperties[key] = $(this).find(".dynamicvalfeachcls.active").val();			
		/*	if(key == 'YesNo'){
				if($(this).find(".dynamicvalfeachcls.active").val() == "Yes")
				{
					itemProperties[key] = true;
				}
				else if($(this).find(".dynamicvalfeachcls.active").val() == "No")
				{
					itemProperties[key] = false;
				}
			}	*/
			else
			{
				var val = '';				
				val = $(this).find(".dynamicvalfeachcls.active").val();				
				if(val == '' || val == null)
				{
					itemProperties[key] = ''; //$(this).find(".dynamicvalfeachcls").val();
				}
				else
				{
					itemProperties[key] = val.toString();;
				}
			}
			}
			if ($(this).find(".columnnametxt.active").attr("mandatorycol") == "true" && (vval == "" || vval == undefined)) 
			{
				var dyanmicvalhtml = $(this).find(".columnnametxt.active").attr('alerttext');
				requiredfileds.push(dyanmicvalhtml);
			}
			if(arrNumVal.length>0)	{
							for(a=0;a<arrNumVal.length;a++){
							if($(this).find(".dynamicvalfeachcls.active").val() != ''){
								if(key == arrNumVal[a].col){
									if(arrNumVal[a].min != null &&  arrNumVal[a].max != null){																	
										if($(this).find(".dynamicvalfeachcls.active").val() >= arrNumVal[a].min && $(this).find(".dynamicvalfeachcls.active").val() <= arrNumVal[a].max){
											itemProperties[key] = $(this).find(".dynamicvalfeachcls.active").val();
										}
									/*	else{
											alert(arrNumVal[a].title+' should be between '+ arrNumVal[a].min +' to '+ arrNumVal[a].max);
											ischeckk =  true; return false;break;
										} */
									}else if(arrNumVal[a].min != null && arrNumVal[a].max == null ){
										if($(this).find(".dynamicvalfeachcls.active").val() >= arrNumVal[a].min){
											itemProperties[key] = $(this).find(".dynamicvalfeachcls.active").val();
										}
									/*	else{
											alert(arrNumVal[a].title+' should be greater than '+ arrNumVal[a].min );
											ischeckk =  true; return false;break;
										}	*/								
									}else if(arrNumVal[a].min == null && arrNumVal[a].max != null ){
										if($(this).find(".dynamicvalfeachcls.active").val() <= arrNumVal[a].max){
											itemProperties[key] = $(this).find(".dynamicvalfeachcls.active").val();
										}
										/*else{
											alert(arrNumVal[a].title+' should be less than  '+ arrNumVal[a].max );											
											ischeckk =  true; return false;break;
										}	*/								
									}else if(arrNumVal[a].min == null && arrNumVal[a].max == null ){
										itemProperties[key] = $(this).find(".dynamicvalfeachcls.active").val();
									}
									
								}
								}
							}						
						}
			}
			if(ischeckk){return false;alert(ischeckk);}		  
		})
		if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Initiation')
    	{
		$("#appenddyamicboxes > .dynamicdatatexboxes:not(.active)").each(function () {
			var key = $(this).find(".columnnametxt:not(.active)").attr("value");
			for(i=0;i<AutoFilledCols.length;i++){
				if(key  == 'ColumnPeople1' || key  == 'ColumnPeople2' || key  == 'ColumnPeople3' || key  == 'ColumnPeople4'|| key  == 'ColumnPeople5'){
					var EntityUsers= [];
					var peoplePickerDiv = $("[id$='"+key+"_TopSpan']"); 
					var peoplePicker = SPClientPeoplePicker.SPClientPeoplePickerDict[peoplePickerDiv[0].id]; 
					var users = peoplePicker.GetAllUserInfo()				
					for (var j = 0; j < users.length; j++) 
					{	var flag=false;
					/*	var arrUSer = AllTaskUsersEmployeeuser.filter(function (filterData) {
							if(filterData.EMail == users[j].EntityData.Email){flag=true;}
							return filterData.EMail == users[j].EntityData.Email;
				    	}); */
				    	var QueryCheckActive = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Employees')/items?$select=LogonName/Id,LogonName/Title,Email&$expand=LogonName&$filter=Email eq '"+users[j].EntityData.Email+"' and Status eq 'Active'";
						var arrUSer = RequestGetdata(QueryCheckActive);
						if(arrUSer[0].Email == users[j].EntityData.Email){flag=true;}					
					if(!flag){alert("Selected user "+users[j].DisplayText+" not in list"); return false;}			    
				    EntityUsers.push(arrUSer[0].LogonName.Id)	    
					}
					itemProperties[key+'Id'] = {"results": EntityUsers};
				}else{
					if(key  == 'Checkbox1' || key  == 'Checkbox2' || key  == 'Checkbox3' || key  == 'Checkbox4'|| key  == 'Checkbox5'){
					 	itemProperties[key] = $(this).find(".combine_box_adds .dynamicvalfeachcls").prop('checked')
					}else
					if(key == AutoFilledCols[i].ColName){
						itemProperties[key] = $(this).find(".dynamicvalfeachcls").val();
					}
				}
			}		
		})	}
		if(ischeckk){return false;alert(ischeckk);}	
		else{	
		var itemType = "SP.Data.ApprovalProcessListListItem";
		itemProperties["__metadata"] = { "type": itemType };
	/*	if (requiredfileds.length > 0) 
		{
			for (let i = 0; i < requiredfileds.length; i++) 
			{
				alert("Please enter the value for " + requiredfileds[i] + "");
				break;
			}					
		} 
		else 
		{	*/
			//validateTable();
			if(window.location.href.indexOf("?")> -1) 
    		{
    			if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Initiation')
    			{
					if(isValid){
					saveDraftdata(JSON.stringify(itemProperties),fileData);			    									
					}
				}
				else if(window.atob(titanForWork.getQueryStringParameter('Step')) == 'Draft' && window.atob(titanForWork.getQueryStringParameter('RecNo')) != null)
				{
					if(isValid){
					var RecId = window.atob(titanForWork.getQueryStringParameter('RecNo'));	    		
					updateDraftData(itemProperties, RecId, fileData);						
					}
				}	
			}
	//	}
		}
	}	

	var saveDraftdata = function (data,fileData) 
	{
		var dfd = $.Deferred()
		$.ajax({
			url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('ApprovalProcessList')/items",
			type: "POST",
			async: false,
			headers: {
				"accept": "application/json;odata=verbose",
				"X-RequestDigest": $("#__REQUESTDIGEST").val(),
				"IF-MATCH": "*",						
				"content-Type": "application/json;odata=verbose"
			},
			data: data,
				/*where Title is column name and you can add more columns by splitting with ,*/
			success: function (data) 
			{
		//		if ($('#attachmentsupload').val() == "") 
		//		{
					var NewlyCreatedItemId = data.d.ID;
					SubmitTbltcols(NewlyCreatedItemId );
					if(ApprovalDocs.length  > 0){
						ApprovalDocsUpload(NewlyCreatedItemId,AllDocs,'');
					}
					if(fileData.length > 0){					
					/*	var file = $('#' + fileData[0].col);
						var checkfile = CheckFileSize(file);
						if(checkfile){
						ApprovalDocsUpload(NewlyCreatedItemId,fileData,fileData[0].col);
						}*/
						ApprovalDocsUpload(NewlyCreatedItemId,fileData,'');
					}
					if(ischeck ==  false && ischeckk ==  false)
					{
					/*	if(SavedStpApprovers.length > 0)
						{
							$.when(SaveApproverQueue(NewlyCreatedItemId)).then(function (ProcessListResult) {							      					   																								
								console.log('Queues created');
							}); 
							//SaveApproverQueue(NewlyCreatedItemId);
							//SubmitTbltcols(NewlyCreatedItemId );
						}	
						else
						{	*/
							alert('The approval request has been saved as draft successfully.');
							window.location.replace("approvals.aspx");
					//	}
					}
		//		}
				if ($('#attachmentsupload').val() == "")
					return;						
			
			},
			error: function (error) 
			{
				alert(JSON.stringify(error));
			}
		});
	}
// update Draft request

var updateDraftData = function (data,Id,fileData) 
{
	Id = parseInt(Id);
		var dfd = $.Deferred()
		$.ajax({
			url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('ApprovalProcessList')/items("+Id+")",
			type: "PATCH",
			async: false,
			headers: {
				"accept": "application/json;odata=verbose",
				"X-RequestDigest": $("#__REQUESTDIGEST").val(),
				"X-Http-Method": "PATCH",
				"If-Match": "*",
				"content-Type": "application/json;odata=verbose"
			},
			data: JSON.stringify(data),
			/*where Title is column name and you can add more columns by splitting with ,*/
			success: function (data) 
			{
								
					var NewlyCreatedItemId = Id;					
					UpdateTableData();	
					if(ApprovalDocs.length > 0){
						ApprovalDocsUpload(NewlyCreatedItemId,ApprovalDocs,'');
					}
					if(fileData.length > 0){
					/*	var file = $('#' + fileData[0].col);
						var checkfile = CheckFileSize(file);
						if(checkfile){
						ApprovalDocsUpload(NewlyCreatedItemId,fileData,fileData[0].col);
						} */
						ApprovalDocsUpload(NewlyCreatedItemId,fileData,'');
					}			
					if(ischeck ==  false && ischeckk ==  false)
					{
				
						 	console.log('Updated');
						 	alert('The approval draft request has been updated successfully.');
						 	window.location.replace("approvals.aspx");
				
					}
			
				
			
			},
			error: function (error) 
			{
				alert(JSON.stringify(error));
			}
		});
}


// To Save cuurent template link

function SaveLink(){
	var dfd = $.Deferred();
	var tempId = $("input[name='selector']:checked").attr('templateid');
	var link = window.location.href + '&Template=' +window.btoa(tempId);
	console.log(link);//alert(link);	
	var itemProperties = {};
	itemProperties['Title'] =  "Process Approval"
	itemProperties['Category'] = "Link"; 
	itemProperties['UserId'] = _spPageContextInfo.userId;
	itemProperties['Link'] = link;
	var itemType = "SP.Data.MyFavoritesListItem";	
		itemProperties["__metadata"] = { "type": itemType };
		$.ajax({
			url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('MyFavorites')/items",
			type: "POST",
			async: false,
			headers: {
				"accept": "application/json;odata=verbose",
				"X-RequestDigest": $("#__REQUESTDIGEST").val(),
				"IF-MATCH": "*",						
				"content-Type": "application/json;odata=verbose"
			},
			data: JSON.stringify(itemProperties),
				/*where Title is column name and you can add more columns by splitting with ,*/
			success: function (data) 
			{	
				alert('Link saved as favourite..!');
			},
			error: function (error) 
			{
				alert(JSON.stringify(error));
			}
		});
	
	return dfd.promise();	
}


function GenerateForwardMailDesign()
{    
	MailCounter=0;
	var PageLink = _spPageContextInfo.webAbsoluteUrl +"/Pages/Approvals.aspx";
   	var from = _spPageContextInfo.userEmail;
   	
   	body = "<span><span>"+_spPageContextInfo.userDisplayName+" added you as a new stakeholder regarding the following approval.</span><br><br>"+
			"<span><strong>Process: </strong><span>Process Approval</span></span><br>"+
			"<span><strong>Request For: </strong><span>"+$("#titleid").text()+"</span></span><br>"+
			"<span><strong>Template: </strong><span>"+$("#templatenameid").text()+"</span></span><br>"+
			//"<span><strong>Priority: </strong><span>"+$("#PriorityText").text()+"</span></span><br>"+
			//"<span><strong>Due Date: </strong><span>"+$("#DuedateText").text()+"</span></span><br><br>"+
			"<span><strong>Notify by: </strong><span>"+_spPageContextInfo.userDisplayName+"</span></span><br>"+
			"<span><strong>Message: </strong><span>"+$("#ForwardStackholderRemarks").val()+"</span></span><br><br>"+
			"<span><a href='"+PageLink+"'>Click here</a> to open the Approval Dashboard.</span><br><br>"+
			//"<span><a href='"+_Link+"'>Click here</a> FileLink</span><br><br>"+
			"<span>This is an auto generated e-mail. Please do not reply.</span><br><br>";    
	
			
   	subject = 'Stakeholder Holder Notification.';
   	var UserEmail=[];
   	for(var i=0; i<NewAddedUser.length; i++)
   	{
   		//var UserDtls = fnGetUserProps(ApproversListNotify[i]);
   		//to = UserDtls.d.Email;
   		UserEmail.push(NewAddedUser[i].Email);
   	}    
   	sendEmail(from, UserEmail, body, subject);
}



function sendEmail(from, to, body, subject)
{
	try{
		var siteurl = _spPageContextInfo.webServerRelativeUrl;
    	var urlTemplate = siteurl + "/_api/SP.Utilities.Utility.SendEmail";
        $.ajax({  
    		contentType: 'application/json',  
    		url: urlTemplate,  
    		type: "POST",
    		async:false,  
    		data: JSON.stringify({  
        		'properties': {  
            		'__metadata': {  
                	'type': 'SP.Utilities.EmailProperties'  
            		},  
            		'From': from,  
            		'To': {  
                		'results': to  
            		},  
            		'Body': body,  
            		'Subject': subject,
            		  
        		}  
    	}),  
    	headers: {  
        	"Accept": "application/json;odata=verbose",  
        	"content-type": "application/json;odata=verbose",  
        	"X-RequestDigest": $("#__REQUESTDIGEST").val()  
    	},  
    	success: function(data) 
    	{  
    		alert('Stakeholders Action Completed.');
			$('#forward_stpings').modal('hide');
			window.location.href = titanForWork.getQueryStringParameter('sourcelocation');
		
    	},  
    	error: function(err) 
    	{  
        	alert('Error in sending Email: ' + JSON.stringify(err));  
    	}  
	});
	}
    catch (error) 
    { }
}




 
</script>
</body>
</html>